<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>计划评估</title>
    <link rel="stylesheet" href="../../shared/styles/styles.css">
    <link rel="stylesheet" href="../../shared/styles/styles_plan_view_2d.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* 计划评估模块专用样式 */
        .plan-evaluation-content {
            display: flex;
            width: 100%;
            height: 100vh;
            background: #1a1a1a;
            overflow: hidden;
        }

        .plan-evaluation-content .image-left-panel {
            width: 350px;
            min-width: 200px;
            max-width: 600px;
            background: #2a2a2a;
            border-right: 1px solid #2A2A2A;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: all 0.3s ease;
        }

        .plan-evaluation-content .image-left-panel.collapsed {
            width: 60px;
            min-width: 60px;
        }

        .plan-evaluation-content .image-left-panel .resizer-handle {
            position: absolute;
            right: 0;
            top: 0;
            width: 4px;
            height: 100%;
            cursor: col-resize;
            z-index: 10;
            background: transparent;
        }

        .plan-evaluation-content .image-left-panel .resizer-handle:hover {
            background: rgba(0, 122, 204, 0.3);
        }

        .plan-evaluation-content .image-left-panel .patient-info-header {
            display: flex;
            align-items: center;
            padding: 15px 10px;
            border-bottom: 1px solid #2A2A2A;
            background: #2a2a2a;
        }

        .plan-evaluation-content .image-left-panel .patient-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #3AACDE;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-size: 18px;
            margin-right: 10px;
        }

        .plan-evaluation-content .image-left-panel .patient-details {
            flex: 1;
            min-width: 0;
        }

        .plan-evaluation-content .image-left-panel .patient-name {
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .plan-evaluation-content .image-left-panel .patient-info {
            font-size: 12px;
            color: #ddd;
        }

        .plan-evaluation-content .image-left-panel .collapse-toggle {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #ddd;
            transition: all 0.3s;
        }

        .plan-evaluation-content .image-left-panel .collapse-toggle:hover {
            color: #ffffff;
            background: #404040;
            border-radius: 4px;
        }

        .plan-evaluation-content .image-left-panel.collapsed .patient-details {
            display: none;
        }

        .plan-evaluation-content .image-left-panel .content-area {
            flex: 1;
            display: flex;
            flex-direction: row;
            overflow: hidden;
        }

        .plan-evaluation-content .image-left-panel .vertical-nav-buttons {
            width: 60px;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
            border-right: 1px solid #2A2A2A;
            padding: 10px 0;
        }

        .plan-evaluation-content .image-left-panel .nav-btn {
            width: 100%;
            height: auto;
            padding: 15px 10px;
            background: none;
            border: none;
            color: #ddd;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            border-left: 3px solid transparent;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .plan-evaluation-content .image-left-panel .nav-btn:hover {
            background-color: #404040;
            color: #ffffff;
        }

        .plan-evaluation-content .image-left-panel .nav-btn.active {
            background-color: #3AACDE;
            color: #ffffff;
            border-left-color: #ffffff;
        }

        .plan-evaluation-content .image-left-panel .nav-btn i {
            font-size: 16px;
            margin-bottom: 4px;
        }

        .plan-evaluation-content .image-left-panel .nav-btn span {
            font-size: 10px;
            text-align: center;
            line-height: 1.2;
        }

        .plan-evaluation-content .image-left-panel .panel-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: #1a1a1a;
            min-width: 0;
        }

        .plan-evaluation-content .image-left-panel .panel-section {
            display: none;
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            height: 100%;
            flex-direction: column;
        }

        .plan-evaluation-content .image-left-panel .panel-section.active {
            display: flex;
            flex-direction: column;
        }

        /* ROBUST组件样式 */
        .robust-component {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: #1a1a1a;
        }

        .robust-search-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: #2a2a2a;
            border-bottom: 1px solid #2A2A2A;
        }

        .robust-search-input {
            flex: 1;
            padding: 6px 12px;
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 4px;
            color: #ffffff;
            font-size: 13px;
        }

        .robust-search-input:focus {
            outline: none;
            border-color: #3AACDE;
        }

        .robust-search-icon {
            color: #888888;
            font-size: 14px;
        }

        .robust-load-btn {
            padding: 6px 12px;
            background: #3AACDE;
            border: none;
            border-radius: 4px;
            color: #ffffff;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.3s;
        }

        .robust-load-btn:hover {
            background: #005a9e;
        }

        .robust-groups-container {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            gap: 8px;
            display: flex;
            flex-direction: column;
        }

        .robust-groups-container::-webkit-scrollbar {
            width: 6px;
        }

        .robust-groups-container::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .robust-groups-container::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 3px;
        }

        .robust-group-card {
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 4px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .robust-group-card:hover {
            background: #2A2A2A;
            border-color: #555555;
        }

        .robust-group-card.selected {
            border-color: #3AACDE;
            background: #1e3a5f;
        }

        .robust-group-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .robust-group-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .robust-group-field {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: #ddd;
        }

        .robust-field-label {
            min-width: 100px;
            color: #888888;
        }

        .robust-field-value {
            color: #ffffff;
        }

        .robust-group-actions {
            display: none;
            gap: 6px;
            align-items: center;
        }

        .robust-group-card.hovered .robust-group-actions,
        .robust-group-card.selected .robust-group-actions {
            display: flex;
        }

        .robust-action-btn {
            width: 28px;
            height: 28px;
            background: #404040;
            border: 1px solid #555555;
            border-radius: 4px;
            color: #ddd;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .robust-action-btn:hover {
            background: #3AACDE;
            border-color: #3AACDE;
            color: #ffffff;
        }

        .robust-empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #888888;
            font-size: 14px;
            gap: 12px;
        }

        .robust-empty-state i {
            font-size: 48px;
            color: #555555;
        }

        /* 模态框样式 */
        .robust-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
        }

        .robust-modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 8px;
            min-width: 400px;
            max-width: 600px;
            z-index: 10001;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .robust-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #404040;
        }

        .robust-modal-header h3 {
            margin: 0;
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
        }

        .robust-modal-close {
            background: transparent;
            border: none;
            color: #ddd;
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
            transition: color 0.3s;
        }

        .robust-modal-close:hover {
            color: #ffffff;
        }

        .robust-modal-body {
            padding: 20px;
        }

        .robust-form-group {
            margin-bottom: 16px;
        }

        .robust-form-group label {
            display: block;
            margin-bottom: 8px;
            color: #ddd;
            font-size: 13px;
        }

        .robust-form-input,
        .robust-form-select {
            width: 100%;
            padding: 8px 12px;
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 4px;
            color: #ffffff;
            font-size: 13px;
            box-sizing: border-box;
        }

        .robust-form-input:focus,
        .robust-form-select:focus {
            outline: none;
            border-color: #3AACDE;
        }

        .robust-form-input:disabled {
            background: #2a2a2a;
            color: #666666;
            cursor: not-allowed;
        }

        .robust-form-error {
            margin-top: 4px;
            color: #ff4444;
            font-size: 12px;
        }

        .robust-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 20px;
            border-top: 1px solid #404040;
        }

        .robust-btn {
            padding: 8px 20px;
            border: 1px solid #404040;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .robust-btn-cancel {
            background: #2a2a2a;
            color: #ddd;
        }

        .robust-btn-cancel:hover {
            background: #2A2A2A;
            color: #ffffff;
        }

        .robust-btn-confirm {
            background: #3AACDE;
            color: #ffffff;
            border-color: #3AACDE;
        }

        .robust-btn-confirm:hover {
            background: #005a9e;
            border-color: #005a9e;
        }

        .robust-btn-danger {
            background: #cc4444;
            color: #ffffff;
            border-color: #cc4444;
        }

        .robust-btn-danger:hover {
            background: #aa3333;
            border-color: #aa3333;
        }

        /* 加载模板弹窗样式 */
        .robust-load-template-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 8px;
            min-width: 900px;
            max-width: 1200px;
            width: 90%;
            max-height: 80vh;
            z-index: 10001;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }

        .robust-load-template-body {
            display: flex;
            flex: 1;
            overflow: hidden;
            gap: 12px;
            padding: 20px;
        }

        .robust-template-list-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 4px;
        }

        .robust-template-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .robust-template-table thead {
            background: #2a2a2a;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .robust-template-table th {
            padding: 10px 12px;
            text-align: left;
            color: #ffffff;
            font-weight: 600;
            border-bottom: 1px solid #404040;
        }

        .robust-template-table td {
            padding: 10px 12px;
            color: #ddd;
            border-bottom: 1px solid #2A2A2A;
        }

        .robust-template-table tbody tr:hover {
            background: #2a2a2a;
        }

        .robust-template-table tbody {
            display: block;
            max-height: 400px;
            overflow-y: auto;
        }

        .robust-template-table thead,
        .robust-template-table tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        .robust-template-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .robust-template-action-link {
            color: #3AACDE;
            text-decoration: none;
            margin-right: 12px;
            cursor: pointer;
        }

        .robust-template-action-link:hover {
            color: #005a9e;
            text-decoration: underline;
        }

        .robust-scenario-list-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 4px;
        }

        .robust-scenario-header {
            padding: 10px 12px;
            background: #2a2a2a;
            border-bottom: 1px solid #404040;
            color: #ffffff;
            font-weight: 600;
            font-size: 14px;
        }

        .robust-scenario-table-container {
            flex: 1;
            overflow-y: auto;
        }

        .robust-scenario-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .robust-scenario-table thead {
            background: #2a2a2a;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .robust-scenario-table th {
            padding: 8px 10px;
            text-align: left;
            color: #ffffff;
            font-weight: 600;
            border-bottom: 1px solid #404040;
            font-size: 12px;
        }

        .robust-scenario-table td {
            padding: 8px 10px;
            color: #ddd;
            border-bottom: 1px solid #2A2A2A;
            font-size: 12px;
        }

        .robust-scenario-table tbody tr:hover {
            background: #2a2a2a;
        }

        .robust-btn-secondary {
            background: #404040;
            color: #ffffff;
            border-color: #404040;
        }

        .robust-btn-secondary:hover {
            background: #555555;
            border-color: #555555;
        }

        /* 场景详情面板样式 */
        .robust-main-content {
            display: flex;
            flex: 1;
            gap: 12px;
            overflow: hidden;
            min-height: 0;
        }

        .robust-groups-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
        }

        .robust-scenario-detail-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 4px;
            overflow: hidden;
            min-width: 0;
        }

        .robust-scenario-detail-header {
            padding: 12px 16px;
            background: #2a2a2a;
            border-bottom: 1px solid #404040;
        }

        .robust-scenario-detail-title {
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 12px;
        }

        .robust-scenario-detail-info {
            display: flex;
            align-items: center;
            gap: 24px;
            flex-wrap: wrap;
        }

        .robust-scenario-group-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .robust-info-label {
            color: #888888;
            font-size: 13px;
        }

        .robust-info-value {
            color: #ffffff;
            font-size: 13px;
            font-weight: 500;
        }

        .robust-scenario-metrics {
            display: flex;
            gap: 24px;
        }

        .robust-metric-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .robust-metric-label {
            color: #888888;
            font-size: 12px;
        }

        .robust-metric-value {
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
        }

        .robust-scenario-navigation {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        .robust-scenario-nav-label {
            color: #ddd;
            font-size: 13px;
        }

        .robust-scenario-nav-btn {
            width: 28px;
            height: 28px;
            background: #3AACDE;
            border: none;
            border-radius: 4px;
            color: #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .robust-scenario-nav-btn:hover:not(:disabled) {
            background: #005a9e;
        }

        .robust-scenario-nav-btn:disabled {
            background: #404040;
            color: #666666;
            cursor: not-allowed;
        }

        .robust-scenario-nav-info {
            color: #ffffff;
            font-size: 13px;
            min-width: 50px;
            text-align: center;
        }

        .robust-scenario-detail-table-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
        }

        .robust-scenario-detail-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .robust-scenario-detail-table thead {
            background: #2a2a2a;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .robust-scenario-detail-table th {
            padding: 10px 12px;
            text-align: left;
            color: #ffffff;
            font-weight: 600;
            border-bottom: 1px solid #404040;
            background: #2a2a2a;
        }

        .robust-scenario-detail-table td {
            padding: 10px 12px;
            color: #ddd;
            border-bottom: 1px solid #2A2A2A;
        }

        .robust-scenario-detail-table tbody tr {
            cursor: pointer;
            transition: background 0.2s;
        }

        .robust-scenario-detail-table tbody tr:hover {
            background: #2a2a2a;
        }

        .robust-scenario-detail-table tbody tr.selected {
            background: #1e3a5f;
            border-left: 3px solid #3AACDE;
        }

        .robust-scenario-detail-table tbody tr.selected td {
            color: #ffffff;
        }

        .plan-evaluation-content .right-content-area {
            flex: 1;
            display: flex;
            flex-direction: row;
            height: 100vh;
            background: #000000;
            overflow: hidden;
            position: relative;
        }

        /* 中间内容包装器 */
        .plan-evaluation-content .main-content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            overflow: hidden;
        }

        /* 子页面容器 */
        .plan-evaluation-content .evaluation-sub-page {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        .plan-evaluation-content .evaluation-sub-page.active {
            display: flex;
        }

        /* 右侧切换面板 */
        .plan-evaluation-content .right-switch-panel {
            width: 60px;
            background: #1f1f1f;
            border-left: 2px solid #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            flex-shrink: 0;
        }

        .plan-evaluation-content .switch-tabs {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }

        .plan-evaluation-content .switch-tab {
            width: 100%;
            padding: 16px 8px;
            background: #2d2d2d;
            border: 1px solid #404040;
            border-left: none;
            border-right: none;
            color: #ccc;
            cursor: pointer;
            transition: all 0.3s;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .plan-evaluation-content .switch-tab:hover {
            background: #3a3a3a;
            border-color: #555;
        }

        .plan-evaluation-content .switch-tab.active {
            background: #3AACDE;
            color: #fff;
            border-color: #3AACDE;
        }

        .plan-evaluation-content .switch-tab-text {
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 2px;
        }

        /* 工具栏样式 */
        .plan-evaluation-content .image-processing-toolbar {
            background-color: #2d2d2d;
            border-bottom: 1px solid #404040;
            position: fixed;
            top: 0;
            left: 350px;
            right: 60px;
            z-index: 1000;
            width: calc(100vw - 410px);
            transition: height 0.3s ease, left 0.3s ease, width 0.3s ease, right 0.3s ease;
            overflow: hidden;
        }

        .plan-evaluation-content .image-left-panel.collapsed ~ .right-content-area .image-processing-toolbar {
            left: 60px;
            width: calc(100vw - 120px);
        }

        .plan-evaluation-content .image-processing-toolbar.expanded {
            height: 70px;
        }

        .plan-evaluation-content .image-processing-toolbar.collapsed {
            height: 40px;
        }

        .plan-evaluation-content .image-processing-toolbar.collapsed .toolbar-content {
            display: none;
        }

        .plan-evaluation-content .toolbar-toggle {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
        }

        .plan-evaluation-content .toolbar-toggle-btn {
            background: #404040;
            border: 1px solid #555555;
            color: #ddd;
            font-size: 12px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            height: 30px;
        }

        .plan-evaluation-content .toolbar-toggle-btn:hover {
            background-color: #555555;
            border-color: #666666;
            color: #ffffff;
        }

        .plan-evaluation-content .toolbar-content {
            padding: 10px 20px;
            padding-left: 80px;
            display: flex;
            align-items: center;
            gap: 20px;
            height: 100%;
        }

        .plan-evaluation-content .toolbar-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .plan-evaluation-content .toolbar-btn {
            padding: 8px 16px;
            background: #404040;
            border: 1px solid #555555;
            color: #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }

        .plan-evaluation-content .toolbar-btn:hover {
            background-color: #555555;
            border-color: #666666;
            color: #ffffff;
        }

        .plan-evaluation-content .toolbar-btn.active {
            background-color: #3AACDE;
            border-color: #3AACDE;
            color: #ffffff;
        }

        .plan-evaluation-content .toolbar-btn i {
            font-size: 14px;
        }

        /* 中央图像区域 */
        .plan-evaluation-content .plan-image-area {
            flex: 1;
            display: flex;
            gap: 8px;
            padding: 0;
            margin-top: 70px;
            min-height: 0;
        }

        .plan-evaluation-content .image-processing-toolbar.collapsed ~ .plan-image-area {
            margin-top: 40px;
        }

        .plan-evaluation-content .tri-views {
            flex: 0 0 50%;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 300px;
        }

        .plan-evaluation-content .tri-views .axial-view {
            flex: 1;
            min-height: 280px;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
            border: 1px solid #2A2A2A;
        }

        .plan-evaluation-content .tri-views .bottom-views {
            display: flex;
            gap: 8px;
            min-height: 240px;
        }

        .plan-evaluation-content .tri-views .coronal-view,
        .plan-evaluation-content .tri-views .sagittal-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
            border: 1px solid #2A2A2A;
        }

        .plan-evaluation-content .image-panel .panel-header {
            padding: 8px 12px;
            background: #2a2a2a;
            border-bottom: 1px solid #2A2A2A;
            display: flex;
            align-items: center;
        }

        .plan-evaluation-content .image-panel .view-label {
            font-size: 12px;
            color: #ddd;
            font-weight: 600;
        }

        .plan-evaluation-content .image-panel .image-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .plan-evaluation-content .image-panel .medical-image {
            width: 100%;
            height: 100%;
            background: #000000;
            position: relative;
        }

        .plan-evaluation-content .image-panel .panel-footer {
            padding: 6px 12px;
            background: #2a2a2a;
            border-top: 1px solid #2A2A2A;
            font-size: 11px;
            color: #888888;
        }

        .plan-evaluation-content .split-resizer {
            width: 6px;
            cursor: col-resize;
            background: transparent;
            flex: 0 0 6px;
        }

        .plan-evaluation-content .split-resizer:hover {
            background: rgba(0, 122, 204, 0.3);
        }

        .plan-evaluation-content .plan-image-area.resizing {
            cursor: col-resize;
        }

        .plan-evaluation-content .plan-image-area.resizing * {
            user-select: none;
        }

        .plan-evaluation-content .side-panel {
            flex: 0 0 50%;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-width: 260px;
        }

        .plan-evaluation-content .side-panel .toggle-group {
            display: inline-flex;
            background: #2d2d2d;
            border: 1px solid #404040;
            border-radius: 6px;
            overflow: hidden;
            padding: 4px;
        }

        .plan-evaluation-content .side-panel .toggle-btn {
            padding: 6px 12px;
            background: transparent;
            border: none;
            color: #ccc;
            cursor: pointer;
            transition: all 0.3s;
        }

        .plan-evaluation-content .side-panel .toggle-btn.active {
            background: #3AACDE;
            color: #fff;
        }

        .plan-evaluation-content .side-panel .tabs {
            display: flex;
            gap: 8px;
        }

        .plan-evaluation-content .side-panel .tab {
            padding: 6px 10px;
            background: #2d2d2d;
            border: 1px solid #404040;
            color: #ccc;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .plan-evaluation-content .side-panel .tab.active {
            background: #3AACDE;
            color: #fff;
            border-color: #3AACDE;
        }

        .plan-evaluation-content .side-panel .tab-panels {
            flex: 1;
            display: flex;
            min-height: 0;
        }

        .plan-evaluation-content .side-panel .tab-panel {
            flex: 1;
            display: none;
            align-items: center;
            justify-content: center;
            color: #aaa;
            border: 1px solid #333;
            background: #111;
            border-radius: 4px;
        }

        .plan-evaluation-content .side-panel .tab-panel.active {
            display: flex;
        }

        .plan-evaluation-content .bev-placeholder,
        .plan-evaluation-content .dvh-placeholder {
            padding: 16px;
            text-align: center;
        }

        /* 鲁棒性评估工具栏样式 */
        .plan-evaluation-content #robustnessEvaluationToolbar {
            background-color: #2d2d2d;
            border-bottom: 1px solid #404040;
            position: fixed;
            top: 0;
            left: 350px;
            right: 60px;
            z-index: 1000;
            width: calc(100vw - 410px);
            transition: height 0.3s ease, left 0.3s ease, width 0.3s ease, right 0.3s ease;
            overflow: hidden;
        }

        .plan-evaluation-content .image-left-panel.collapsed ~ .right-content-area #robustnessEvaluationToolbar {
            left: 60px;
            width: calc(100vw - 120px);
        }

        .plan-evaluation-content #robustnessEvaluationToolbar.expanded {
            height: 70px;
        }

        .plan-evaluation-content #robustnessEvaluationToolbar.collapsed {
            height: 40px;
        }

        /* 鲁棒性评估样式 */
        .plan-evaluation-content .robustness-evaluation-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            padding: 12px;
            margin-top: 70px;
            gap: 12px;
        }

        /* 上部分：左侧（场景列表+DVH）和右侧（三视图） */
        .plan-evaluation-content .robustness-top-section {
            display: flex;
            flex-direction: row;
            gap: 12px;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        /* 左侧区域：场景列表和DVH */
        .plan-evaluation-content .robustness-left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-width: 0;
            min-height: 0;
        }

        /* 场景列表面板 */
        .plan-evaluation-content .robustness-scenario-panel {
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 4px;
            overflow: visible;
            min-height: 200px;
            max-height: 400px;
            position: relative;
        }

        .plan-evaluation-content .robustness-panel-header {
            padding: 10px 16px;
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            color: #ffffff;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .plan-evaluation-content .scenario-table-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            min-height: 0;
            overflow: auto;
        }

        .plan-evaluation-content .scenario-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .plan-evaluation-content .scenario-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #2d2d2d;
        }

        .plan-evaluation-content .scenario-table th {
            padding: 8px 12px;
            text-align: left;
            color: #ffffff;
            font-weight: 600;
            border-bottom: 2px solid #404040;
            font-size: 12px;
            white-space: nowrap;
        }

        .plan-evaluation-content .scenario-table td {
            padding: 6px 12px;
            color: #e0e0e0;
            border-bottom: 1px solid #2a2a2a;
            white-space: nowrap;
        }

        .plan-evaluation-content .scenario-table tbody tr {
            cursor: pointer;
            transition: background 0.2s;
        }

        .plan-evaluation-content .scenario-table tbody tr:hover {
            background: #2a2a2a;
        }

        .plan-evaluation-content .scenario-table tbody tr.selected {
            background: #1e3a5f;
        }

        .plan-evaluation-content .scenario-table tbody tr.highlighted {
            outline: 2px solid #ff0000;
            outline-offset: -2px;
        }

        .plan-evaluation-content .scenario-delete-btn {
            background: transparent;
            border: none;
            color: #5dade2;
            cursor: pointer;
            padding: 4px 8px;
            font-size: 14px;
            transition: color 0.2s;
        }

        .plan-evaluation-content .scenario-delete-btn:hover {
            color: #3498db;
        }

        .plan-evaluation-content .scenario-delete-btn:active {
            color: #2980b9;
        }

        .plan-evaluation-content .scenario-column-toggle-btn {
            background: transparent;
            border: 1px solid #404040;
            color: #ccc;
            cursor: pointer;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .plan-evaluation-content .scenario-column-toggle-btn:hover {
            background: #2a2a2a;
            border-color: #555;
            color: #fff;
        }

        .plan-evaluation-content .scenario-column-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: #2d2d2d;
            border: 1px solid #404040;
            border-radius: 4px;
            padding: 8px;
            margin-top: 4px;
            z-index: 1000;
            min-width: 150px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .plan-evaluation-content .scenario-column-menu .column-menu-item {
            padding: 4px 0;
        }

        .plan-evaluation-content .scenario-column-menu .column-menu-item label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #fff;
            font-size: 12px;
            cursor: pointer;
            user-select: none;
        }

        .plan-evaluation-content .scenario-column-menu .column-menu-item input[type="checkbox"] {
            cursor: pointer;
        }

        .plan-evaluation-content .scenario-table th.hidden,
        .plan-evaluation-content .scenario-table td.hidden {
            display: none;
        }

        /* 左下：DVH */
        .plan-evaluation-content .robustness-dvh-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 4px;
            overflow: hidden;
            min-height: 0;
        }

        .plan-evaluation-content .robustness-panel-header {
            padding: 10px 16px;
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            color: #ffffff;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        .plan-evaluation-content .robustness-dvh-chart {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            min-height: 0;
        }

        /* 右侧：三视图 */
        .plan-evaluation-content .robustness-views-panel {
            flex: 1;
            display: flex;
            flex-direction: row;
            gap: 0;
            overflow: hidden;
            min-width: 0;
            min-height: 0;
            position: relative;
        }

        .plan-evaluation-content .robustness-right-tabs {
            display: flex;
            gap: 4px;
            padding: 8px;
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            flex-shrink: 0;
        }

        .plan-evaluation-content .robustness-right-tab {
            flex: 1;
            padding: 8px 12px;
            background: #1a1a1a;
            border: 1px solid #404040;
            color: #ccc;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
        }

        .plan-evaluation-content .robustness-right-tab:hover {
            background: #2a2a2a;
            border-color: #555;
        }

        .plan-evaluation-content .robustness-right-tab.active {
            background: #3AACDE;
            color: #fff;
            border-color: #3AACDE;
        }

        .plan-evaluation-content .robustness-right-content {
            flex: 1;
            overflow: hidden;
            min-height: 0;
            min-width: 0;
        }

        .plan-evaluation-content .robustness-right-tab-content {
            display: none;
            height: 100%;
            overflow: hidden;
            min-height: 0;
            min-width: 0;
        }

        .plan-evaluation-content .robustness-right-tab-content.active {
            display: flex;
            flex-direction: column;
            min-height: 0;
            min-width: 0;
        }

        /* 临床目标表格 */
        .plan-evaluation-content .clinical-targets-table-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            min-height: 0;
            max-height: 100%;
            min-width: 0;
            width: 100%;
        }

        .plan-evaluation-content .clinical-targets-table {
            width: auto;
            min-width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .plan-evaluation-content .clinical-targets-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #2d2d2d;
        }

        .plan-evaluation-content .clinical-targets-table th {
            padding: 8px 12px;
            text-align: left;
            color: #ffffff;
            font-weight: 600;
            border-bottom: 2px solid #404040;
            font-size: 12px;
            white-space: nowrap;
        }

        .plan-evaluation-content .clinical-targets-table td {
            padding: 6px 12px;
            color: #e0e0e0;
            border-bottom: 1px solid #2a2a2a;
            white-space: nowrap;
        }

        .plan-evaluation-content .clinical-targets-table tbody tr:hover {
            background: #2a2a2a;
        }

        /* 下部分：底部面板（临床目标和射束列表） */
        .plan-evaluation-content .robustness-bottom-section {
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
            border-top: 1px solid #404040;
            overflow: hidden;
            min-height: 300px;
            max-height: 400px;
        }

        /* 底部面板标签 */
        .plan-evaluation-content .robustness-bottom-tabs {
            display: flex;
            gap: 4px;
            padding: 8px;
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            flex-shrink: 0;
        }

        .plan-evaluation-content .robustness-bottom-tab {
            padding: 8px 16px;
            background: #1a1a1a;
            border: 1px solid #404040;
            color: #ccc;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
        }

        .plan-evaluation-content .robustness-bottom-tab:hover {
            background: #2a2a2a;
            border-color: #555;
        }

        .plan-evaluation-content .robustness-bottom-tab.active {
            background: #3AACDE;
            color: #fff;
            border-color: #3AACDE;
        }

        .plan-evaluation-content .robustness-bottom-content {
            flex: 1;
            overflow: hidden;
            min-height: 0;
        }

        .plan-evaluation-content .robustness-bottom-tab-content {
            display: none;
            height: 100%;
            overflow: hidden;
            min-height: 0;
        }

        .plan-evaluation-content .robustness-bottom-tab-content.active {
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        /* 三个2D视图（在上部分右侧） */
        .plan-evaluation-content .robustness-2d-views {
            flex: 1;
            display: flex;
            flex-direction: row;
            gap: 0;
            overflow: hidden;
            position: relative;
        }

        /* 左侧大视图：横截面 */
        .plan-evaluation-content .robustness-2d-view-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 4px;
            overflow: hidden;
            min-width: 0;
            min-height: 0;
        }

        /* 右侧小视图区域 */
        .plan-evaluation-content .robustness-2d-views-right {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 0;
            min-height: 0;
            gap: 0;
        }

        /* 右侧小视图 */
        .plan-evaluation-content .robustness-2d-view-sub {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 4px;
            overflow: hidden;
            min-height: 0;
        }

        /* 视图分隔条 */
        .plan-evaluation-content .robustness-view-resizer-horizontal {
            width: 4px;
            background: transparent;
            cursor: col-resize;
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }

        .plan-evaluation-content .robustness-view-resizer-horizontal:hover {
            background: rgba(0, 122, 204, 0.3);
        }

        .plan-evaluation-content .robustness-view-resizer-vertical {
            height: 4px;
            background: transparent;
            cursor: row-resize;
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }

        .plan-evaluation-content .robustness-view-resizer-vertical:hover {
            background: rgba(0, 122, 204, 0.3);
        }

        .plan-evaluation-content .robustness-2d-views.resizing {
            user-select: none;
        }

        .plan-evaluation-content .robustness-2d-views.resizing * {
            user-select: none;
        }

        .plan-evaluation-content .view-header {
            padding: 6px 12px;
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            color: #ffffff;
            font-weight: 600;
            font-size: 12px;
            flex-shrink: 0;
        }

        .plan-evaluation-content .view-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            min-height: 0;
        }

        .plan-evaluation-content .robustness-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .plan-evaluation-content .view-footer {
            padding: 4px 12px;
            background: #2d2d2d;
            border-top: 1px solid #404040;
            color: #ddd;
            font-size: 11px;
            flex-shrink: 0;
        }

        /* 右侧（1/3）：场景列表 */
        .plan-evaluation-content .robustness-scenario-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 4px;
            overflow: hidden;
        }

        .plan-evaluation-content .robustness-group-info {
            padding: 16px;
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 4px;
            margin-bottom: 16px;
        }

        .plan-evaluation-content .group-name {
            color: #ffffff;
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .plan-evaluation-content .group-metrics {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .plan-evaluation-content .metric-item {
            color: #ddd;
            font-size: 13px;
            padding: 6px 12px;
            background: #1a1a1a;
            border-radius: 4px;
            border: 1px solid #333;
        }

        /* 鲁棒性子标签 */
        .plan-evaluation-content .robustness-sub-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-shrink: 0;
        }

        .plan-evaluation-content .sub-tab {
            flex: 1;
            padding: 10px 16px;
            background: #2d2d2d;
            border: 1px solid #404040;
            color: #ccc;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .plan-evaluation-content .sub-tab:hover {
            background: #3a3a3a;
            border-color: #555;
        }

        .plan-evaluation-content .sub-tab.active {
            background: #3AACDE;
            color: #fff;
            border-color: #3AACDE;
        }

        /* 子标签内容 */
        .plan-evaluation-content .sub-tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
            min-height: 0;
        }

        .plan-evaluation-content .sub-tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* 场景列表表格 */
        .plan-evaluation-content .scenario-table-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            border: 1px solid #404040;
            border-radius: 4px;
            background: #1a1a1a;
        }

        .plan-evaluation-content .scenario-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .plan-evaluation-content .scenario-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #2d2d2d;
        }

        .plan-evaluation-content .scenario-table th {
            padding: 12px 10px;
            text-align: left;
            color: #ffffff;
            font-weight: 600;
            border-bottom: 2px solid #404040;
            font-size: 13px;
        }

        .plan-evaluation-content .scenario-table td {
            padding: 10px;
            color: #e0e0e0;
            border-bottom: 1px solid #2a2a2a;
        }

        .plan-evaluation-content .scenario-table tbody tr:hover {
            background: #2a2a2a;
        }

        .plan-evaluation-content .evaluation-suggestions-placeholder {
            padding: 40px;
            text-align: center;
            color: #aaa;
            font-size: 14px;
        }

        /* 底部面板 */
        .plan-evaluation-content .plan-bottom-panel {
            background: #1a1a1a;
            border-top: 1px solid #333;
            flex-shrink: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        /* 计划对比视图显示时，隐藏底部面板 */
        .plan-evaluation-content .plan-comparison-view.active ~ .plan-bottom-panel {
            display: none;
        }
        
        .plan-evaluation-content .plan-evaluation-normal-view:has(~ .plan-comparison-view.active) ~ .plan-bottom-panel,
        .plan-evaluation-content .plan-evaluation-normal-view.hidden ~ .plan-bottom-panel {
            display: none;
        }

        .plan-evaluation-content .bottom-tabs {
            display: flex;
            gap: 8px;
            padding: 8px 12px;
            border-bottom: 1px solid #333;
        }

        .plan-evaluation-content .bottom-tab {
            padding: 6px 10px;
            background: #2d2d2d;
            border: 1px solid #404040;
            color: #ccc;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .plan-evaluation-content .bottom-tab.active {
            background: #3AACDE;
            color: #fff;
            border-color: #3AACDE;
        }

        .plan-evaluation-content .bottom-contents {
            height: 28vh;
            overflow: auto;
        }

        .plan-evaluation-content .bottom-content {
            display: none;
            padding: 10px;
            color: #bbb;
        }

        .plan-evaluation-content .bottom-content.active {
            display: block;
        }

        .plan-evaluation-content .loading-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #888;
            gap: 10px;
        }

        .plan-evaluation-content .loading-indicator i {
            font-size: 24px;
        }

        /* 计划对比模态对话框 */
        .plan-comparison-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .plan-comparison-modal.show {
            display: flex;
        }

        .plan-comparison-modal-content {
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .plan-comparison-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #404040;
        }

        .plan-comparison-modal-title {
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
        }

        .plan-comparison-modal-close {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #ddd;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .plan-comparison-modal-close:hover {
            background: #404040;
            color: #ffffff;
        }

        .plan-comparison-modal-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .plan-comparison-field {
            margin-bottom: 16px;
        }

        .plan-comparison-field:last-child {
            margin-bottom: 0;
        }

        .plan-comparison-label {
            display: block;
            font-size: 13px;
            color: #ddd;
            margin-bottom: 8px;
        }

        .plan-comparison-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .plan-comparison-select {
            flex: 1;
            position: relative;
        }

        .plan-comparison-select input {
            width: 100%;
            padding: 8px 32px 8px 12px;
            background: #1a1a1a;
            border: 1px solid #555555;
            border-radius: 4px;
            color: #ffffff;
            font-size: 13px;
            cursor: pointer;
            box-sizing: border-box;
        }

        .plan-comparison-select input:focus {
            outline: none;
            border-color: #3AACDE;
        }

        .plan-comparison-select input.error {
            border-color: #ff4444;
            box-shadow: 0 0 0 2px rgba(255, 68, 68, 0.2);
        }

        .plan-comparison-select .dropdown-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #ddd;
            pointer-events: none;
        }

        .plan-comparison-select .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #1a1a1a;
            border: 1px solid #555555;
            border-radius: 4px;
            margin-top: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .plan-comparison-select.open .dropdown-menu {
            display: block;
        }

        .plan-comparison-select .dropdown-item {
            padding: 8px 12px;
            color: #ddd;
            cursor: pointer;
            transition: all 0.2s;
        }

        .plan-comparison-select .dropdown-item:hover {
            background: #2a2a2a;
            color: #ffffff;
        }

        .plan-comparison-select .dropdown-item.selected {
            background: #3AACDE;
            color: #ffffff;
        }

        .plan-comparison-remove-btn {
            padding: 8px 12px;
            background: transparent;
            border: none;
            color: #3AACDE;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .plan-comparison-remove-btn:hover {
            color: #0099ff;
        }

        .plan-comparison-add-btn {
            padding: 8px 16px;
            background: #3AACDE;
            border: none;
            border-radius: 4px;
            color: #ffffff;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            margin-top: 8px;
        }

        .plan-comparison-add-btn:hover {
            background: #0099ff;
        }

        .plan-comparison-add-btn:disabled {
            background: #404040;
            color: #888888;
            cursor: not-allowed;
        }

        .plan-comparison-modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #404040;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .plan-comparison-btn {
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            border: none;
        }

        .plan-comparison-btn-cancel {
            background: #ffffff;
            color: #000000;
        }

        .plan-comparison-btn-cancel:hover {
            background: #f0f0f0;
        }

        .plan-comparison-btn-confirm {
            background: #3AACDE;
            color: #ffffff;
        }

        .plan-comparison-btn-confirm:hover {
            background: #0099ff;
        }

        /* 计划对比视图 */
        .plan-comparison-view {
            display: none;
            flex: 1;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
            padding-top: 70px;
        }

        .plan-comparison-view.active {
            display: flex;
        }

        .plan-evaluation-normal-view {
            display: flex;
            flex: 1;
            flex-direction: column;
            height: 100%;
        }

        .plan-evaluation-normal-view.hidden {
            display: none;
        }

        /* 对比视图布局 */
        .comparison-main-container {
            display: flex;
            flex: 1;
            min-height: 0;
            gap: 8px;
            padding: 8px;
        }

        /* 两个计划布局：横向排列 */
        #twoPlansContainer {
            flex-direction: row;
        }

        /* 三个计划布局：纵向排列 */
        #threePlansContainer {
            flex-direction: column;
        }

        /* 三个计划布局：顶部横截面区域 */
        .comparison-three-plans-top {
            display: flex;
            gap: 8px;
            height: 40%;
            min-height: 300px;
            margin-bottom: 8px;
        }

        /* 三个计划布局：底部左右分栏 */
        .comparison-three-plans-bottom {
            display: flex;
            flex: 1;
            gap: 8px;
            min-height: 0;
        }

        /* 左侧：两个计划的对比视图 */
        .comparison-plans-container {
            flex: 1;
            display: flex;
            gap: 8px;
            min-width: 0;
        }

        /* 三个计划的横截面容器 */
        .comparison-three-plans-container {
            display: flex;
            gap: 8px;
            width: 100%;
        }

        .comparison-plan-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
            border: 1px solid #2A2A2A;
            border-radius: 4px;
            overflow: hidden;
        }

        .comparison-plan-header {
            padding: 8px 12px;
            background: #2a2a2a;
            border-bottom: 1px solid #2A2A2A;
            color: #ffffff;
            font-weight: 600;
            font-size: 13px;
        }

        .comparison-plan-views {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 4px;
            overflow: hidden;
        }

        /* 三个计划时的单视图模式 */
        .comparison-plan-item.single-view .comparison-plan-views {
            padding: 0;
        }

        .comparison-plan-item.single-view .comparison-view-item {
            flex: 1;
        }

        .comparison-view-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #000000;
            border: 1px solid #2A2A2A;
            min-height: 0;
        }

        .comparison-view-header {
            padding: 4px 8px;
            background: #2a2a2a;
            border-bottom: 1px solid #2A2A2A;
            color: #ddd;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
        }

        .comparison-view-image {
            flex: 1;
            position: relative;
            background: #000000;
            overflow: hidden;
        }

        .comparison-view-image canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .comparison-dose-legend {
            position: absolute;
            right: 8px;
            top: 8px;
            background: rgba(26, 26, 26, 0.9);
            border: 1px solid #555555;
            border-radius: 4px;
            padding: 8px;
            font-size: 10px;
            color: #ddd;
        }

        .comparison-dose-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }

        .comparison-dose-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        /* 分隔条 */
        .comparison-resizer {
            width: 6px;
            cursor: col-resize;
            background: transparent;
            flex: 0 0 6px;
            position: relative;
            z-index: 10;
        }

        .comparison-resizer:hover {
            background: rgba(0, 122, 204, 0.3);
        }

        .comparison-main-container.resizing {
            cursor: col-resize;
        }

        .comparison-main-container.resizing * {
            user-select: none;
        }

        /* 右侧：DVH和对比列表 */
        .comparison-right-panel {
            width: 500px;
            min-width: 400px;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-shrink: 0;
        }

        /* 三个计划布局：左侧DVH区域 */
        .comparison-three-dvh-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        /* 三个计划布局：右侧对比列表区域 */
        .comparison-three-list-area {
            width: 500px;
            min-width: 400px;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        /* 三个计划布局的分隔条 */
        .comparison-three-resizer {
            width: 6px;
            cursor: col-resize;
            background: transparent;
            flex: 0 0 6px;
            position: relative;
            z-index: 10;
        }

        .comparison-three-resizer:hover {
            background: rgba(0, 122, 204, 0.3);
        }

        .comparison-three-plans-bottom.resizing {
            cursor: col-resize;
        }

        .comparison-three-plans-bottom.resizing * {
            user-select: none;
        }

        /* DVH和剂量差异视图 */
        .comparison-dvh-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
            border: 1px solid #2A2A2A;
            border-radius: 4px;
            overflow: hidden;
            min-height: 300px;
        }

        .comparison-dvh-tabs {
            display: flex;
            gap: 4px;
            padding: 8px 8px 0 8px;
            background: #2a2a2a;
            border-bottom: 1px solid #2A2A2A;
        }

        .comparison-dvh-tab {
            padding: 6px 12px;
            background: #1a1a1a;
            border: 1px solid #2A2A2A;
            border-bottom: none;
            color: #ddd;
            cursor: pointer;
            font-size: 12px;
            border-radius: 4px 4px 0 0;
            transition: all 0.3s;
        }

        .comparison-dvh-tab.active {
            background: #2a2a2a;
            color: #ffffff;
            border-color: #3AACDE;
        }

        .comparison-dvh-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .comparison-dvh-panel {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow: hidden;
        }

        .comparison-dvh-panel.active {
            display: flex;
        }

        .comparison-dvh-panel-header {
            padding: 8px 12px;
            background: #2a2a2a;
            border-bottom: 1px solid #2A2A2A;
            color: #ffffff;
            font-weight: 600;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comparison-dvh-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .comparison-dvh-checkbox {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: #ddd;
        }

        .comparison-dvh-chart {
            flex: 1;
            padding: 12px;
            position: relative;
            overflow: hidden;
        }

        .comparison-dvh-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888888;
            font-size: 12px;
        }

        /* 对比列表 */
        .comparison-list-container {
            flex: 1;
            min-height: 250px;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
            border: 1px solid #2A2A2A;
            border-radius: 4px;
            overflow: hidden;
        }

        .comparison-list-tabs {
            display: flex;
            gap: 4px;
            padding: 8px 8px 0 8px;
            background: #2a2a2a;
            border-bottom: 1px solid #2A2A2A;
        }

        .comparison-list-tab {
            padding: 6px 12px;
            background: #1a1a1a;
            border: 1px solid #2A2A2A;
            border-bottom: none;
            color: #ddd;
            cursor: pointer;
            font-size: 12px;
            border-radius: 4px 4px 0 0;
            transition: all 0.3s;
        }

        .comparison-list-tab.active {
            background: #2a2a2a;
            color: #ffffff;
            border-color: #3AACDE;
        }

        .comparison-list-content {
            flex: 1;
            overflow: hidden;
            padding: 12px;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .comparison-list-content-item {
            display: none;
            flex: 1;
            overflow: auto;
            min-height: 0;
        }

        .comparison-list-content-item.active {
            display: flex;
            flex-direction: column;
        }

        /* 剂量统计表格容器 */
        .comparison-list-content-item.active > div:first-child {
            flex-shrink: 0;
            margin-bottom: 12px;
        }

        .comparison-list-content-item.active table.comparison-stats-table {
            flex: 1;
            overflow: auto;
            min-height: 0;
            display: block;
        }

        .comparison-list-content-item.active table.comparison-stats-table thead,
        .comparison-list-content-item.active table.comparison-stats-table tbody {
            display: table;
            width: 100%;
        }

        .comparison-stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .comparison-stats-table th,
        .comparison-stats-table td {
            padding: 6px 8px;
            text-align: left;
            border-bottom: 1px solid #2A2A2A;
            color: #ddd;
        }

        .comparison-stats-table th {
            background: #2a2a2a;
            color: #ffffff;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .comparison-stats-table tbody tr:hover {
            background: #252525;
        }

        .comparison-stats-table .plan-row {
            background: #1f1f1f;
        }

        .comparison-stats-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .comparison-stats-color {
            width: 16px;
            height: 16px;
            border-radius: 2px;
            border: 1px solid #555555;
        }

        /* 剂量统计组件样式 */
        .dose-statistics-component {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .dose-stats-type-selector {
            display: flex;
            gap: 16px;
            padding: 12px;
            border-bottom: 1px solid #2A2A2A;
            background: #2a2a2a;
        }

        .dose-stats-radio {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #ddd;
            font-size: 13px;
            cursor: pointer;
        }

        .dose-stats-radio input[type="radio"] {
            margin: 0;
            cursor: pointer;
        }

        .dose-stats-radio input[type="radio"]:checked + span {
            color: #3AACDE;
            font-weight: 600;
        }

        .dose-stats-content-item {
            display: none;
            flex: 1;
            overflow: auto;
            min-height: 0;
            flex-direction: column;
        }

        .dose-stats-content-item.active {
            display: flex;
        }

        .dose-stats-table-wrapper {
            flex: 1;
            overflow: auto;
            min-height: 0;
        }

        .dose-stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .dose-stats-table th,
        .dose-stats-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #2A2A2A;
            color: #ddd;
        }

        .dose-stats-table th {
            background: #2a2a2a;
            color: #ffffff;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .dose-stats-table tbody tr:hover {
            background: #252525;
        }

        .dose-stats-row {
            background: #1a1a1a;
        }

        .dose-stats-visibility-toggle {
            cursor: pointer;
            color: #3AACDE;
            font-size: 14px;
            transition: color 0.3s;
        }

        .dose-stats-visibility-toggle:hover {
            color: #0099ff;
        }

        .dose-stats-visibility-toggle.hidden {
            color: #666666;
        }

        .dose-stats-color {
            width: 20px;
            height: 12px;
            border-radius: 2px;
            border: 1px solid #555555;
            display: inline-block;
        }

        .dose-stats-container {
            height: 100%;
            overflow: hidden;
        }

        /* 计划对比剂量统计组件样式 */
        .plan-comparison-dose-statistics-component {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .comparison-list-content-item.active .dose-stats-container {
            flex: 1;
            overflow: hidden;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        /* 三个计划对比剂量统计组件样式 */
        .three-plans-comparison-dose-statistics-component {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div class="plan-evaluation-content">
        <!-- 左侧面板 -->
        <div class="image-left-panel" id="evalLeftPanel">
            <div class="resizer-handle" id="evalResizerHandle"></div>
            <div class="patient-info-header">
                <div class="patient-avatar"><i class="fas fa-user"></i></div>
                <div class="patient-details">
                    <div class="patient-name">Zhangguang (ID:Y87342987)</div>
                    <div class="patient-info">1967-10-08 M</div>
                </div>
                <div class="collapse-toggle" id="evalLeftPanelToggle"><i class="fas fa-chevron-left"></i></div>
            </div>
            <div class="content-area">
                <!-- 计划评估导航按钮 -->
                <div class="vertical-nav-buttons plan-evaluation-nav" id="planEvaluationNav" style="display: none;">
                    <button class="nav-btn" data-panel="eval-sequence"><i class="fas fa-sitemap"></i><span>序列树</span></button>
                    <button class="nav-btn" data-panel="eval-poi"><i class="fas fa-crosshairs"></i><span>POI</span></button>
                    <button class="nav-btn" data-panel="eval-iso"><i class="fas fa-bullseye"></i><span>ISO</span></button>
                    <button class="nav-btn" data-panel="eval-roi"><i class="fas fa-shapes"></i><span>ROI</span></button>
                    <button class="nav-btn" data-panel="eval-registration"><i class="fas fa-link"></i><span>配准</span></button>
                    <button class="nav-btn" data-panel="eval-dose"><i class="fas fa-radiation"></i><span>DOSE</span></button>
                    <button class="nav-btn" data-panel="eval-let"><i class="fas fa-atom"></i><span>LET</span></button>
                </div>
                
                <!-- 鲁棒性评估导航按钮 -->
                <div class="vertical-nav-buttons robustness-evaluation-nav" id="robustnessEvaluationNav" style="display: none;">
                    <button class="nav-btn active" data-panel="robust-sequence"><i class="fas fa-sitemap"></i><span>序列树</span></button>
                    <button class="nav-btn" data-panel="robust-robust"><i class="fas fa-shield-alt"></i><span>ROBUST</span></button>
                    <button class="nav-btn" data-panel="robust-roi"><i class="fas fa-shapes"></i><span>ROI</span></button>
                    <button class="nav-btn" data-panel="robust-poi"><i class="fas fa-crosshairs"></i><span>POI</span></button>
                </div>
                <div class="panel-content">
                    <div class="panel-section" id="eval-sequence-panel">
                        <div class="sequence-tree-container" id="evalSequenceContainer">
                            <div class="loading-indicator">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>加载序列树组件...</span>
                            </div>
                        </div>
                    </div>
                    <div class="panel-section" id="eval-poi-panel">
                        <div class="poi-panel-container" id="evalPoiContainer">
                            <div class="loading-indicator">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>加载POI组件...</span>
                            </div>
                        </div>
                    </div>
                    <div class="panel-section" id="eval-iso-panel">
                        <div class="poi-panel-container" id="evalIsoContainer">
                            <div class="loading-indicator">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>加载ISO组件...</span>
                            </div>
                        </div>
                    </div>
                    <div class="panel-section" id="eval-roi-panel">
                        <div class="roi-panel-container" id="evalRoiContainer">
                            <div class="loading-indicator">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>加载ROI组件...</span>
                            </div>
                        </div>
                    </div>
                    <div class="panel-section" id="eval-registration-panel">
                        <div class="registration-container" id="evalRegistrationContainer">
                            <div class="loading-indicator">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>加载配准组件...</span>
                            </div>
                        </div>
                    </div>
                    <div class="panel-section" id="eval-dose-panel">
                        <div class="dose-panel-container">
                            <div class="loading-indicator">
                                <i class="fas fa-info-circle"></i>
                                <span>DOSE 占位内容</span>
                            </div>
                        </div>
                    </div>
                    <div class="panel-section" id="eval-let-panel">
                        <div class="let-panel-container">
                            <div class="loading-indicator">
                                <i class="fas fa-info-circle"></i>
                                <span>LET 占位内容</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 鲁棒性评估面板内容 -->
                    <div class="panel-section active" id="robust-sequence-panel">
                        <div class="sequence-tree-container" id="robustSequenceContainer">
                            <div class="loading-indicator">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>加载序列树组件...</span>
                            </div>
                        </div>
                    </div>
                    <div class="panel-section" id="robust-robust-panel">
                        <div class="robust-panel-container" id="robustRobustContainer">
                            <div class="loading-indicator">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>加载ROBUST组件...</span>
                            </div>
                        </div>
                    </div>
                    <div class="panel-section" id="robust-roi-panel">
                        <div class="roi-panel-container" id="robustRoiContainer">
                            <div class="loading-indicator">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>加载ROI组件...</span>
                            </div>
                        </div>
                    </div>
                    <div class="panel-section" id="robust-poi-panel">
                        <div class="poi-panel-container" id="robustPoiContainer">
                            <div class="loading-indicator">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>加载POI组件...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧内容区域 -->
        <div class="right-content-area">
            <!-- 中间内容区域 -->
            <div class="main-content-wrapper">
                <!-- 顶部工具栏 -->
                <div class="image-processing-toolbar expanded" id="planEvaluationToolbar">
                    <div class="toolbar-toggle">
                        <button class="toolbar-toggle-btn" id="evalToolbarToggleBtn">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                    </div>
                    <div class="toolbar-content">
                        <div class="toolbar-section">
                            <button class="toolbar-btn active" id="planComparisonBtn"><i class="fas fa-layer-group"></i><span>计划对比</span></button>
                            <button class="toolbar-btn" id="exportDoseBtn"><i class="fas fa-file-export"></i><span>导出平面剂量</span></button>
                            <button class="toolbar-btn" id="approvePlanBtn"><i class="fas fa-check-circle"></i><span>审批计划</span></button>
                            <button class="toolbar-btn" id="exportReportBtn"><i class="fas fa-file-pdf"></i><span>导出报告</span></button>
                            <button class="toolbar-btn" id="lineDoseBtn"><i class="fas fa-chart-line"></i><span>线剂量评估</span></button>
                        </div>
                    </div>
                </div>

            <!-- 计划对比模态对话框 -->
            <div class="plan-comparison-modal" id="planComparisonModal">
                <div class="plan-comparison-modal-content">
                    <div class="plan-comparison-modal-header">
                        <div class="plan-comparison-modal-title">计划对比</div>
                        <div class="plan-comparison-modal-close" id="planComparisonModalClose">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    <div class="plan-comparison-modal-body" id="planComparisonModalBody">
                        <!-- 参考计划 -->
                        <div class="plan-comparison-field">
                            <label class="plan-comparison-label">参考计划</label>
                            <div class="plan-comparison-select" id="referencePlanSelect">
                                <input type="text" readonly placeholder="请选择参考计划" id="referencePlanInput" value="">
                                <i class="fas fa-chevron-down dropdown-icon"></i>
                                <div class="dropdown-menu" id="referencePlanDropdown"></div>
                            </div>
                        </div>
                        <!-- 对比计划列表 -->
                        <div id="comparisonPlansList"></div>
                        <!-- 添加对比计划按钮 -->
                        <button class="plan-comparison-add-btn" id="addComparisonPlanBtn">添加对比计划</button>
                    </div>
                    <div class="plan-comparison-modal-footer">
                        <button class="plan-comparison-btn plan-comparison-btn-cancel" id="planComparisonCancelBtn">取消</button>
                        <button class="plan-comparison-btn plan-comparison-btn-confirm" id="planComparisonConfirmBtn">确定</button>
                    </div>
                </div>
            </div>

                <!-- 鲁棒性评估子页面 -->
                <div class="evaluation-sub-page active" id="robustnessEvaluationPage">
                    <!-- 鲁棒性评估工具栏 -->
                    <div class="image-processing-toolbar expanded" id="robustnessEvaluationToolbar">
                        <div class="toolbar-toggle">
                            <button class="toolbar-toggle-btn" id="robustnessToolbarToggleBtn">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                        </div>
                        <div class="toolbar-content">
                            <div class="toolbar-section">
                                <button class="toolbar-btn" id="createRobustnessBtn"><i class="fas fa-plus-circle"></i><span>创建鲁棒性评估</span></button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="robustness-evaluation-content">
                        <!-- 上部分：左侧（场景列表+DVH）和右侧（三视图） -->
                        <div class="robustness-top-section">
                            <!-- 左侧区域：场景列表和DVH -->
                            <div class="robustness-left-panel">
                                <!-- 左上：场景列表 -->
                                <div class="robustness-scenario-panel">
                                    <div class="robustness-panel-header">
                                        <span>场景列表</span>
                                        <div style="display: flex; align-items: center; gap: 12px; margin-left: auto;">
                                            <button class="scenario-column-toggle-btn" id="scenarioColumnToggleBtn" title="显隐列">
                                                <i class="fas fa-columns"></i>
                                            </button>
                                            <span style="font-size: 12px; color: #888;" id="robustnessCurrentScenario">场景: 01/21</span>
                                        </div>
                                    </div>
                                    <!-- 显隐列菜单 -->
                                    <div class="scenario-column-menu" id="scenarioColumnMenu" style="display: none;">
                                        <div class="column-menu-item">
                                            <label>
                                                <input type="checkbox" data-column="no" checked> 序号
                                            </label>
                                        </div>
                                        <div class="column-menu-item">
                                            <label>
                                                <input type="checkbox" data-column="rl" checked> R-L
                                            </label>
                                        </div>
                                        <div class="column-menu-item">
                                            <label>
                                                <input type="checkbox" data-column="is" checked> I-S
                                            </label>
                                        </div>
                                        <div class="column-menu-item">
                                            <label>
                                                <input type="checkbox" data-column="pa" checked> P-A
                                            </label>
                                        </div>
                                        <div class="column-menu-item">
                                            <label>
                                                <input type="checkbox" data-column="density" checked> 密度不确定性%
                                            </label>
                                        </div>
                                        <div class="column-menu-item">
                                            <label>
                                                <input type="checkbox" data-column="operation" checked> 操作
                                            </label>
                                        </div>
                                    </div>
                                    <div class="scenario-table-container">
                                        <table class="scenario-table">
                                            <thead>
                                                <tr>
                                                    <th>序号</th>
                                                    <th>R-L</th>
                                                    <th>I-S</th>
                                                    <th>P-A</th>
                                                    <th>密度不确定性%</th>
                                                    <th>操作</th>
                                                </tr>
                                            </thead>
                                            <tbody id="scenarioTableBody">
                                                <!-- 动态生成 -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- 左下：DVH -->
                                <div class="robustness-dvh-panel">
                                    <div class="robustness-panel-header">
                                        <span>DVH</span>
                                    </div>
                                    <div class="robustness-dvh-chart" id="robustnessDvhChart">
                                        <canvas id="robustnessDvhCanvas" style="width: 100%; height: 100%;"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 右侧：三视图 -->
                            <div class="robustness-views-panel">
                                <!-- 左侧大视图：横截面（Axial） -->
                                <div class="robustness-2d-view-main axial-view" style="position: relative;">
                                    <div id="robustnessAxialContainer" style="width: 100%; height: 100%;"></div>
                                </div>
                                
                                <!-- 分隔条（水平） -->
                                <div class="robustness-view-resizer-horizontal" id="robustnessHorizontalResizer"></div>
                                
                                <!-- 右侧小视图区域 -->
                                <div class="robustness-2d-views-right">
                                    <!-- 上视图：冠状面（Coronal） -->
                                    <div class="robustness-2d-view-sub coronal-view" style="position: relative;">
                                        <div id="robustnessCoronalContainer" style="width: 100%; height: 100%;"></div>
                                    </div>
                                    
                                    <!-- 分隔条（垂直） -->
                                    <div class="robustness-view-resizer-vertical" id="robustnessVerticalResizer"></div>
                                    
                                    <!-- 下视图：矢状面（Sagittal） -->
                                    <div class="robustness-2d-view-sub sagittal-view" style="position: relative;">
                                        <div id="robustnessSagittalContainer" style="width: 100%; height: 100%;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 下部分：底部面板（临床目标和射束列表） -->
                        <div class="robustness-bottom-section">
                            <div class="robustness-bottom-tabs">
                                <button class="robustness-bottom-tab active" data-tab="robustnessClinicalTargets">临床目标</button>
                                <button class="robustness-bottom-tab" data-tab="robustnessBeamList">射束列表</button>
                            </div>
                            <div class="robustness-bottom-content">
                                <!-- 临床目标内容 -->
                                <div class="robustness-bottom-tab-content active" id="robustnessBottomClinicalTargets">
                                    <div class="clinical-targets-table-container">
                                        <table class="clinical-targets-table">
                                            <thead>
                                                <tr>
                                                    <th>颜色</th>
                                                    <th>ROI</th>
                                                    <th>类型</th>
                                                    <th>临床目标</th>
                                                    <th>实际值</th>
                                                    <th>通过率</th>
                                                    <th>最好值</th>
                                                    <th>最差值</th>
                                                </tr>
                                            </thead>
                                            <tbody id="robustnessBottomClinicalTargetsBody">
                                                <!-- 动态生成 -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div style="padding: 8px; border-top: 1px solid #404040; display: flex; gap: 8px; flex-shrink: 0;">
                                        <button style="padding: 6px 12px; background: #2d2d2d; border: 1px solid #404040; color: #fff; border-radius: 4px; cursor: pointer; font-size: 12px;">添加</button>
                                        <button style="padding: 6px 12px; background: #2d2d2d; border: 1px solid #404040; color: #fff; border-radius: 4px; cursor: pointer; font-size: 12px;">编辑</button>
                                        <button style="padding: 6px 12px; background: #2d2d2d; border: 1px solid #404040; color: #fff; border-radius: 4px; cursor: pointer; font-size: 12px;">删除</button>
                                        <button style="padding: 6px 12px; background: #2d2d2d; border: 1px solid #404040; color: #fff; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: auto;">加载模版</button>
                                        <button style="padding: 6px 12px; background: #2d2d2d; border: 1px solid #404040; color: #fff; border-radius: 4px; cursor: pointer; font-size: 12px;">创建模版</button>
                                    </div>
                                </div>
                                
                                <!-- 射束列表内容 -->
                                <div class="robustness-bottom-tab-content" id="robustnessBottomBeamList">
                                    <div class="beam-table-container" id="robustnessBottomBeamListContainer">
                                        <div class="loading-indicator">射束列表内容</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 计划评估子页面 -->
                <div class="evaluation-sub-page" id="planEvaluationPage">
                    <!-- 正常视图 -->
                    <div class="plan-evaluation-normal-view" id="normalView">
                        <!-- 中央图像区域：左三视图 + 右侧面板（2D/3D与BEV/DVH） -->
                        <div class="plan-image-area" id="evalPlanImageArea">
                <div class="tri-views" id="evalTriViews">
                    <div class="image-panel axial-view">
                        <div class="panel-header">
                            <span class="view-label">Axial</span>
                        </div>
                        <div class="image-container">
                            <div class="medical-image axial-image">
                                <div class="ct-background"></div>
                            </div>
                        </div>
                        <div class="panel-footer">
                            <span class="view-type">Axial</span>
                        </div>
                    </div>
                    <div class="bottom-views">
                        <div class="image-panel coronal-view">
                            <div class="panel-header">
                                <span class="view-label">Coronal</span>
                            </div>
                            <div class="image-container">
                                <div class="medical-image coronal-image">
                                    <div class="ct-background"></div>
                                </div>
                            </div>
                            <div class="panel-footer">
                                <span class="view-type">Coronal</span>
                            </div>
                        </div>
                        <div class="image-panel sagittal-view">
                            <div class="panel-header">
                                <span class="view-label">Sagittal</span>
                            </div>
                            <div class="image-container">
                                <div class="medical-image sagittal-image">
                                    <div class="ct-background"></div>
                                </div>
                            </div>
                            <div class="panel-footer">
                                <span class="view-type">Sagittal</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="split-resizer" id="evalImageResizer"></div>
                <div class="side-panel" id="evalSidePanel">
                    <div class="toggle-group" id="eval2d3dToggle">
                        <button class="toggle-btn active" data-mode="2d">2D</button>
                        <button class="toggle-btn" data-mode="3d">3D</button>
                    </div>
                    <div class="bev-dvh-section" style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
                        <div class="tabs" id="evalBevDvhTabs">
                            <button class="tab active" data-tab="bev">BEV视图</button>
                            <button class="tab" data-tab="dvh">DVH视图</button>
                        </div>
                        <div class="tab-panels">
                            <div class="tab-panel active" id="evalBevPanel">
                                <div id="evalBevViewContainer" style="width: 100%; height: 100%;"></div>
                            </div>
                            <div class="tab-panel" id="evalDvhPanel">
                                <div class="dvh-placeholder">DVH 预览</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

                        <!-- 底部面板：射束列表 / 临床目标 / 剂量统计 / 能量层 -->
                        <div class="plan-bottom-panel">
                            <div class="bottom-tabs" id="evalBottomTabs">
                                <button class="bottom-tab active" data-tab="beamList">射束列表</button>
                                <button class="bottom-tab" data-tab="clinicalTargets">临床目标</button>
                                <button class="bottom-tab" data-tab="doseStats">剂量统计</button>
                                <button class="bottom-tab" data-tab="energyLayers">能量层</button>
                            </div>
                            <div class="bottom-contents">
                                <div class="bottom-content active" id="evalBeamList">
                                    <div class="beam-table-container" id="evalBeamListContainer">射束列表内容</div>
                                </div>
                                <div class="bottom-content" id="evalClinicalTargets">
                                    <div class="clinical-targets-content">临床目标（占位）</div>
                                </div>
                    <div class="bottom-content" id="evalDoseStats">
                        <div class="dose-stats-container" id="evalDoseStatsContainer">
                            <div class="loading-indicator">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>加载剂量统计组件...</span>
                            </div>
                        </div>
                    </div>
                                <div class="bottom-content" id="evalEnergyLayers">
                                    <div class="energy-layers-content">能量层（占位）</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 计划对比视图 -->
                    <div class="plan-comparison-view" id="comparisonView">
                <!-- 两个计划的对比视图 -->
                <div class="comparison-main-container" id="twoPlansContainer">
                    <!-- 左侧：两个计划的对比视图 -->
                    <div class="comparison-plans-container" id="comparisonPlansContainer">
                        <!-- 计划1 -->
                        <div class="comparison-plan-item" id="comparisonPlan1">
                            <div class="comparison-plan-header">plan 1</div>
                            <div class="comparison-plan-views">
                                <div class="comparison-view-item">
                                    <div class="comparison-view-header">
                                        <span>Axial</span>
                                        <span id="plan1AxialInfo">-</span>
                                    </div>
                                    <div class="comparison-view-image">
                                        <canvas id="plan1AxialCanvas"></canvas>
                                        <div class="comparison-dose-legend" id="plan1AxialLegend"></div>
                                    </div>
                                </div>
                                <div class="comparison-view-item">
                                    <div class="comparison-view-header">
                                        <span>Sagittal</span>
                                        <span id="plan1SagittalInfo">-</span>
                                    </div>
                                    <div class="comparison-view-image">
                                        <canvas id="plan1SagittalCanvas"></canvas>
                                        <div class="comparison-dose-legend" id="plan1SagittalLegend"></div>
                                    </div>
                                </div>
                                <div class="comparison-view-item">
                                    <div class="comparison-view-header">
                                        <span>Coronal</span>
                                        <span id="plan1CoronalInfo">-</span>
                                    </div>
                                    <div class="comparison-view-image">
                                        <canvas id="plan1CoronalCanvas"></canvas>
                                        <div class="comparison-dose-legend" id="plan1CoronalLegend"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 计划2 -->
                        <div class="comparison-plan-item" id="comparisonPlan2">
                            <div class="comparison-plan-header">plan 2</div>
                            <div class="comparison-plan-views">
                                <div class="comparison-view-item">
                                    <div class="comparison-view-header">
                                        <span>Axial</span>
                                        <span id="plan2AxialInfo">-</span>
                                    </div>
                                    <div class="comparison-view-image">
                                        <canvas id="plan2AxialCanvas"></canvas>
                                        <div class="comparison-dose-legend" id="plan2AxialLegend"></div>
                                    </div>
                                </div>
                                <div class="comparison-view-item">
                                    <div class="comparison-view-header">
                                        <span>Sagittal</span>
                                        <span id="plan2SagittalInfo">-</span>
                                    </div>
                                    <div class="comparison-view-image">
                                        <canvas id="plan2SagittalCanvas"></canvas>
                                        <div class="comparison-dose-legend" id="plan2SagittalLegend"></div>
                                    </div>
                                </div>
                                <div class="comparison-view-item">
                                    <div class="comparison-view-header">
                                        <span>Coronal</span>
                                        <span id="plan2CoronalInfo">-</span>
                                    </div>
                                    <div class="comparison-view-image">
                                        <canvas id="plan2CoronalCanvas"></canvas>
                                        <div class="comparison-dose-legend" id="plan2CoronalLegend"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 分隔条 -->
                    <div class="comparison-resizer" id="comparisonMainResizer"></div>

                    <!-- 右侧：DVH和对比列表 -->
                    <div class="comparison-right-panel" id="comparisonRightPanel">
                        <!-- DVH和剂量差异视图 -->
                        <div class="comparison-dvh-container">
                            <div class="comparison-dvh-tabs">
                                <button class="comparison-dvh-tab active" data-panel="dvh">DVH</button>
                                <button class="comparison-dvh-tab" data-panel="doseDiff">剂量差异</button>
                            </div>
                            <div class="comparison-dvh-content">
                                <!-- DVH面板 -->
                                <div class="comparison-dvh-panel active" id="comparisonDvhPanel">
                                    <div class="comparison-dvh-panel-header">
                                        <span>DVH</span>
                                        <div class="comparison-dvh-controls">
                                            <label class="comparison-dvh-checkbox">
                                                <input type="checkbox" checked> smlc
                                            </label>
                                            <label class="comparison-dvh-checkbox">
                                                <input type="checkbox" checked> 3d
                                            </label>
                                        </div>
                                    </div>
                                    <div class="comparison-dvh-chart" id="comparisonDvhChart">
                                        <div class="comparison-dvh-placeholder">DVH图表将在这里显示</div>
                                    </div>
                                </div>
                                <!-- 剂量差异面板 -->
                                <div class="comparison-dvh-panel" id="comparisonDoseDiffPanel">
                                    <div class="comparison-dvh-panel-header">
                                        <span>剂量差异</span>
                                        <div class="comparison-dvh-controls">
                                            <label class="comparison-dvh-checkbox">
                                                <input type="checkbox" checked> smlc
                                            </label>
                                            <label class="comparison-dvh-checkbox">
                                                <input type="checkbox" checked> 3d
                                            </label>
                                        </div>
                                    </div>
                                    <div class="comparison-dvh-chart" id="comparisonDoseDiffChart">
                                        <div class="comparison-dvh-placeholder">剂量差异图表将在这里显示</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 对比列表 -->
                        <div class="comparison-list-container">
                            <div class="comparison-list-tabs">
                                <button class="comparison-list-tab active" data-tab="doseStats">剂量统计/对比</button>
                                <button class="comparison-list-tab" data-tab="clinicalTarget">临床目标</button>
                                <button class="comparison-list-tab" data-tab="beamList">射束列表</button>
                                <button class="comparison-list-tab" data-tab="energyLayer">能量层</button>
                            </div>
                            <div class="comparison-list-content">
                                <!-- 剂量统计/对比 -->
                                <div class="comparison-list-content-item active" id="comparisonDoseStats">
                                    <div class="dose-stats-container" id="comparisonDoseStatsContainer">
                                        <div class="loading-indicator">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            <span>加载剂量统计组件...</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- 临床目标 -->
                                <div class="comparison-list-content-item" id="comparisonClinicalTarget">
                                    <div style="color: #ddd; padding: 20px; text-align: center;">
                                        临床目标内容
                                    </div>
                                </div>
                                <!-- 射束列表 -->
                                <div class="comparison-list-content-item" id="comparisonBeamList">
                                    <div id="comparisonBeamListContainer" style="width: 100%; height: 100%;"></div>
                                </div>
                                <!-- 能量层 -->
                                <div class="comparison-list-content-item" id="comparisonEnergyLayer">
                                    <div style="color: #ddd; padding: 20px; text-align: center;">
                                        能量层内容
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 三个计划的对比视图 -->
                <div class="comparison-main-container" id="threePlansContainer" style="display: none;">
                    <!-- 顶部：三个计划的横截面 -->
                    <div class="comparison-three-plans-top">
                        <div class="comparison-three-plans-container" id="threePlansTopContainer">
                            <!-- 计划1 -->
                            <div class="comparison-plan-item single-view" id="threePlan1">
                                <div class="comparison-plan-header">plan 1</div>
                                <div class="comparison-plan-views">
                                    <div class="comparison-view-item">
                                        <div class="comparison-view-header">
                                            <span>Axial</span>
                                            <span id="threePlan1AxialInfo">-</span>
                                        </div>
                                        <div class="comparison-view-image">
                                            <canvas id="threePlan1AxialCanvas"></canvas>
                                            <div class="comparison-dose-legend" id="threePlan1AxialLegend"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- 计划2 -->
                            <div class="comparison-plan-item single-view" id="threePlan2">
                                <div class="comparison-plan-header">plan 2</div>
                                <div class="comparison-plan-views">
                                    <div class="comparison-view-item">
                                        <div class="comparison-view-header">
                                            <span>Axial</span>
                                            <span id="threePlan2AxialInfo">-</span>
                                        </div>
                                        <div class="comparison-view-image">
                                            <canvas id="threePlan2AxialCanvas"></canvas>
                                            <div class="comparison-dose-legend" id="threePlan2AxialLegend"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- 计划3 -->
                            <div class="comparison-plan-item single-view" id="threePlan3">
                                <div class="comparison-plan-header">plan 3</div>
                                <div class="comparison-plan-views">
                                    <div class="comparison-view-item">
                                        <div class="comparison-view-header">
                                            <span>Axial</span>
                                            <span id="threePlan3AxialInfo">-</span>
                                        </div>
                                        <div class="comparison-view-image">
                                            <canvas id="threePlan3AxialCanvas"></canvas>
                                            <div class="comparison-dose-legend" id="threePlan3AxialLegend"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 底部：左右分栏 -->
                    <div class="comparison-three-plans-bottom" id="threePlansBottomContainer">
                        <!-- 左侧：DVH -->
                        <div class="comparison-three-dvh-area">
                            <div class="comparison-dvh-container">
                                <div class="comparison-dvh-tabs">
                                    <button class="comparison-dvh-tab active" data-panel="dvh">DVH</button>
                                    <button class="comparison-dvh-tab" data-panel="doseDiff">剂量差异</button>
                                </div>
                                <div class="comparison-dvh-content">
                                    <!-- DVH面板 -->
                                    <div class="comparison-dvh-panel active" id="threePlansDvhPanel">
                                        <div class="comparison-dvh-panel-header">
                                            <span>DVH</span>
                                            <div class="comparison-dvh-controls">
                                                <label class="comparison-dvh-checkbox">
                                                    <input type="checkbox" checked id="threePlan1Checkbox"> plan 1
                                                </label>
                                                <label class="comparison-dvh-checkbox">
                                                    <input type="checkbox" checked id="threePlan2Checkbox"> plan 2
                                                </label>
                                                <label class="comparison-dvh-checkbox">
                                                    <input type="checkbox" checked id="threePlan3Checkbox"> plan 3
                                                </label>
                                            </div>
                                        </div>
                                        <div class="comparison-dvh-chart" id="threePlansDvhChart">
                                            <div class="comparison-dvh-placeholder">DVH图表将在这里显示</div>
                                        </div>
                                    </div>
                                    <!-- 剂量差异面板 -->
                                    <div class="comparison-dvh-panel" id="threePlansDoseDiffPanel">
                                        <div class="comparison-dvh-panel-header">
                                            <span>剂量差异</span>
                                            <div class="comparison-dvh-controls">
                                                <label class="comparison-dvh-checkbox">
                                                    <input type="checkbox" checked> smlc
                                                </label>
                                                <label class="comparison-dvh-checkbox">
                                                    <input type="checkbox" checked> 3d
                                                </label>
                                            </div>
                                        </div>
                                        <div class="comparison-dvh-chart" id="threePlansDoseDiffChart">
                                            <div class="comparison-dvh-placeholder">剂量差异图表将在这里显示</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 分隔条 -->
                        <div class="comparison-three-resizer" id="threePlansResizer"></div>

                        <!-- 右侧：对比列表 -->
                        <div class="comparison-three-list-area">
                            <div class="comparison-list-container">
                                <div class="comparison-list-tabs">
                                    <button class="comparison-list-tab active" data-tab="doseStats">剂量统计/对比</button>
                                    <button class="comparison-list-tab" data-tab="clinicalTarget">临床目标</button>
                                    <button class="comparison-list-tab" data-tab="beamList">射束列表</button>
                                    <button class="comparison-list-tab" data-tab="energyLayer">能量层</button>
                                </div>
                                <div class="comparison-list-content">
                                    <!-- 剂量统计/对比 -->
                                    <div class="comparison-list-content-item active" id="threePlansDoseStats">
                                        <div class="dose-stats-container" id="threePlansDoseStatsContainer">
                                            <div class="loading-indicator">
                                                <i class="fas fa-spinner fa-spin"></i>
                                                <span>加载剂量统计组件...</span>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 临床目标 -->
                                    <div class="comparison-list-content-item" id="threePlansClinicalTarget">
                                        <div style="color: #ddd; padding: 20px; text-align: center;">
                                            临床目标内容
                                        </div>
                                    </div>
                                    <!-- 射束列表 -->
                                    <div class="comparison-list-content-item" id="threePlansBeamList">
                                        <div id="threePlansBeamListContainer" style="width: 100%; height: 100%;"></div>
                                    </div>
                                    <!-- 能量层 -->
                                    <div class="comparison-list-content-item" id="threePlansEnergyLayer">
                                        <div style="color: #ddd; padding: 20px; text-align: center;">
                                            能量层内容
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                    </div>
                </div>

            </div>

            <!-- 右侧切换面板 -->
            <div class="right-switch-panel" id="rightSwitchPanel">
                <div class="switch-tabs">
                    <button class="switch-tab active" data-page="robustnessEvaluation">
                        <span class="switch-tab-text">鲁棒性评估</span>
                    </button>
                    <button class="switch-tab" data-page="planEvaluation">
                        <span class="switch-tab-text">计划评估</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 组件引用 -->
    <script src="../components/ROIComponent.js"></script>
    <script src="../components/POIComponent.js"></script>
    <script src="../components/ISOComponent.js"></script>
    <script src="../components/SequenceTreeComponent.js"></script>
    <script src="../components/RegistrationComponent.js"></script>
    <script src="../components/BeamListComponent.js"></script>
    <script src="../components/RobustComponent.js"></script>
    <script src="../components/DoseStatisticsComponent.js"></script>
    <script src="../components/PlanComparisonDoseStatisticsComponent.js"></script>
    <script src="../components/ThreePlansComparisonDoseStatisticsComponent.js"></script>

    <script>
        // 初始化计划评估模块的ISO组件
        function initEvalISOComponent() {
            const isoContainer = document.getElementById('evalIsoContainer');
            if (!isoContainer) return;
            
            // 检查是否已初始化
            if (isoContainer.dataset.inited === 'true') return;
            
            // 创建ISO组件实例
            if (window.ISOComponent) {
                try {
                    new ISOComponent('evalIsoContainer', {
                        prefix: 'eval-',
                        onISOSelect: function(isoName, element) {
                            console.log('计划评估ISO选择:', isoName);
                        },
                        onToolClick: function(buttonId, button) {
                            console.log('计划评估ISO工具点击:', buttonId);
                        }
                    });
                    isoContainer.dataset.inited = 'true';
                } catch (e) {
                    console.warn('初始化计划评估ISO组件失败:', e);
                }
            } else {
                console.warn('ISOComponent 尚未加载');
            }
        }

        // 初始化左侧面板导航
        function initializeEvalNavButtons() {
            // 计划评估导航按钮
            const planNavButtons = document.querySelectorAll('#planEvaluationNav .nav-btn');
            const panelSections = document.querySelectorAll('#evalLeftPanel .panel-section');
            
            planNavButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const panelId = btn.getAttribute('data-panel');
                    
                    // 移除所有active类
                    planNavButtons.forEach(b => b.classList.remove('active'));
                    panelSections.forEach(s => s.classList.remove('active'));
                    
                    // 添加active类到当前按钮和面板
                    btn.classList.add('active');
                    const targetPanel = document.getElementById(panelId + '-panel');
                    if (targetPanel) {
                        targetPanel.classList.add('active');
                        
                        // 根据面板类型动态加载组件
                        if (panelId === 'eval-iso') {
                            initEvalISOComponent();
                        }
                    }
                });
            });
            
            // 鲁棒性评估导航按钮
            const robustNavButtons = document.querySelectorAll('#robustnessEvaluationNav .nav-btn');
            
            robustNavButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const panelId = btn.getAttribute('data-panel');
                    
                    // 移除所有active类
                    robustNavButtons.forEach(b => b.classList.remove('active'));
                    panelSections.forEach(s => s.classList.remove('active'));
                    
                    // 添加active类到当前按钮和面板
                    btn.classList.add('active');
                    const targetPanel = document.getElementById(panelId + '-panel');
                    if (targetPanel) {
                        targetPanel.classList.add('active');
                        
                        // 根据面板类型动态加载组件
                        if (panelId === 'robust-sequence') {
                            initRobustSequenceComponent();
                        } else if (panelId === 'robust-robust') {
                            initRobustRobustComponent();
                        } else if (panelId === 'robust-roi') {
                            initRobustRoiComponent();
                        } else if (panelId === 'robust-poi') {
                            initRobustPoiComponent();
                        }
                    }
                });
            });
        }

        // 初始化左侧面板折叠功能
        function initializeEvalLeftPanelToggle() {
            const toggleBtn = document.getElementById('evalLeftPanelToggle');
            const leftPanel = document.getElementById('evalLeftPanel');
            const planToolbar = document.getElementById('planEvaluationToolbar');
            const robustnessToolbar = document.getElementById('robustnessEvaluationToolbar');

            if (toggleBtn && leftPanel) {
                toggleBtn.addEventListener('click', () => {
                    leftPanel.classList.toggle('collapsed');
                    const icon = toggleBtn.querySelector('i');
                    if (leftPanel.classList.contains('collapsed')) {
                        icon.classList.remove('fa-chevron-left');
                        icon.classList.add('fa-chevron-right');
                    } else {
                        icon.classList.remove('fa-chevron-right');
                        icon.classList.add('fa-chevron-left');
                    }
                });
            }
        }

        // 初始化左侧面板拖拽调整宽度
        function initializeEvalLeftPanelResizer() {
            const resizer = document.getElementById('evalResizerHandle');
            const leftPanel = document.getElementById('evalLeftPanel');
            const planToolbar = document.getElementById('planEvaluationToolbar');
            const robustnessToolbar = document.getElementById('robustnessEvaluationToolbar');

            if (!resizer || !leftPanel) return;

            let isResizing = false;
            let startX = 0;
            let startWidth = 0;

            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                startX = e.clientX;
                startWidth = leftPanel.getBoundingClientRect().width;
                document.addEventListener('mousemove', handleResize);
                document.addEventListener('mouseup', stopResize);
                e.preventDefault();
            });

            function handleResize(e) {
                if (!isResizing) return;
                const deltaX = e.clientX - startX;
                const newWidth = startWidth + deltaX;
                const minWidth = 200;
                const maxWidth = 600;
                
                if (newWidth >= minWidth && newWidth <= maxWidth) {
                    leftPanel.style.width = newWidth + 'px';
                    if (planToolbar) {
                        planToolbar.style.left = newWidth + 'px';
                        planToolbar.style.width = `calc(100vw - ${newWidth}px - 60px)`;
                    }
                    if (robustnessToolbar) {
                        robustnessToolbar.style.left = newWidth + 'px';
                        robustnessToolbar.style.width = `calc(100vw - ${newWidth}px - 60px)`;
                    }
                }
            }

            function stopResize() {
                isResizing = false;
                document.removeEventListener('mousemove', handleResize);
                document.removeEventListener('mouseup', stopResize);
            }
        }

        // 初始化2D/3D切换
        function initializeEval2d3dToggle() {
            const toggle = document.getElementById('eval2d3dToggle');
            if (!toggle) return;

            const buttons = toggle.querySelectorAll('.toggle-btn');
            buttons.forEach(btn => {
                btn.addEventListener('click', () => {
                    buttons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const mode = btn.getAttribute('data-mode');
                    console.log('切换到', mode, '模式');
                });
            });
        }

        // 初始化右侧切换面板
        function initializeRightSwitchPanel() {
            const switchTabs = document.querySelectorAll('.switch-tab');
            const subPages = document.querySelectorAll('.evaluation-sub-page');
            const planEvaluationNav = document.getElementById('planEvaluationNav');
            const robustnessEvaluationNav = document.getElementById('robustnessEvaluationNav');
            const planEvaluationToolbar = document.getElementById('planEvaluationToolbar');
            const robustnessEvaluationToolbar = document.getElementById('robustnessEvaluationToolbar');
            
            switchTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetPage = tab.getAttribute('data-page');
                    
                    // 移除所有active类
                    switchTabs.forEach(t => t.classList.remove('active'));
                    subPages.forEach(p => p.classList.remove('active'));
                    
                    // 添加active类
                    tab.classList.add('active');
                    const targetSubPage = document.getElementById(targetPage + 'Page');
                    if (targetSubPage) {
                        targetSubPage.classList.add('active');
                    }
                    
                    // 切换左侧导航按钮和默认面板
                    const panelSections = document.querySelectorAll('#evalLeftPanel .panel-section');
                    panelSections.forEach(s => s.classList.remove('active'));
                    
                    if (targetPage === 'planEvaluation') {
                        if (planEvaluationNav) planEvaluationNav.style.display = 'flex';
                        if (robustnessEvaluationNav) robustnessEvaluationNav.style.display = 'none';
                        if (planEvaluationToolbar) planEvaluationToolbar.style.display = 'flex';
                        if (robustnessEvaluationToolbar) robustnessEvaluationToolbar.style.display = 'none';
                        
                        // 激活计划评估的默认面板
                        const defaultPlanPanel = document.getElementById('eval-sequence-panel');
                        if (defaultPlanPanel) {
                            defaultPlanPanel.classList.add('active');
                        }
                        // 激活计划评估的默认导航按钮
                        const defaultPlanNav = planEvaluationNav?.querySelector('[data-panel="eval-sequence"]');
                        if (defaultPlanNav) {
                            planEvaluationNav.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                            defaultPlanNav.classList.add('active');
                        }
                    } else if (targetPage === 'robustnessEvaluation') {
                        if (planEvaluationNav) planEvaluationNav.style.display = 'none';
                        if (robustnessEvaluationNav) robustnessEvaluationNav.style.display = 'flex';
                        if (planEvaluationToolbar) planEvaluationToolbar.style.display = 'none';
                        if (robustnessEvaluationToolbar) robustnessEvaluationToolbar.style.display = 'flex';
                        
                        // 激活鲁棒性评估的默认面板
                        const defaultRobustPanel = document.getElementById('robust-sequence-panel');
                        if (defaultRobustPanel) {
                            defaultRobustPanel.classList.add('active');
                        }
                        // 激活鲁棒性评估的默认导航按钮
                        const defaultRobustNav = robustnessEvaluationNav?.querySelector('[data-panel="robust-sequence"]');
                        if (defaultRobustNav) {
                            robustnessEvaluationNav.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                            defaultRobustNav.classList.add('active');
                        }
                    }
                });
            });
            
            // 初始化时设置默认显示（鲁棒性评估页面）
            if (planEvaluationNav) planEvaluationNav.style.display = 'none';
            if (robustnessEvaluationNav) robustnessEvaluationNav.style.display = 'flex';
            if (planEvaluationToolbar) planEvaluationToolbar.style.display = 'none';
            if (robustnessEvaluationToolbar) robustnessEvaluationToolbar.style.display = 'flex';
            
            // 设置默认激活的面板和导航按钮
            const panelSections = document.querySelectorAll('#evalLeftPanel .panel-section');
            panelSections.forEach(s => s.classList.remove('active'));
            const defaultRobustPanel = document.getElementById('robust-sequence-panel');
            if (defaultRobustPanel) {
                defaultRobustPanel.classList.add('active');
                // 初始化序列树组件
                setTimeout(() => {
                    initRobustSequenceComponent();
                }, 100);
            }
            const defaultRobustNav = robustnessEvaluationNav?.querySelector('[data-panel="robust-sequence"]');
            if (defaultRobustNav && robustnessEvaluationNav) {
                robustnessEvaluationNav.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                defaultRobustNav.classList.add('active');
            }
        }

        // 初始化鲁棒性评估右侧标签切换（临床目标/射束列表）
        function initializeRobustnessRightTabs() {
            const rightTabs = document.querySelectorAll('.robustness-right-tab');
            const rightTabContents = document.querySelectorAll('.robustness-right-tab-content');
            
            rightTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.getAttribute('data-tab');
                    
                    // 移除所有active类
                    rightTabs.forEach(t => t.classList.remove('active'));
                    rightTabContents.forEach(c => c.classList.remove('active'));
                    
                    // 添加active类
                    tab.classList.add('active');
                    const targetContent = document.getElementById('robustness' + targetTab.charAt(0).toUpperCase() + targetTab.slice(1));
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                });
            });
        }

        // 初始化鲁棒性评估视图拖拽调整大小
        function initializeRobustnessViewResizers() {
            const viewsContainer = document.querySelector('.robustness-2d-views');
            const horizontalResizer = document.getElementById('robustnessHorizontalResizer');
            const verticalResizer = document.getElementById('robustnessVerticalResizer');
            const mainView = document.querySelector('.robustness-2d-view-main');
            const rightViews = document.querySelector('.robustness-2d-views-right');
            const coronalView = document.querySelector('.robustness-2d-views-right .coronal-view');
            const sagittalView = document.querySelector('.robustness-2d-views-right .sagittal-view');

            if (!viewsContainer || !horizontalResizer || !verticalResizer) return;

            let isHorizontalResizing = false;
            let isVerticalResizing = false;
            let startX = 0;
            let startY = 0;
            let startMainWidth = 0;
            let startCoronalHeight = 0;

            // 水平分隔条（调整左右视图）
            horizontalResizer.addEventListener('mousedown', (e) => {
                isHorizontalResizing = true;
                startX = e.clientX;
                startMainWidth = mainView.getBoundingClientRect().width;
                viewsContainer.classList.add('resizing');
                document.addEventListener('mousemove', handleHorizontalResize);
                document.addEventListener('mouseup', stopHorizontalResize);
                e.preventDefault();
            });

            function handleHorizontalResize(e) {
                if (!isHorizontalResizing) return;
                const deltaX = e.clientX - startX;
                const containerWidth = viewsContainer.getBoundingClientRect().width;
                const newMainWidth = startMainWidth + deltaX;
                const minMainWidth = containerWidth * 0.3;
                const maxMainWidth = containerWidth * 0.8;
                
                if (newMainWidth >= minMainWidth && newMainWidth <= maxMainWidth) {
                    const mainWidthPercent = (newMainWidth / containerWidth) * 100;
                    const rightWidthPercent = 100 - mainWidthPercent;
                    mainView.style.flex = `0 0 ${mainWidthPercent}%`;
                    rightViews.style.flex = `0 0 ${rightWidthPercent}%`;
                }
            }

            function stopHorizontalResize() {
                isHorizontalResizing = false;
                viewsContainer.classList.remove('resizing');
                document.removeEventListener('mousemove', handleHorizontalResize);
                document.removeEventListener('mouseup', stopHorizontalResize);
            }

            // 垂直分隔条（调整上下视图）
            verticalResizer.addEventListener('mousedown', (e) => {
                isVerticalResizing = true;
                startY = e.clientY;
                startCoronalHeight = coronalView.getBoundingClientRect().height;
                viewsContainer.classList.add('resizing');
                document.addEventListener('mousemove', handleVerticalResize);
                document.addEventListener('mouseup', stopVerticalResize);
                e.preventDefault();
            });

            function handleVerticalResize(e) {
                if (!isVerticalResizing) return;
                const deltaY = e.clientY - startY;
                const containerHeight = rightViews.getBoundingClientRect().height;
                const newCoronalHeight = startCoronalHeight + deltaY;
                const minHeight = containerHeight * 0.2;
                const maxHeight = containerHeight * 0.8;
                
                if (newCoronalHeight >= minHeight && newCoronalHeight <= maxHeight) {
                    const coronalHeightPercent = (newCoronalHeight / containerHeight) * 100;
                    const sagittalHeightPercent = 100 - coronalHeightPercent;
                    coronalView.style.flex = `0 0 ${coronalHeightPercent}%`;
                    sagittalView.style.flex = `0 0 ${sagittalHeightPercent}%`;
                }
            }

            function stopVerticalResize() {
                isVerticalResizing = false;
                viewsContainer.classList.remove('resizing');
                document.removeEventListener('mousemove', handleVerticalResize);
                document.removeEventListener('mouseup', stopVerticalResize);
            }
        }

        // 初始化场景列表表格数据
        function renderScenarioTable() {
            const tbody = document.getElementById('scenarioTableBody');
            if (!tbody) return;
            
            // 模拟数据（根据图片描述）
            const scenarios = [
                { no: 1, rl: 0.3, is: 0, pa: 0, density: 3.5 },
                { no: 2, rl: 0, is: 0, pa: -0.3, density: 3.5 },
                { no: 3, rl: 0, is: 0, pa: 0.3, density: 3.5 },
                { no: 4, rl: 0.3, is: 0, pa: -0.3, density: 3.5 },
                { no: 5, rl: 0.3, is: 0, pa: 0.3, density: 3.5 },
                { no: 6, rl: 0, is: -0.3, pa: 0, density: 3.5 },
                { no: 7, rl: 0, is: 0.3, pa: 0, density: 3.5 },
                { no: 8, rl: 0.3, is: -0.3, pa: 0, density: 3.5 },
                { no: 9, rl: 0.3, is: 0.3, pa: 0, density: 3.5 },
                { no: 10, rl: 0, is: -0.3, pa: -0.3, density: 3.5 },
                { no: 11, rl: 0, is: -0.3, pa: 0.3, density: 3.5 },
                { no: 12, rl: 0, is: 0.3, pa: -0.3, density: 3.5 },
                { no: 13, rl: 0, is: 0.3, pa: 0.3, density: 3.5 },
                { no: 14, rl: 0.3, is: -0.3, pa: -0.3, density: 3.5 },
                { no: 15, rl: 0.3, is: -0.3, pa: 0.3, density: 3.5 }
            ];
            
            tbody.innerHTML = scenarios.map(scenario => `
                <tr>
                    <td>${scenario.no}</td>
                    <td>${scenario.rl}</td>
                    <td>${scenario.is}</td>
                    <td>${scenario.pa}</td>
                    <td>${scenario.density}</td>
                </tr>
            `).join('');
        }

        // 渲染场景列表表格
        function renderRobustnessScenarios() {
            const tbody = document.getElementById('scenarioTableBody');
            if (!tbody) return;
            
            // 生成21行数据（根据图片描述）
            const scenarios = [];
            const densityPattern = ['3.5', '-3.5', '0']; // 每3行循环
            
            for (let i = 1; i <= 21; i++) {
                let rl, is, pa;
                
                // R-L列：前3行0.20，4-6行-0.30，7-21行0.00
                if (i <= 3) {
                    rl = '0.20';
                } else if (i <= 6) {
                    rl = '-0.30';
                } else {
                    rl = '0.00';
                }
                
                // I-S列：1-6行0.00，7-9行0.30，10-12行-0.30，13-21行0.00
                if (i <= 6) {
                    is = '0.00';
                } else if (i <= 9) {
                    is = '0.30';
                } else if (i <= 12) {
                    is = '-0.30';
                } else {
                    is = '0.00';
                }
                
                // P-A列：1-12行0.00，13-15行0.30，16-18行-0.30，19-21行0.00
                if (i <= 12) {
                    pa = '0.00';
                } else if (i <= 15) {
                    pa = '0.30';
                } else if (i <= 18) {
                    pa = '-0.30';
                } else {
                    pa = '0.00';
                }
                
                // 密度不确定性%：每3行循环 3.5, -3.5, 0
                const density = densityPattern[(i - 1) % 3];
                
                scenarios.push({ no: i, rl, is, pa, density });
            }
            
            tbody.innerHTML = scenarios.map((scenario, index) => {
                const isHighlighted = index < 3 ? 'highlighted' : '';
                return `
                <tr data-scenario="${scenario.no}" class="${isHighlighted}">
                    <td>${scenario.no}</td>
                    <td>${scenario.rl}</td>
                    <td>${scenario.is}</td>
                    <td>${scenario.pa}</td>
                    <td>${scenario.density}</td>
                    <td>
                        <button class="scenario-delete-btn" data-scenario="${scenario.no}" title="删除">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
            `;
            }).join('');
            
            // 绑定场景选择事件（点击行，但不包括删除按钮）
            tbody.querySelectorAll('tr').forEach(tr => {
                tr.addEventListener('click', function(e) {
                    // 如果点击的是删除按钮，不触发选择
                    if (e.target.closest('.scenario-delete-btn')) {
                        return;
                    }
                    
                    tbody.querySelectorAll('tr').forEach(r => r.classList.remove('selected'));
                    this.classList.add('selected');
                    const scenarioNo = this.dataset.scenario;
                    const currentScenarioEl = document.getElementById('robustnessCurrentScenario');
                    if (currentScenarioEl) {
                        currentScenarioEl.textContent = `场景: ${String(scenarioNo).padStart(2, '0')}/21`;
                    }
                    // TODO: 更新视图数据
                });
            });
            
            // 绑定删除按钮事件
            tbody.querySelectorAll('.scenario-delete-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation(); // 阻止事件冒泡
                    const scenarioNo = this.dataset.scenario;
                    if (confirm(`确定要删除场景 ${scenarioNo} 吗？`)) {
                        // TODO: 实现删除逻辑
                        const row = this.closest('tr');
                        if (row) {
                            row.remove();
                            // 更新场景总数显示
                            const remainingRows = tbody.querySelectorAll('tr').length;
                            const currentScenarioEl = document.getElementById('robustnessCurrentScenario');
                            if (currentScenarioEl) {
                                currentScenarioEl.textContent = `场景: 01/${remainingRows}`;
                            }
                        }
                    }
                });
            });
        }

        // 初始化场景列表显隐列功能
        function initializeScenarioColumnToggle() {
            const toggleBtn = document.getElementById('scenarioColumnToggleBtn');
            const columnMenu = document.getElementById('scenarioColumnMenu');
            const checkboxes = columnMenu?.querySelectorAll('input[type="checkbox"]');
            
            if (!toggleBtn || !columnMenu || !checkboxes) return;
            
            // 列索引映射
            const columnMap = {
                'no': 0,
                'rl': 1,
                'is': 2,
                'pa': 3,
                'density': 4,
                'operation': 5
            };
            
            // 切换菜单显示
            toggleBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                const isVisible = columnMenu.style.display !== 'none';
                columnMenu.style.display = isVisible ? 'none' : 'block';
            });
            
            // 点击外部关闭菜单
            document.addEventListener('click', function(e) {
                if (!columnMenu.contains(e.target) && !toggleBtn.contains(e.target)) {
                    columnMenu.style.display = 'none';
                }
            });
            
            // 处理复选框变化
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const columnName = this.dataset.column;
                    const columnIndex = columnMap[columnName];
                    
                    if (columnIndex !== undefined) {
                        // 隐藏/显示表头
                        const table = document.querySelector('.scenario-table');
                        if (table) {
                            const headerCell = table.querySelector(`thead th:nth-child(${columnIndex + 1})`);
                            const bodyCells = table.querySelectorAll(`tbody td:nth-child(${columnIndex + 1})`);
                            
                            if (this.checked) {
                                headerCell?.classList.remove('hidden');
                                bodyCells.forEach(cell => cell.classList.remove('hidden'));
                            } else {
                                headerCell?.classList.add('hidden');
                                bodyCells.forEach(cell => cell.classList.add('hidden'));
                            }
                        }
                    }
                });
            });
        }

        // 渲染鲁棒性评估临床目标表格
        function renderRobustnessClinicalTargets() {
            const tbody = document.getElementById('robustnessBottomClinicalTargetsBody');
            if (!tbody) return;
            
            // 模拟数据（根据图片描述）
            const clinicalTargets = [
                { color: '#ff0000', poi: 'Hippocampus_R', type: 'PTV', target: 'D95%≥3600cGy', passRate: '11/12', actual: '5830', worst: '5830', best: '600' },
                { color: '#00ff00', poi: 'TemporalLobe_withHi...', type: 'EXTERNAL', target: 'D95%≥3600cGy', passRate: '12/12', actual: '5830', worst: '5830', best: '600' },
                { color: '#0000ff', poi: 'Mastoid_L', type: 'EXTERNAL', target: 'D95%≥3600cGy', passRate: '11/12', actual: '5830', worst: '5830', best: '600' },
                { color: '#ffff00', poi: 'InnerEar_L', type: 'EXTERNAL', target: 'D95%≥3600cGy', passRate: '12/12', actual: '5830', worst: '5830', best: '600' },
                { color: '#ff00ff', poi: 'Eye_L', type: '内容信息', target: 'D95%≥3600cGy', passRate: '11/12', actual: '5830', worst: '5830', best: '600' },
                { color: '#00ffff', poi: 'PharyngealConstrictor', type: '内容信息', target: 'D95%≥3600cGy', passRate: '12/12', actual: '5830', worst: '5830', best: '600' }
            ];
            
            // 将通过率从 "11/12" 格式转换为百分比
            function convertPassRateToPercent(passRate) {
                const parts = passRate.split('/');
                if (parts.length === 2) {
                    const passed = parseInt(parts[0]);
                    const total = parseInt(parts[1]);
                    if (total > 0) {
                        return ((passed / total) * 100).toFixed(1) + '%';
                    }
                }
                return passRate;
            }
            
            tbody.innerHTML = clinicalTargets.map(item => `
                <tr>
                    <td><div style="width: 16px; height: 16px; background: ${item.color}; border-radius: 2px;"></div></td>
                    <td>${item.poi}</td>
                    <td>${item.type}</td>
                    <td>${item.target}</td>
                    <td>${item.actual}</td>
                    <td>${convertPassRateToPercent(item.passRate)}</td>
                    <td>${item.best}</td>
                    <td>${item.worst}</td>
                </tr>
            `).join('');
        }

        // 初始化BEV/DVH标签切换
        function initializeEvalBevDvhTabs() {
            const tabs = document.getElementById('evalBevDvhTabs');
            if (!tabs) return;

            const tabButtons = tabs.querySelectorAll('.tab');
            const panels = {
                bev: document.getElementById('evalBevPanel'),
                dvh: document.getElementById('evalDvhPanel')
            };

            tabButtons.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabButtons.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    Object.values(panels).forEach(p => p && p.classList.remove('active'));
                    const key = tab.getAttribute('data-tab');
                    if (panels[key]) {
                        panels[key].classList.add('active');
                        
                        // 如果是BEV视图，初始化BEV组件
                        if (key === 'bev') {
                            setTimeout(() => {
                                if (typeof initializePlanEvaluationBEVView === 'function') {
                                    initializePlanEvaluationBEVView();
                                }
                            }, 50);
                        }
                    }
                });
            });
        }

        // 初始化底部标签切换
        function initializeEvalBottomTabs() {
            const tabs = document.getElementById('evalBottomTabs');
            if (!tabs) return;

            const tabButtons = tabs.querySelectorAll('.bottom-tab');
            const contents = {
                beamList: document.getElementById('evalBeamList'),
                clinicalTargets: document.getElementById('evalClinicalTargets'),
                doseStats: document.getElementById('evalDoseStats'),
                energyLayers: document.getElementById('evalEnergyLayers')
            };

            tabButtons.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabButtons.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    Object.values(contents).forEach(c => c && c.classList.remove('active'));
                    const key = tab.getAttribute('data-tab');
                    if (contents[key]) {
                        contents[key].classList.add('active');
                        
                        // 初始化剂量统计组件
                        if (key === 'doseStats') {
                            initEvalDoseStatsComponent();
                        }
                    }
                });
            });
        }

        // 初始化鲁棒性评估底部标签
        function initializeRobustnessBottomTabs() {
            const tabButtons = document.querySelectorAll('.robustness-bottom-tab');
            const tabContents = document.querySelectorAll('.robustness-bottom-tab-content');

            if (tabButtons.length === 0) return;

            tabButtons.forEach(tab => {
                tab.addEventListener('click', () => {
                    // 移除所有激活状态
                    tabButtons.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));

                    // 激活当前标签
                    tab.classList.add('active');

                    // 显示对应内容
                    const targetTab = tab.getAttribute('data-tab');
                    if (targetTab === 'robustnessClinicalTargets') {
                        const content = document.getElementById('robustnessBottomClinicalTargets');
                        if (content) content.classList.add('active');
                    } else if (targetTab === 'robustnessBeamList') {
                        const content = document.getElementById('robustnessBottomBeamList');
                        if (content) content.classList.add('active');
                    }
                });
            });
        }

        // 剂量统计组件实例
        let evalDoseStatsComponent = null;

        // 初始化剂量统计组件
        function initEvalDoseStatsComponent() {
            const container = document.getElementById('evalDoseStatsContainer');
            if (!container) return;

            // 如果已经初始化，直接返回
            if (container.dataset.inited === 'true') {
                return;
            }

            if (typeof DoseStatisticsComponent === 'undefined') {
                console.error('DoseStatisticsComponent is not loaded');
                return;
            }

            try {
                evalDoseStatsComponent = new DoseStatisticsComponent('evalDoseStatsContainer', {
                    showDoseType: false, // 计划评估模块不显示剂量类型列
                    getGlobalStats: () => {
                        // TODO: 从实际数据源获取全局统计
                        return [
                            {
                                id: 'maxDose1',
                                visible: true,
                                color: '#ff0000',
                                statisticItem: '最大剂量点',
                                relativeDosePercentage: 112.31,
                                targetDose: 4500.00,
                                dose: 5054.15,
                                x: 4.34,
                                y: -1.97,
                                z: 0.00
                            }
                        ];
                    },
                    getRoiStats: () => {
                        // TODO: 从实际数据源获取ROI统计
                        // 应该从左侧ROI列表获取ROI信息
                        return [
                            {
                                name: 'p_r10',
                                color: '#ff00ff',
                                volume: 156.58,
                                minDose: 0.00,
                                maxDose: 27231.49,
                                avgDose: 10366.65,
                                targetDose: null,
                                targetDoseCoverageVolume: null,
                                targetDoseCoverageRatio: null
                            },
                            {
                                name: 'p_r20',
                                color: '#90ee90',
                                volume: 178.69,
                                minDose: 0.00,
                                maxDose: 21334.88,
                                avgDose: 6696.54,
                                targetDose: null,
                                targetDoseCoverageVolume: null,
                                targetDoseCoverageRatio: null
                            }
                        ];
                    },
                    getPoiStats: () => {
                        // TODO: 从实际数据源获取POI统计
                        // 应该从左侧POI列表获取POI信息
                        return [
                            {
                                name: 'Point1',
                                color: '#ff0000',
                                dose: 15576.95,
                                x: 11.40,
                                y: -0.25,
                                z: 23.03
                            },
                            {
                                name: 'Point2',
                                color: '#ff0000',
                                dose: 15576.95,
                                x: 11.40,
                                y: -0.25,
                                z: 23.03
                            }
                        ];
                    },
                    onExport: (data) => {
                        // TODO: 实现Excel导出功能
                        console.log('导出剂量统计:', data);
                        evalDoseStatsComponent.defaultExportToExcel({
                            planName: 'PlanA',
                            patientId: 'Y87342987',
                            patientName: 'Zhangguang',
                            comparisonMode: null
                        });
                    }
                });

                container.dataset.inited = 'true';
            } catch (error) {
                console.error('Failed to initialize DoseStatisticsComponent:', error);
            }
        }

        // 初始化中央区域左右分割拖拽
        function initializeEvalImageSplitter() {
            const container = document.getElementById('evalPlanImageArea');
            const resizer = document.getElementById('evalImageResizer');
            const left = document.getElementById('evalTriViews');
            const right = document.getElementById('evalSidePanel');

            if (!container || !resizer || !left || !right) return;

            let isResizing = false;
            let startX = 0;
            let containerWidth = 0;
            let startLeftWidth = 0;
            const minPercent = 20;
            const maxPercent = 80;

            const onMouseDown = (e) => {
                isResizing = true;
                startX = e.clientX;
                containerWidth = container.getBoundingClientRect().width;
                startLeftWidth = left.getBoundingClientRect().width;
                container.classList.add('resizing');
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
                e.preventDefault();
            };

            const onMouseMove = (e) => {
                if (!isResizing) return;
                const delta = e.clientX - startX;
                const newLeft = startLeftWidth + delta;
                let percent = (newLeft / containerWidth) * 100;
                if (percent < minPercent) percent = minPercent;
                if (percent > maxPercent) percent = maxPercent;
                left.style.flex = `0 0 ${percent}%`;
                right.style.flex = `0 0 ${100 - percent}%`;
            };

            const onMouseUp = () => {
                isResizing = false;
                container.classList.remove('resizing');
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            };

            resizer.addEventListener('mousedown', onMouseDown);
        }

        // 初始化组件加载
        // 初始化鲁棒性评估序列树组件
        function initRobustSequenceComponent() {
            const sequenceContainer = document.getElementById('robustSequenceContainer');
            if (!sequenceContainer) return;
            
            // 检查是否已初始化
            if (sequenceContainer.dataset.inited === 'true') return;
            
            // 检查组件是否已加载
            if (window.SequenceTreeComponent) {
                try {
                    new SequenceTreeComponent('robustSequenceContainer', {
                        prefix: 'robust-',
                        onSequenceSelect: function(sequenceName, element) {
                            console.log('鲁棒性评估序列选择:', sequenceName);
                        },
                        onFileSelect: function(fileName, element) {
                            console.log('鲁棒性评估文件选择:', fileName);
                        },
                        showFileInfo: true
                    });
                    sequenceContainer.dataset.inited = 'true';
                } catch (e) {
                    console.warn('初始化鲁棒性评估序列树组件失败:', e);
                }
            } else {
                console.warn('SequenceTreeComponent 尚未加载');
            }
        }

        // 初始化鲁棒性评估ROBUST组件
        function initRobustRobustComponent() {
            const robustContainer = document.getElementById('robustRobustContainer');
            if (!robustContainer) return;
            
            // 检查是否已初始化
            if (robustContainer.dataset.inited === 'true') return;
            
            // 检查组件是否已加载
            if (window.RobustComponent) {
                try {
                    new RobustComponent('robustRobustContainer', {
                        prefix: 'robust-',
                        onGroupSelect: function(group) {
                            console.log('鲁棒性评估组选择:', group);
                        },
                        onGroupReevaluate: function(group, shouldReevaluate) {
                            console.log('重新评估:', group.name, shouldReevaluate);
                            // 这里可以调用实际的评估逻辑
                        },
                        onGroupEdit: function(group, nameChanged, paramsChanged) {
                            console.log('编辑评估组:', group, nameChanged, paramsChanged);
                        },
                        onGroupDelete: function(group) {
                            console.log('删除评估组:', group);
                        },
                        onGroupSaveTemplate: function(group, templateName) {
                            console.log('保存模板:', group, templateName);
                        },
                        getCurrentPlan: function() {
                            // 获取当前计划信息
                            return {
                                id: 'current-plan',
                                name: '当前计划'
                            };
                        }
                    });
                    robustContainer.dataset.inited = 'true';
                } catch (error) {
                    console.error('初始化鲁棒性评估ROBUST组件失败:', error);
                }
            } else {
                console.warn('RobustComponent 尚未加载');
            }
        }

        // 初始化鲁棒性评估ROI组件
        function initRobustRoiComponent() {
            const roiContainer = document.getElementById('robustRoiContainer');
            if (!roiContainer) return;
            
            // 检查是否已初始化
            if (roiContainer.dataset.inited === 'true') return;
            
            // 检查组件是否已加载
            if (window.ROIComponent) {
                try {
                    new ROIComponent('robustRoiContainer', {
                        prefix: 'robust-',
                        onROISelect: function(roiName, element) {
                            console.log('鲁棒性评估ROI选择:', roiName);
                        },
                        onToolClick: function(buttonId, button) {
                            console.log('鲁棒性评估ROI工具点击:', buttonId);
                        }
                    });
                    roiContainer.dataset.inited = 'true';
                } catch (error) {
                    console.error('初始化鲁棒性评估ROI组件失败:', error);
                }
            } else {
                console.warn('ROIComponent 尚未加载');
            }
        }

        // 初始化鲁棒性评估POI组件
        function initRobustPoiComponent() {
            const poiContainer = document.getElementById('robustPoiContainer');
            if (!poiContainer) return;
            
            // 检查是否已初始化
            if (poiContainer.dataset.inited === 'true') return;
            
            // 检查组件是否已加载
            if (window.POIComponent) {
                try {
                    new POIComponent('robustPoiContainer', {
                        prefix: 'robust-',
                        onPOISelect: function(poiName, element) {
                            console.log('鲁棒性评估POI选择:', poiName);
                        },
                        onToolClick: function(buttonId, button) {
                            console.log('鲁棒性评估POI工具点击:', buttonId);
                        }
                    });
                    poiContainer.dataset.inited = 'true';
                } catch (error) {
                    console.error('初始化鲁棒性评估POI组件失败:', error);
                }
            } else {
                console.warn('POIComponent 尚未加载');
            }
        }

        function initializeEvalComponents() {
            // 序列树组件
            if (window.SequenceTreeComponent) {
                const sequenceContainer = document.getElementById('evalSequenceContainer');
                if (sequenceContainer) {
                    new SequenceTreeComponent('evalSequenceContainer', {
                        prefix: 'eval-',
                        onSequenceSelect: function(sequenceName, element) {
                            console.log('序列选择:', sequenceName);
                        },
                        onFileSelect: function(fileName, element) {
                            console.log('文件选择:', fileName);
                        },
                        showFileInfo: true
                    });
                }
            }

            // ROI组件
            if (window.ROIComponent) {
                const roiContainer = document.getElementById('evalRoiContainer');
                if (roiContainer) {
                    new ROIComponent('evalRoiContainer', {
                        prefix: 'eval-'
                    });
                }
            }

            // POI组件
            if (window.POIComponent) {
                const poiContainer = document.getElementById('evalPoiContainer');
                if (poiContainer) {
                    new POIComponent('evalPoiContainer', {
                        prefix: 'eval-'
                    });
                }
            }

            // 配准组件
            if (window.RegistrationComponent) {
                const regContainer = document.getElementById('evalRegistrationContainer');
                if (regContainer) {
                    new RegistrationComponent('evalRegistrationContainer', {
                        prefix: 'eval-',
                        onRegistrationSelect: function(registrationId, element) {
                            console.log('配准选择:', registrationId);
                        },
                        showFileInfo: true
                    });
                }
            }
        }

        // 计划对比相关变量
        let currentPlans = []; // 当前已选择的所有计划
        let referencePlan = null; // 参考计划
        let comparisonPlans = []; // 对比计划列表
        let isComparisonMode = false; // 是否处于对比模式
        let availablePlans = []; // 可用计划列表（模拟数据）

        // 初始化可用计划列表（模拟数据，实际应从后端获取）
        function initializeAvailablePlans() {
            // 模拟计划数据
            availablePlans = [
                { id: 'plan1', name: '0706(1)', calculated: true },
                { id: 'plan2', name: '0706(1)(1)', calculated: true },
                { id: 'plan3', name: '0706', calculated: true },
                { id: 'plan4', name: '0706(2)', calculated: true },
                { id: 'plan5', name: '0705(1)', calculated: true }
            ];
            
            // 默认将第一个计划作为参考计划
            if (availablePlans.length > 0) {
                referencePlan = availablePlans[0];
                updateReferencePlanInput();
            }
        }

        // 更新参考计划输入框
        function updateReferencePlanInput() {
            const input = document.getElementById('referencePlanInput');
            if (input && referencePlan) {
                input.value = referencePlan.name;
            }
        }

        // 渲染计划下拉菜单
        function renderPlanDropdown(containerId, selectedPlan, excludePlans = []) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = '';
            const calculatedPlans = availablePlans.filter(p => p.calculated && !excludePlans.includes(p.id));

            calculatedPlans.forEach(plan => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                if (selectedPlan && plan.id === selectedPlan.id) {
                    item.classList.add('selected');
                }
                item.textContent = plan.name;
                item.addEventListener('click', () => {
                    // 选择计划逻辑将在调用处处理
                    const event = new CustomEvent('planSelected', { detail: { plan, containerId } });
                    document.dispatchEvent(event);
                });
                container.appendChild(item);
            });
        }

        // 添加对比计划字段
        function addComparisonPlanField(plan = null) {
            if (comparisonPlans.length >= 2) {
                return; // 最多2个对比计划（总共3个计划）
            }

            const index = comparisonPlans.length;
            const planId = `comparisonPlan${index}`;
            const field = document.createElement('div');
            field.className = 'plan-comparison-field';
            field.id = `comparisonPlanField${index}`;
            
            const excludeIds = [referencePlan?.id, ...comparisonPlans.map(p => p?.id)].filter(Boolean);
            
            field.innerHTML = `
                <label class="plan-comparison-label">对比计划</label>
                <div class="plan-comparison-input-group">
                    <div class="plan-comparison-select" id="${planId}Select">
                        <input type="text" readonly placeholder="请选择对比计划" id="${planId}Input" value="${plan ? plan.name : ''}" data-plan-id="${plan ? plan.id : ''}">
                        <i class="fas fa-chevron-down dropdown-icon"></i>
                        <div class="dropdown-menu" id="${planId}Dropdown"></div>
                    </div>
                    <button class="plan-comparison-remove-btn" data-index="${index}">删除</button>
                </div>
            `;

            const listContainer = document.getElementById('comparisonPlansList');
            listContainer.appendChild(field);

            // 初始化下拉菜单
            renderPlanDropdown(`${planId}Dropdown`, plan, excludeIds);

            // 绑定事件
            const selectContainer = document.getElementById(`${planId}Select`);
            const input = document.getElementById(`${planId}Input`);
            const removeBtn = field.querySelector('.plan-comparison-remove-btn');

            // 点击输入框打开下拉菜单
            input.addEventListener('click', (e) => {
                e.stopPropagation();
                closeAllDropdowns();
                selectContainer.classList.add('open');
                renderPlanDropdown(`${planId}Dropdown`, plan ? plan : null, excludeIds);
            });

            // 删除按钮
            removeBtn.addEventListener('click', () => {
                removeComparisonPlan(index);
            });

            // 监听计划选择事件
            const selectHandler = (e) => {
                if (e.detail.containerId === `${planId}Dropdown`) {
                    selectPlan(planId, e.detail.plan, index);
                    selectContainer.classList.remove('open');
                }
            };
            document.addEventListener('planSelected', selectHandler);
            field.dataset.handler = 'true'; // 标记已绑定事件

            if (plan) {
                comparisonPlans[index] = plan;
            } else {
                comparisonPlans[index] = null;
            }

            updateAddButtonState();
        }

        // 选择计划
        function selectPlan(planId, plan, index) {
            const input = document.getElementById(`${planId}Input`);
            if (!input) return;

            // 验证不能选择相同的计划
            const excludeIds = [referencePlan?.id, ...comparisonPlans.map((p, i) => i !== index ? p?.id : null).filter(Boolean)];
            
            if (excludeIds.includes(plan.id)) {
                input.classList.add('error');
                setTimeout(() => {
                    input.classList.remove('error');
                }, 2000);
                return;
            }

            input.value = plan.name;
            input.dataset.planId = plan.id;
            comparisonPlans[index] = plan;

            // 重新渲染所有下拉菜单，排除已选择的计划
            updateAllDropdowns();
            updateAddButtonState();
        }

        // 更新所有下拉菜单
        function updateAllDropdowns() {
            // 更新参考计划下拉菜单
            renderPlanDropdown('referencePlanDropdown', referencePlan, comparisonPlans.map(p => p?.id).filter(Boolean));

            // 更新对比计划下拉菜单
            comparisonPlans.forEach((plan, index) => {
                const planId = `comparisonPlan${index}`;
                const excludeIds = [
                    referencePlan?.id,
                    ...comparisonPlans.map((p, i) => i !== index ? p?.id : null).filter(Boolean)
                ];
                renderPlanDropdown(`${planId}Dropdown`, plan, excludeIds);
            });
        }

        // 删除对比计划
        function removeComparisonPlan(index) {
            const field = document.getElementById(`comparisonPlanField${index}`);
            if (field) {
                field.remove();
            }
            comparisonPlans.splice(index, 1);
            
            // 重新渲染所有字段
            const listContainer = document.getElementById('comparisonPlansList');
            listContainer.innerHTML = '';
            comparisonPlans.forEach(plan => {
                addComparisonPlanField(plan);
            });
            if (comparisonPlans.length === 0) {
                updateAddButtonState();
            }
        }

        // 更新添加按钮状态
        function updateAddButtonState() {
            const addBtn = document.getElementById('addComparisonPlanBtn');
            if (addBtn) {
                addBtn.disabled = comparisonPlans.length >= 2;
            }
        }

        // 关闭所有下拉菜单
        function closeAllDropdowns() {
            document.querySelectorAll('.plan-comparison-select.open').forEach(el => {
                el.classList.remove('open');
            });
        }

        // 初始化计划对比功能
        function initializePlanComparison() {
            const comparisonBtn = document.getElementById('planComparisonBtn');
            const modal = document.getElementById('planComparisonModal');
            const modalClose = document.getElementById('planComparisonModalClose');
            const cancelBtn = document.getElementById('planComparisonCancelBtn');
            const confirmBtn = document.getElementById('planComparisonConfirmBtn');
            const addBtn = document.getElementById('addComparisonPlanBtn');
            const referenceSelect = document.getElementById('referencePlanSelect');
            const referenceInput = document.getElementById('referencePlanInput');

            // 打开模态对话框
            comparisonBtn.addEventListener('click', () => {
                if (isComparisonMode) {
                    // 取消对比模式
                    exitComparisonMode();
                } else {
                    // 打开计划对比对话框
                    modal.classList.add('show');
                    initializeAvailablePlans();
                    renderPlanDropdown('referencePlanDropdown', referencePlan, comparisonPlans.map(p => p?.id).filter(Boolean));
                    // 默认显示一个对比计划字段
                    if (comparisonPlans.length === 0) {
                        addComparisonPlanField();
                    }
                }
            });

            // 关闭模态对话框
            modalClose.addEventListener('click', () => {
                modal.classList.remove('show');
                resetComparisonForm();
            });

            cancelBtn.addEventListener('click', () => {
                modal.classList.remove('show');
                resetComparisonForm();
            });

            // 点击外部关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                    resetComparisonForm();
                }
            });

            // 参考计划选择
            referenceInput.addEventListener('click', (e) => {
                e.stopPropagation();
                closeAllDropdowns();
                referenceSelect.classList.add('open');
            });

            // 监听参考计划选择事件
            document.addEventListener('planSelected', (e) => {
                if (e.detail.containerId === 'referencePlanDropdown') {
                    const plan = e.detail.plan;
                    // 验证不能选择已选择的对比计划
                    const excludeIds = comparisonPlans.map(p => p?.id).filter(Boolean);
                    if (excludeIds.includes(plan.id)) {
                        referenceInput.classList.add('error');
                        setTimeout(() => {
                            referenceInput.classList.remove('error');
                        }, 2000);
                        return;
                    }
                    referencePlan = plan;
                    updateReferencePlanInput();
                    referenceSelect.classList.remove('open');
                    updateAllDropdowns();
                }
            });

            // 添加对比计划
            addBtn.addEventListener('click', () => {
                addComparisonPlanField();
            });

            // 确认对比
            confirmBtn.addEventListener('click', () => {
                if (!referencePlan) {
                    alert('请选择参考计划');
                    return;
                }

                const validPlans = comparisonPlans.filter(p => p !== null);
                if (validPlans.length === 0) {
                    alert('请至少添加一个对比计划');
                    return;
                }

                // 进入对比模式
                enterComparisonMode();
                modal.classList.remove('show');
            });

            // 点击外部关闭下拉菜单
            document.addEventListener('click', () => {
                closeAllDropdowns();
            });
        }

        // 进入对比模式
        function enterComparisonMode() {
            isComparisonMode = true;
            const comparisonBtn = document.getElementById('planComparisonBtn');
            const normalView = document.getElementById('normalView');
            const comparisonView = document.getElementById('comparisonView');
            const bottomPanel = document.querySelector('.plan-bottom-panel');

            comparisonBtn.innerHTML = '<i class="fas fa-times"></i><span>取消对比</span>';
            normalView.classList.add('hidden');
            comparisonView.classList.add('active');
            
            // 隐藏底部面板
            if (bottomPanel) {
                bottomPanel.style.display = 'none';
            }

            // 这里可以添加对比视图的渲染逻辑
            renderComparisonView();
        }

        // 退出对比模式
        function exitComparisonMode() {
            isComparisonMode = false;
            const comparisonBtn = document.getElementById('planComparisonBtn');
            const normalView = document.getElementById('normalView');
            const comparisonView = document.getElementById('comparisonView');
            const bottomPanel = document.querySelector('.plan-bottom-panel');

            comparisonBtn.innerHTML = '<i class="fas fa-layer-group"></i><span>计划对比</span>';
            normalView.classList.remove('hidden');
            comparisonView.classList.remove('active');
            
            // 显示底部面板
            if (bottomPanel) {
                bottomPanel.style.display = 'flex';
            }

            // 重置对比数据
            resetComparisonForm();
        }

        // 重置对比表单
        function resetComparisonForm() {
            comparisonPlans = [];
            const listContainer = document.getElementById('comparisonPlansList');
            if (listContainer) {
                listContainer.innerHTML = '';
            }
            updateAddButtonState();
            // 重置参考计划为默认值（第一个可用计划）
            if (availablePlans.length > 0) {
                referencePlan = availablePlans[0];
                updateReferencePlanInput();
            }
        }

        // 渲染对比视图
        function renderComparisonView() {
            const plans = [referencePlan, ...comparisonPlans.filter(p => p !== null)];
            const planCount = plans.length;
            
            // 根据计划数量显示不同的布局
            const twoPlansContainer = document.getElementById('twoPlansContainer');
            const threePlansContainer = document.getElementById('threePlansContainer');
            
            if (planCount === 3) {
                // 三个计划的布局
                if (twoPlansContainer) twoPlansContainer.style.display = 'none';
                if (threePlansContainer) threePlansContainer.style.display = 'flex';
                
                renderThreePlansView(plans);
            } else {
                // 两个计划的布局
                if (twoPlansContainer) twoPlansContainer.style.display = 'flex';
                if (threePlansContainer) threePlansContainer.style.display = 'none';
                
                renderTwoPlansView(plans);
            }
        }

        // 渲染两个计划的对比视图
        function renderTwoPlansView(plans) {
            // 更新计划标题
            const plan1Header = document.querySelector('#comparisonPlan1 .comparison-plan-header');
            const plan2Header = document.querySelector('#comparisonPlan2 .comparison-plan-header');
            
            if (plan1Header && plans[0]) {
                plan1Header.textContent = plans[0].name;
            }
            if (plan2Header && plans[1]) {
                plan2Header.textContent = plans[1].name;
            }

            // 更新视图信息
            updateViewInfo('plan1', 'Axial-151/300');
            updateViewInfo('plan1', 'Sagittal 241/480');
            updateViewInfo('plan1', 'Coronal 241/480');
            updateViewInfo('plan2', 'Axial-151/300');
            updateViewInfo('plan2', 'Sagittal 241/480');
            updateViewInfo('plan2', 'Coronal 241/480');

            // 渲染剂量图例
            renderDoseLegend('plan1AxialLegend');
            renderDoseLegend('plan1SagittalLegend');
            renderDoseLegend('plan1CoronalLegend');
            renderDoseLegend('plan2AxialLegend');
            renderDoseLegend('plan2SagittalLegend');
            renderDoseLegend('plan2CoronalLegend');

            // 初始化canvas（占位）
            initializeComparisonCanvases();

            // 初始化剂量统计组件
            initComparisonDoseStatsComponent(plans);

            // 初始化DVH标签切换
            initializeDvhTabs();

            // 初始化对比列表标签切换
            initializeComparisonListTabs();

            // 初始化主区域拖拽调整
            initializeComparisonResizer();
        }

        // 渲染三个计划的对比视图
        function renderThreePlansView(plans) {
            // 更新计划标题
            const plan1Header = document.querySelector('#threePlan1 .comparison-plan-header');
            const plan2Header = document.querySelector('#threePlan2 .comparison-plan-header');
            const plan3Header = document.querySelector('#threePlan3 .comparison-plan-header');
            
            if (plan1Header && plans[0]) {
                plan1Header.textContent = plans[0].name;
            }
            if (plan2Header && plans[1]) {
                plan2Header.textContent = plans[1].name;
            }
            if (plan3Header && plans[2]) {
                plan3Header.textContent = plans[2].name;
            }

            // 更新视图信息
            const infoElement1 = document.getElementById('threePlan1AxialInfo');
            const infoElement2 = document.getElementById('threePlan2AxialInfo');
            const infoElement3 = document.getElementById('threePlan3AxialInfo');
            if (infoElement1) infoElement1.textContent = 'Axial-151/300';
            if (infoElement2) infoElement2.textContent = 'Axial-151/300';
            if (infoElement3) infoElement3.textContent = 'Axial-151/300';

            // 渲染剂量图例
            renderDoseLegend('threePlan1AxialLegend');
            renderDoseLegend('threePlan2AxialLegend');
            renderDoseLegend('threePlan3AxialLegend');

            // 初始化三个计划的canvas
            initializeThreePlansCanvases();

            // 初始化三个计划的剂量统计组件
            initThreePlansComparisonDoseStatsComponent(plans);

            // 初始化三个计划的DVH标签切换
            initializeThreePlansDvhTabs();

            // 初始化三个计划的对比列表标签切换
            initializeThreePlansListTabs();

            // 初始化三个计划的拖拽调整
            initializeThreePlansResizer();
        }

        // 初始化对比视图主区域拖拽调整
        function initializeComparisonResizer() {
            const container = document.querySelector('.comparison-main-container');
            const resizer = document.getElementById('comparisonMainResizer');
            const leftPanel = document.getElementById('comparisonPlansContainer');
            const rightPanel = document.getElementById('comparisonRightPanel');

            if (!container || !resizer || !leftPanel || !rightPanel) return;

            let isResizing = false;
            let startX = 0;
            let containerWidth = 0;
            let startLeftWidth = 0;
            let startRightWidth = 0;
            const minLeftPercent = 30; // 左侧最小占比
            const maxLeftPercent = 70; // 左侧最大占比

            const onMouseDown = (e) => {
                isResizing = true;
                startX = e.clientX;
                containerWidth = container.getBoundingClientRect().width;
                startLeftWidth = leftPanel.getBoundingClientRect().width;
                startRightWidth = rightPanel.getBoundingClientRect().width;
                container.classList.add('resizing');
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
                e.preventDefault();
            };

            const onMouseMove = (e) => {
                if (!isResizing) return;
                const delta = e.clientX - startX;
                const newLeftWidth = startLeftWidth + delta;
                let leftPercent = (newLeftWidth / containerWidth) * 100;
                
                // 限制左侧占比范围
                if (leftPercent < minLeftPercent) leftPercent = minLeftPercent;
                if (leftPercent > maxLeftPercent) leftPercent = maxLeftPercent;
                
                // 计算右侧宽度（保持固定宽度，但允许调整）
                const rightPercent = 100 - leftPercent - (6 / containerWidth * 100); // 减去resizer宽度
                const rightWidth = containerWidth * (rightPercent / 100);
                
                // 确保右侧宽度在合理范围内
                if (rightWidth < 400) {
                    // 如果右侧太窄，调整左侧
                    leftPanel.style.flex = `1 1 ${100 - (400 + 6) / containerWidth * 100}%`;
                    rightPanel.style.width = '400px';
                } else if (rightWidth > 800) {
                    // 如果右侧太宽，调整左侧
                    leftPanel.style.flex = `1 1 ${100 - (800 + 6) / containerWidth * 100}%`;
                    rightPanel.style.width = '800px';
                } else {
                    // 正常调整
                    leftPanel.style.flex = `1 1 ${leftPercent}%`;
                    rightPanel.style.width = rightWidth + 'px';
                }
            };

            const onMouseUp = () => {
                isResizing = false;
                container.classList.remove('resizing');
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            };

            resizer.addEventListener('mousedown', onMouseDown);
        }

        // 更新视图信息
        function updateViewInfo(planId, info) {
            const elements = {
                'plan1AxialInfo': 'plan1',
                'plan1SagittalInfo': 'plan1',
                'plan1CoronalInfo': 'plan1',
                'plan2AxialInfo': 'plan2',
                'plan2SagittalInfo': 'plan2',
                'plan2CoronalInfo': 'plan2'
            };

            Object.keys(elements).forEach(key => {
                if (key.startsWith(planId)) {
                    const element = document.getElementById(key);
                    if (element) {
                        element.textContent = info;
                    }
                }
            });
        }

        // 渲染剂量图例
        function renderDoseLegend(legendId) {
            const legend = document.getElementById(legendId);
            if (!legend) return;

            const doseLevels = [
                { value: '4950.0', percent: '110%', color: '#ff0000' },
                { value: '4725.0', percent: '105%', color: '#ff8800' },
                { value: '4500.0', percent: '100%', color: '#ffff00' },
                { value: '4275.0', percent: '95%', color: '#88ff00' },
                { value: '3825.0', percent: '85%', color: '#00ff00' },
                { value: '2700.0', percent: '60%', color: '#00ffff' },
                { value: '1800.0', percent: '40%', color: '#0088ff' },
                { value: '900.0', percent: '20%', color: '#8800ff' }
            ];

            legend.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 4px; color: #ffffff;">4500 cGy 100%</div>
                ${doseLevels.map(level => `
                    <div class="comparison-dose-legend-item">
                        <div class="comparison-dose-legend-color" style="background: ${level.color};"></div>
                        <span>${level.value} (${level.percent})</span>
                    </div>
                `).join('')}
            `;
        }

        // 初始化对比canvas（占位）
        function initializeComparisonCanvases() {
            const canvasIds = [
                'plan1AxialCanvas', 'plan1SagittalCanvas', 'plan1CoronalCanvas',
                'plan2AxialCanvas', 'plan2SagittalCanvas', 'plan2CoronalCanvas'
            ];

            canvasIds.forEach(canvasId => {
                const canvas = document.getElementById(canvasId);
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    const rect = canvas.parentElement.getBoundingClientRect();
                    canvas.width = rect.width;
                    canvas.height = rect.height;

                    // 绘制占位背景
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#2A2A2A';
                    ctx.font = '14px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('图像显示区域', canvas.width / 2, canvas.height / 2);
                }
            });
        }

        // 初始化三个计划的canvas
        function initializeThreePlansCanvases() {
            const canvasIds = [
                'threePlan1AxialCanvas', 'threePlan2AxialCanvas', 'threePlan3AxialCanvas'
            ];

            canvasIds.forEach(canvasId => {
                const canvas = document.getElementById(canvasId);
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    const rect = canvas.parentElement.getBoundingClientRect();
                    canvas.width = rect.width;
                    canvas.height = rect.height;

                    // 绘制占位背景
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#2A2A2A';
                    ctx.font = '14px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('图像显示区域', canvas.width / 2, canvas.height / 2);
                }
            });
        }

        // 计划对比剂量统计组件实例
        let comparisonDoseStatsComponent = null;

        // 初始化计划对比的剂量统计组件
        function initComparisonDoseStatsComponent(plans = []) {
            const container = document.getElementById('comparisonDoseStatsContainer');
            if (!container) return;

            if (typeof PlanComparisonDoseStatisticsComponent === 'undefined') {
                console.error('PlanComparisonDoseStatisticsComponent is not loaded');
                return;
            }

            try {
                const plan1Name = plans[0]?.name || 'plan1';
                const plan2Name = plans[1]?.name || 'plan2';

                // 如果已经初始化，检查计划名称是否改变，如果改变则重新初始化
                if (container.dataset.inited === 'true' && comparisonDoseStatsComponent) {
                    const currentPlan1 = container.dataset.plan1Name || '';
                    const currentPlan2 = container.dataset.plan2Name || '';
                    
                    // 如果计划名称没有改变，直接返回
                    if (currentPlan1 === plan1Name && currentPlan2 === plan2Name) {
                        return;
                    }
                    
                    // 计划名称改变了，需要重新初始化
                    container.innerHTML = `
                        <div class="loading-indicator">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>加载剂量统计组件...</span>
                        </div>
                    `;
                    container.dataset.inited = 'false';
                    comparisonDoseStatsComponent = null;
                }

                comparisonDoseStatsComponent = new PlanComparisonDoseStatisticsComponent('comparisonDoseStatsContainer', {
                    plan1Name: plan1Name,
                    plan2Name: plan2Name,
                    getGlobalStats: () => {
                        // TODO: 从实际数据源获取全局统计
                        return [
                            {
                                id: 'maxDose1',
                                plan: 'plan1',
                                visible: true,
                                color: '#ff0000',
                                statisticItem: `${plan1Name}最大剂量`,
                                relativeDosePercentage: 107.09,
                                targetDose: 6996.00,
                                dose: 7492.19,
                                x: -1.35,
                                y: 2.70,
                                z: 24.53
                            },
                            {
                                id: 'maxDose2',
                                plan: 'plan2',
                                visible: true,
                                color: '#ff8800',
                                statisticItem: `${plan2Name}最大剂量`,
                                relativeDosePercentage: 107.09,
                                targetDose: 6996.00,
                                dose: 7492.19,
                                x: -1.35,
                                y: 2.70,
                                z: 24.53
                            }
                        ];
                    },
                    getRoiStats: () => {
                        // TODO: 从实际数据源获取ROI统计
                        return [
                            {
                                name: 'CTV',
                                type: 'CTV',
                                color: '#0000ff',
                                volume: 695.84,
                                plan1: {
                                    minDose: 4368.09,
                                    maxDose: 4708.15
                                },
                                plan2: {
                                    minDose: 0.00,
                                    maxDose: 4778.35
                                }
                            },
                            {
                                name: 'ptv_new',
                                type: 'PTV',
                                color: '#00ff00',
                                volume: 1481.99,
                                plan1: {
                                    minDose: 0.00,
                                    maxDose: 4778.35
                                },
                                plan2: {
                                    minDose: 0.00,
                                    maxDose: 0.00
                                }
                            },
                            {
                                name: 'AdrenalGlan...',
                                type: 'ORGAN',
                                color: '#ff69b4',
                                volume: 0.00,
                                plan1: {
                                    minDose: 0.00,
                                    maxDose: 0.00
                                },
                                plan2: {
                                    minDose: 1180.33,
                                    maxDose: 4620.39
                                }
                            },
                            {
                                name: 'Body',
                                type: 'BODY',
                                color: '#ffff00',
                                volume: 17695.10,
                                plan1: {
                                    minDose: 0.00,
                                    maxDose: 4778.35
                                },
                                plan2: {
                                    minDose: 1230.79,
                                    maxDose: 4602.84
                                }
                            },
                            {
                                name: 'Bone_Pubic',
                                type: 'ORGAN',
                                color: '#ff69b4',
                                volume: 65.43,
                                plan1: {
                                    minDose: 710.28,
                                    maxDose: 4589.68
                                },
                                plan2: {
                                    minDose: 147.27,
                                    maxDose: 4760.80
                                }
                            },
                            {
                                name: 'bladder_min...',
                                type: 'ORGAN',
                                color: '#9370db',
                                volume: 247.68,
                                plan1: {
                                    minDose: 1180.33,
                                    maxDose: 4550.19
                                },
                                plan2: {
                                    minDose: 1180.33,
                                    maxDose: 4550.19
                                }
                            }
                        ];
                    },
                    getPoiStats: () => {
                        // TODO: 从实际数据源获取POI统计
                        return [
                            {
                                name: 'Point1',
                                color: '#ff0000',
                                plan1: {
                                    dose: 15576.95,
                                    x: 11.40,
                                    y: -0.25,
                                    z: 23.03
                                },
                                plan2: {
                                    dose: 15576.95,
                                    x: 11.40,
                                    y: -0.25,
                                    z: 23.03
                                }
                            }
                        ];
                    },
                    onExport: (data) => {
                        // TODO: 实现Excel导出功能
                        console.log('导出剂量统计:', data);
                        comparisonDoseStatsComponent.defaultExportToExcel({
                            plan1Name: plan1Name,
                            plan2Name: plan2Name,
                            patientId: 'Y87342987',
                            patientName: 'Zhangguang',
                            comparisonMode: 'plan'
                        });
                    }
                });

                container.dataset.inited = 'true';
                container.dataset.plan1Name = plan1Name;
                container.dataset.plan2Name = plan2Name;
            } catch (error) {
                console.error('Failed to initialize PlanComparisonDoseStatisticsComponent:', error);
            }
        }

        // 三个计划对比剂量统计组件实例
        let threePlansComparisonDoseStatsComponent = null;

        // 初始化三个计划对比的剂量统计组件
        function initThreePlansComparisonDoseStatsComponent(plans = []) {
            const container = document.getElementById('threePlansDoseStatsContainer');
            if (!container) return;

            if (typeof ThreePlansComparisonDoseStatisticsComponent === 'undefined') {
                console.error('ThreePlansComparisonDoseStatisticsComponent is not loaded');
                return;
            }

            try {
                const plan1Name = plans[0]?.name || 'plan1';
                const plan2Name = plans[1]?.name || 'plan2';
                const plan3Name = plans[2]?.name || 'plan3';

                // 如果已经初始化，检查计划名称是否改变，如果改变则重新初始化
                if (container.dataset.inited === 'true' && threePlansComparisonDoseStatsComponent) {
                    const currentPlan1 = container.dataset.plan1Name || '';
                    const currentPlan2 = container.dataset.plan2Name || '';
                    const currentPlan3 = container.dataset.plan3Name || '';
                    
                    // 如果计划名称没有改变，直接返回
                    if (currentPlan1 === plan1Name && currentPlan2 === plan2Name && currentPlan3 === plan3Name) {
                        return;
                    }
                    
                    // 计划名称改变了，需要重新初始化
                    container.innerHTML = `
                        <div class="loading-indicator">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>加载剂量统计组件...</span>
                        </div>
                    `;
                    container.dataset.inited = 'false';
                    threePlansComparisonDoseStatsComponent = null;
                }

                threePlansComparisonDoseStatsComponent = new ThreePlansComparisonDoseStatisticsComponent('threePlansDoseStatsContainer', {
                    plan1Name: plan1Name,
                    plan2Name: plan2Name,
                    plan3Name: plan3Name,
                    getGlobalStats: () => {
                        // TODO: 从实际数据源获取全局统计
                        return [
                            {
                                id: 'maxDose1',
                                plan: 'plan1',
                                visible: true,
                                color: '#ff0000',
                                statisticItem: `${plan1Name}最大剂量`,
                                relativeDosePercentage: 107.09,
                                targetDose: 6996.00,
                                dose: 7492.19,
                                x: -1.35,
                                y: 2.70,
                                z: 24.53
                            },
                            {
                                id: 'maxDose2',
                                plan: 'plan2',
                                visible: true,
                                color: '#ff8800',
                                statisticItem: `${plan2Name}最大剂量`,
                                relativeDosePercentage: 107.09,
                                targetDose: 6996.00,
                                dose: 7492.19,
                                x: -1.35,
                                y: 2.70,
                                z: 24.53
                            },
                            {
                                id: 'maxDose3',
                                plan: 'plan3',
                                visible: true,
                                color: '#00ff00',
                                statisticItem: `${plan3Name}最大剂量`,
                                relativeDosePercentage: 107.09,
                                targetDose: 6996.00,
                                dose: 7492.19,
                                x: -1.35,
                                y: 2.70,
                                z: 24.53
                            }
                        ];
                    },
                    getRoiStats: () => {
                        // TODO: 从实际数据源获取ROI统计
                        return [
                            {
                                name: 'CTV',
                                type: 'CTV',
                                color: '#0000ff',
                                volume: 695.84,
                                plan1: {
                                    minDose: 4368.09,
                                    maxDose: 4708.15
                                },
                                plan2: {
                                    minDose: 0.00,
                                    maxDose: 4778.35
                                },
                                plan3: {
                                    minDose: 4000.00,
                                    maxDose: 4800.00
                                }
                            },
                            {
                                name: 'ptv_new',
                                type: 'PTV',
                                color: '#00ff00',
                                volume: 1481.99,
                                plan1: {
                                    minDose: 0.00,
                                    maxDose: 4778.35
                                },
                                plan2: {
                                    minDose: 0.00,
                                    maxDose: 0.00
                                },
                                plan3: {
                                    minDose: 1000.00,
                                    maxDose: 5000.00
                                }
                            },
                            {
                                name: 'Body',
                                type: 'BODY',
                                color: '#ffff00',
                                volume: 17695.10,
                                plan1: {
                                    minDose: 0.00,
                                    maxDose: 4778.35
                                },
                                plan2: {
                                    minDose: 1230.79,
                                    maxDose: 4602.84
                                },
                                plan3: {
                                    minDose: 1500.00,
                                    maxDose: 4700.00
                                }
                            }
                        ];
                    },
                    getPoiStats: () => {
                        // TODO: 从实际数据源获取POI统计
                        return [
                            {
                                name: 'Point1',
                                color: '#ff0000',
                                plan1: {
                                    dose: 15576.95,
                                    x: 11.40,
                                    y: -0.25,
                                    z: 23.03
                                },
                                plan2: {
                                    dose: 15576.95,
                                    x: 11.40,
                                    y: -0.25,
                                    z: 23.03
                                },
                                plan3: {
                                    dose: 16000.00,
                                    x: 11.50,
                                    y: -0.30,
                                    z: 23.10
                                }
                            }
                        ];
                    },
                    onExport: (data) => {
                        // TODO: 实现Excel导出功能
                        console.log('导出剂量统计:', data);
                        threePlansComparisonDoseStatsComponent.defaultExportToExcel({
                            plan1Name: plan1Name,
                            plan2Name: plan2Name,
                            plan3Name: plan3Name,
                            patientId: 'Y87342987',
                            patientName: 'Zhangguang',
                            comparisonMode: 'threePlans'
                        });
                    }
                });

                container.dataset.inited = 'true';
                container.dataset.plan1Name = plan1Name;
                container.dataset.plan2Name = plan2Name;
                container.dataset.plan3Name = plan3Name;
            } catch (error) {
                console.error('Failed to initialize ThreePlansComparisonDoseStatisticsComponent:', error);
            }
        }

        // 初始化三个计划的DVH标签切换
        function initializeThreePlansDvhTabs() {
            const tabs = document.querySelectorAll('#threePlansContainer .comparison-dvh-tab');
            const panels = {
                dvh: document.getElementById('threePlansDvhPanel'),
                doseDiff: document.getElementById('threePlansDoseDiffPanel')
            };

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const panelName = tab.getAttribute('data-panel');
                    
                    // 移除所有active类
                    tabs.forEach(t => t.classList.remove('active'));
                    Object.values(panels).forEach(p => p && p.classList.remove('active'));
                    
                    // 添加active类
                    tab.classList.add('active');
                    if (panels[panelName]) {
                        panels[panelName].classList.add('active');
                    }
                });
            });
        }

        // 初始化三个计划的对比列表标签切换
        function initializeThreePlansListTabs() {
            const tabs = document.querySelectorAll('#threePlansContainer .comparison-list-tab');
            const contents = document.querySelectorAll('#threePlansContainer .comparison-list-content-item');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    
                    // 移除所有active类
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));
                    
                    // 添加active类
                    tab.classList.add('active');
                    const targetContent = document.getElementById(`threePlans${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                    
                    // 如果切换到剂量统计，初始化组件
                    if (tabName === 'doseStats') {
                        // 获取当前选中的计划
                        const plan1Header = document.querySelector('#threePlan1 .comparison-plan-header');
                        const plan2Header = document.querySelector('#threePlan2 .comparison-plan-header');
                        const plan3Header = document.querySelector('#threePlan3 .comparison-plan-header');
                        const plans = [
                            { name: plan1Header?.textContent?.trim() || 'plan1' },
                            { name: plan2Header?.textContent?.trim() || 'plan2' },
                            { name: plan3Header?.textContent?.trim() || 'plan3' }
                        ];
                        // 确保组件已初始化
                        initThreePlansComparisonDoseStatsComponent(plans);
                    }
                    // 如果切换到射束列表，初始化组件
                    if (tabName === 'beamList') {
                        initializeThreePlansBeamListComponent();
                    }
                });
            });
        }

        // 初始化三个计划的射束列表组件
        function initializeThreePlansBeamListComponent() {
            const container = document.getElementById('threePlansBeamListContainer');
            if (!container) return;
            
            if (container.dataset.inited === 'true') return;
            
            if (window.BeamListComponent) {
                try {
                    new window.BeamListComponent(container);
                    container.dataset.inited = 'true';
                } catch (e) {
                    console.warn('初始化三个计划射束列表组件失败:', e);
                }
            } else {
                console.warn('BeamListComponent 尚未加载');
            }
        }

        // 初始化三个计划的拖拽调整
        function initializeThreePlansResizer() {
            const container = document.getElementById('threePlansBottomContainer');
            const resizer = document.getElementById('threePlansResizer');
            const leftPanel = document.querySelector('.comparison-three-dvh-area');
            const rightPanel = document.querySelector('.comparison-three-list-area');

            if (!container || !resizer || !leftPanel || !rightPanel) return;

            let isResizing = false;
            let startX = 0;
            let containerWidth = 0;
            let startLeftWidth = 0;
            let startRightWidth = 0;

            const onMouseDown = (e) => {
                isResizing = true;
                startX = e.clientX;
                containerWidth = container.getBoundingClientRect().width;
                startLeftWidth = leftPanel.getBoundingClientRect().width;
                startRightWidth = rightPanel.getBoundingClientRect().width;
                container.classList.add('resizing');
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
                e.preventDefault();
            };

            const onMouseMove = (e) => {
                if (!isResizing) return;
                const delta = e.clientX - startX;
                const newLeftWidth = startLeftWidth + delta;
                const rightWidth = startRightWidth - delta;
                
                // 限制右侧宽度范围
                if (rightWidth < 400) {
                    rightPanel.style.width = '400px';
                    leftPanel.style.flex = `1 1 ${containerWidth - 400 - 6}px`;
                } else if (rightWidth > 800) {
                    rightPanel.style.width = '800px';
                    leftPanel.style.flex = `1 1 ${containerWidth - 800 - 6}px`;
                } else {
                    leftPanel.style.flex = `1 1 ${newLeftWidth}px`;
                    rightPanel.style.width = rightWidth + 'px';
                }
            };

            const onMouseUp = () => {
                isResizing = false;
                container.classList.remove('resizing');
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            };

            resizer.addEventListener('mousedown', onMouseDown);
        }

        // 初始化DVH标签切换
        function initializeDvhTabs() {
            const tabs = document.querySelectorAll('.comparison-dvh-tab');
            const panels = {
                dvh: document.getElementById('comparisonDvhPanel'),
                doseDiff: document.getElementById('comparisonDoseDiffPanel')
            };

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const panelName = tab.getAttribute('data-panel');
                    
                    // 移除所有active类
                    tabs.forEach(t => t.classList.remove('active'));
                    Object.values(panels).forEach(p => p && p.classList.remove('active'));
                    
                    // 添加active类
                    tab.classList.add('active');
                    if (panels[panelName]) {
                        panels[panelName].classList.add('active');
                    }
                });
            });
        }

        // 初始化对比列表标签切换
        function initializeComparisonListTabs() {
            const tabs = document.querySelectorAll('.comparison-list-tab');
            const contents = document.querySelectorAll('.comparison-list-content-item');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    
                    // 移除所有active类
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));
                    
                    // 添加active类
                    tab.classList.add('active');
                    const targetContent = document.getElementById(`comparison${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                    
                    // 如果切换到剂量统计，初始化组件
                    if (tabName === 'doseStats') {
                        // 获取当前选中的计划
                        const plan1Header = document.querySelector('#comparisonPlan1 .comparison-plan-header');
                        const plan2Header = document.querySelector('#comparisonPlan2 .comparison-plan-header');
                        const plans = [
                            { name: plan1Header?.textContent?.trim() || 'plan1' },
                            { name: plan2Header?.textContent?.trim() || 'plan2' }
                        ];
                        // 确保组件已初始化
                        initComparisonDoseStatsComponent(plans);
                    }
                    // 如果切换到射束列表，初始化组件
                    if (tabName === 'beamList') {
                        initializeComparisonBeamListComponent();
                    }
                });
            });
        }

        // 初始化对比视图的射束列表组件
        function initializeComparisonBeamListComponent() {
            const container = document.getElementById('comparisonBeamListContainer');
            if (!container) return;
            
            // 检查是否已初始化
            if (container.dataset.inited === 'true') return;
            
            // 检查组件是否已加载
            if (window.BeamListComponent) {
                try {
                    new window.BeamListComponent(container);
                    container.dataset.inited = 'true';
                } catch (e) {
                    console.warn('初始化对比视图射束列表组件失败:', e);
                }
            } else {
                console.warn('BeamListComponent 尚未加载');
            }
        }

        // 初始化鲁棒性评估2D视图
        function initializeRobustnessViews() {
            if (window.PlanDesignView2DComponent) {
                new PlanDesignView2DComponent('robustnessAxialContainer', {
                    viewType: 'Axial',
                    sliceTotal: 157,
                    sliceCurrent: 57
                });
                
                new PlanDesignView2DComponent('robustnessCoronalContainer', {
                    viewType: 'Coronal',
                    sliceTotal: 157,
                    sliceCurrent: 89
                });
                
                new PlanDesignView2DComponent('robustnessSagittalContainer', {
                    viewType: 'Sagittal',
                    sliceTotal: 157,
                    sliceCurrent: 78
                });
            }
        }

        // 页面加载完成后初始化
        // 通用工具栏展开收起功能
        function initializeToolbarToggle(toolbarId, toggleBtnId) {
            const toolbar = document.getElementById(toolbarId);
            const toggleBtn = document.getElementById(toggleBtnId);
            
            if (!toolbar || !toggleBtn) return;
            
            // 默认展开状态
            toolbar.classList.add('expanded');
            
            // 绑定点击事件
            toggleBtn.addEventListener('click', () => {
                const icon = toggleBtn.querySelector('i');
                if (!icon) return;
                
                if (toolbar.classList.contains('expanded')) {
                    // 收起工具栏
                    toolbar.classList.remove('expanded');
                    toolbar.classList.add('collapsed');
                    icon.className = 'fas fa-chevron-down';
                } else {
                    // 展开工具栏
                    toolbar.classList.remove('collapsed');
                    toolbar.classList.add('expanded');
                    icon.className = 'fas fa-chevron-up';
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // 初始化工具栏展开收起功能
            initializeToolbarToggle('planEvaluationToolbar', 'evalToolbarToggleBtn');
            initializeToolbarToggle('robustnessEvaluationToolbar', 'robustnessToolbarToggleBtn');
            
            initializeEvalNavButtons();
            initializeEvalLeftPanelToggle();
            initializeEvalLeftPanelResizer();
            initializeEval2d3dToggle();
            initializeEvalBevDvhTabs();
            initializeEvalBottomTabs();
            initializeEvalImageSplitter();
            initializePlanComparison();
            initializeRightSwitchPanel();
            initializeRobustnessBottomTabs();
            renderRobustnessScenarios();
            initializeScenarioColumnToggle();
            renderRobustnessClinicalTargets();
            initializeRobustnessViewResizers();
            initializeRobustnessViews();
            
            // 如果BEV标签是激活的，初始化BEV视图
            const evalBevPanel = document.getElementById('evalBevPanel');
            if (evalBevPanel && evalBevPanel.classList.contains('active')) {
                setTimeout(() => {
                    if (typeof initializePlanEvaluationBEVView === 'function') {
                        initializePlanEvaluationBEVView();
                    }
                }, 200);
            }
            
            // 延迟加载组件，确保组件脚本已加载
            setTimeout(() => {
                initializeEvalComponents();
            }, 100);
        });
    </script>
</body>
</html>


