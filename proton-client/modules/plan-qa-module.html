<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>计划QA</title>
    <link rel="stylesheet" href="../../shared/styles/styles.css">
    <link rel="stylesheet" href="../../shared/styles/styles_plan_view_2d.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* 计划QA模块专用样式 */
        .plan-qa-content {
            display: flex;
            width: 100%;
            height: 100vh;
            background: #1a1a1a;
            overflow: hidden;
        }

        .plan-qa-content .image-left-panel {
            width: 350px;
            min-width: 200px;
            max-width: 600px;
            background: #2a2a2a;
            border-right: 1px solid #2A2A2A;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: all 0.3s ease;
        }

        .plan-qa-content .image-left-panel .resizer-handle {
            position: absolute;
            right: 0;
            top: 0;
            width: 4px;
            height: 100%;
            cursor: col-resize;
            z-index: 10;
            background: transparent;
        }

        .plan-qa-content .image-left-panel .resizer-handle:hover {
            background: rgba(0, 122, 204, 0.3);
        }

        .plan-qa-content .image-left-panel .patient-info-header {
            background-color: #2a2a2a;
            border-bottom: 1px solid #2A2A2A;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
            position: relative;
        }

        .plan-qa-content .image-left-panel .collapse-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            background-color: #404040;
            border: 1px solid #555555;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .plan-qa-content .image-left-panel .content-area {
            display: flex;
            flex-direction: row;
            flex: 1;
            overflow: hidden;
        }

        .plan-qa-content .image-left-panel .panel-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: #1a1a1a;
            min-width: 0;
        }

        .plan-qa-content .image-left-panel .panel-section {
            display: none;
            flex: 1;
            padding: 8px;
            overflow-y: auto;
            height: 100%;
            flex-direction: column;
        }

        .plan-qa-content .image-left-panel .panel-section.active {
            display: flex;
            flex-direction: column;
        }

        /* 工具栏样式 */
        .plan-qa-toolbar {
            background-color: #2d2d2d;
            border-bottom: 1px solid #404040;
            position: fixed;
            top: 0;
            left: 350px;
            right: 0;
            z-index: 1000;
            width: calc(100vw - 350px);
            transition: height 0.3s ease, left 0.3s ease, width 0.3s ease;
            overflow: hidden;
        }

        .plan-qa-content .image-left-panel.collapsed ~ .plan-qa-main-view .plan-qa-toolbar {
            left: 60px;
            width: calc(100vw - 60px);
        }

        .plan-qa-toolbar.expanded {
            height: 70px;
        }

        .plan-qa-toolbar.collapsed {
            height: 40px;
        }

        .plan-qa-toolbar-content {
            padding: 10px 20px 10px 80px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            height: 100%;
        }

        .plan-qa-toolbar-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .plan-qa-toolbar-toggle {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
            width: 40px;
            height: 30px;
            background: #404040;
            border: 1px solid #555555;
            border-radius: 4px;
            color: #ddd;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 12px;
        }

        .plan-qa-toolbar-toggle:hover {
            background: #555555;
            border-color: #666666;
            color: #ffffff;
        }

        .plan-qa-toolbar-btn {
            padding: 6px 8px;
            background: #404040;
            border: 1px solid #555555;
            border-radius: 4px;
            color: #ddd;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.3s;
            min-width: 60px;
        }

        .plan-qa-toolbar-btn:hover {
            background: #3AACDE;
            border-color: #3AACDE;
            color: #ffffff;
        }

        .plan-qa-toolbar-btn i {
            font-size: 16px;
        }

        .plan-qa-toolbar-btn span {
            font-size: 11px;
            line-height: 1.2;
            text-align: center;
        }

        /* 主视图区域 */
        .plan-qa-main-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            padding-top: 70px;
            overflow: hidden;
            transition: padding-top 0.3s ease;
        }

        .plan-qa-toolbar.collapsed ~ .plan-qa-main-content {
            margin-top: 0;
        }

        .plan-qa-main-view .plan-qa-toolbar.collapsed ~ .plan-qa-main-content {
            padding-top: 0;
        }

        /* 主内容区域：左右分栏 */
        .plan-qa-main-content {
            flex: 1;
            display: flex;
            flex-direction: row;
            gap: 0;
            overflow: hidden;
            min-height: 0;
        }

        /* 左侧：三个2D视图 */
        .plan-qa-2d-views {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0;
            padding: 0;
            overflow: hidden;
            min-height: 0;
            position: relative;
            background: #1a1a1a;
            border-right: 1px solid #404040;
        }

        /* 上半部分：Axial视图 */
        .plan-qa-axial-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
            border: none;
            overflow: hidden;
            position: relative;
            min-height: 0;
        }

        /* 下半部分：Sagittal和Coronal视图 */
        .plan-qa-bottom-views {
            flex: 1;
            display: flex;
            flex-direction: row;
            gap: 0;
            overflow: hidden;
            min-height: 0;
            border-top: 1px solid #404040;
        }

        .plan-qa-sagittal-view,
        .plan-qa-coronal-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
            border: none;
            overflow: hidden;
            position: relative;
            min-height: 0;
        }

        .plan-qa-coronal-view {
            border-left: 1px solid #404040;
        }

        /* 视图分隔条 */
        .plan-qa-view-resizer {
            width: 4px;
            background: transparent;
            cursor: row-resize;
            z-index: 10;
            transition: background 0.2s;
        }

        .plan-qa-view-resizer:hover {
            background: rgba(0, 122, 204, 0.3);
        }

        .plan-qa-view-resizer.vertical {
            width: 4px;
            cursor: col-resize;
        }

        /* 右侧：图表和表格区域 */
        .plan-qa-right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 400px;
            overflow: hidden;
            background: #1a1a1a;
        }

        /* 右侧上半部分：图表区域 */
        .plan-qa-chart-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-bottom: 1px solid #404040;
        }

        /* 右侧下半部分：表格区域 */
        .plan-qa-table-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* 右侧分隔条 */
        .plan-qa-panel-resizer {
            height: 4px;
            background: transparent;
            cursor: row-resize;
            z-index: 10;
            transition: background 0.2s;
        }

        .plan-qa-panel-resizer:hover {
            background: rgba(0, 122, 204, 0.3);
        }

        /* 视图头部 */
        .plan-qa-view-header {
            height: 32px;
            background: #2a2a2a;
            border-bottom: 1px solid #404040;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            flex-shrink: 0;
            z-index: 10;
        }

        .plan-qa-view-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .plan-qa-view-type-label {
            color: #ffffff;
            font-size: 12px;
            font-weight: 600;
        }

        .plan-qa-view-header-right {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 12px;
        }

        .plan-qa-view-header-btn {
            width: 24px;
            height: 24px;
            background: transparent;
            border: 1px solid #555555;
            border-radius: 4px;
            color: #ddd;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 11px;
        }

        .plan-qa-view-header-btn:hover {
            background: #3AACDE;
            border-color: #3AACDE;
            color: #ffffff;
        }

        /* 视图容器 */
        .plan-qa-view-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            min-height: 0;
            background: #000000;
        }

        .plan-qa-view-canvas {
            width: 100%;
            height: 100%;
            background: #000000;
            display: block;
        }

        /* 视图工具栏 */
        .plan-qa-view-toolbar {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            padding: 6px 10px;
            border-radius: 6px;
            display: flex;
            gap: 6px;
            z-index: 20;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        .plan-qa-view-toolbar-btn {
            width: 32px;
            height: 32px;
            background: transparent;
            border: 1px solid #555555;
            border-radius: 4px;
            color: #ddd;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 13px;
        }

        .plan-qa-view-toolbar-btn:hover {
            background: #3AACDE;
            border-color: #3AACDE;
            color: #ffffff;
        }

        .plan-qa-view-toolbar-btn.active {
            background: #3AACDE;
            border-color: #3AACDE;
            color: #ffffff;
        }

        /* 视图底部信息栏 */
        .plan-qa-view-footer {
            height: 24px;
            background: #2a2a2a;
            border-top: 1px solid #404040;
            display: flex;
            align-items: center;
            padding: 0 12px;
            flex-shrink: 0;
            z-index: 10;
        }

        .plan-qa-view-footer-label {
            color: #888888;
            font-size: 11px;
        }

        .plan-qa-view-footer-left {
            display: flex;
            align-items: center;
            gap: 16px;
            color: #888888;
            font-size: 12px;
            padding: 0 12px;
        }

        .plan-qa-view-footer-right {
            display: flex;
            align-items: center;
            gap: 16px;
            color: #888888;
            font-size: 12px;
            padding: 0 12px;
        }

        .plan-qa-view-footer-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .plan-qa-view-footer-item i {
            font-size: 11px;
        }

        /* 十字准线 */
        .plan-qa-crosshair {
            position: absolute;
            pointer-events: none;
            z-index: 15;
        }

        .plan-qa-crosshair-horizontal {
            top: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: rgba(0, 122, 204, 0.8);
            transform-origin: center;
        }

        .plan-qa-crosshair-vertical {
            top: 0;
            left: 0;
            width: 1px;
            height: 100%;
            background: rgba(0, 122, 204, 0.8);
            transform-origin: center;
        }

        /* 图表标签页 */
        .plan-qa-chart-tabs {
            display: flex;
            gap: 4px;
            padding: 8px 12px;
            background: #1a1a1a;
            border-bottom: 1px solid #404040;
        }

        .plan-qa-chart-tab {
            padding: 6px 16px;
            background: #2a2a2a;
            border: 1px solid #404040;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            color: #ddd;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .plan-qa-chart-tab:hover {
            background: #2A2A2A;
            color: #ffffff;
        }

        .plan-qa-chart-tab.active {
            background: #3AACDE;
            border-color: #3AACDE;
            color: #ffffff;
        }

        .plan-qa-chart-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .plan-qa-chart-tab-content {
            display: none;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        .plan-qa-chart-tab-content.active {
            display: block;
        }

        /* DVH图表区域 */
        .plan-qa-dvh-chart {
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            position: relative;
        }

        /* 表格标签页 */
        .plan-qa-table-tabs {
            display: flex;
            gap: 4px;
            padding: 8px 12px;
            background: #1a1a1a;
            border-bottom: 1px solid #404040;
        }

        .plan-qa-table-tab {
            padding: 6px 16px;
            background: #2a2a2a;
            border: 1px solid #404040;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            color: #ddd;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .plan-qa-table-tab:hover {
            background: #2A2A2A;
            color: #ffffff;
        }

        .plan-qa-table-tab.active {
            background: #3AACDE;
            border-color: #3AACDE;
            color: #ffffff;
        }

        .plan-qa-table-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .plan-qa-table-tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .plan-qa-table-tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* 射束列表表格 */
        .plan-qa-beam-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .plan-qa-beam-table thead {
            background: #2a2a2a;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .plan-qa-beam-table th {
            padding: 8px 10px;
            text-align: left;
            color: #ffffff;
            font-weight: 600;
            border-bottom: 1px solid #404040;
        }

        .plan-qa-beam-table td {
            padding: 8px 10px;
            color: #ddd;
            border-bottom: 1px solid #2A2A2A;
        }

        .plan-qa-beam-table tbody tr:hover {
            background: #2a2a2a;
        }

        /* 剂量统计表格 */
        .plan-qa-dose-stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .plan-qa-dose-stats-table th,
        .plan-qa-dose-stats-table td {
            padding: 8px 10px;
            text-align: left;
            color: #ddd;
            border-bottom: 1px solid #2A2A2A;
        }

        .plan-qa-dose-stats-table th {
            background: #2a2a2a;
            color: #ffffff;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        /* 右键菜单 */
        .plan-qa-context-menu {
            position: fixed;
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 4px;
            padding: 4px 0;
            z-index: 10000;
            min-width: 150px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            display: none;
        }

        .plan-qa-context-menu-item {
            padding: 8px 16px;
            color: #ddd;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .plan-qa-context-menu-item:hover {
            background: #3AACDE;
            color: #ffffff;
        }

        .plan-qa-context-menu-item i {
            width: 20px;
            margin-right: 8px;
        }

        /* 创建QA计划弹窗样式 */
        .create-qa-plan-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
        }

        .create-qa-plan-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
        }

        .create-qa-plan-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2a2a2a;
            border: 1px solid #404040;
            border-radius: 8px;
            width: 900px;
            max-width: 95vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 10001;
        }

        .create-qa-plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #404040;
            flex-shrink: 0;
        }

        .create-qa-plan-header h3 {
            margin: 0;
            color: #ffffff;
            font-size: 16px;
            font-weight: 600;
        }

        .create-qa-plan-close {
            background: transparent;
            border: none;
            color: #ddd;
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
            transition: color 0.3s;
        }

        .create-qa-plan-close:hover {
            color: #ffffff;
        }

        .create-qa-plan-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }

        .create-qa-plan-section {
            margin-bottom: 20px;
        }

        .create-qa-plan-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #404040;
        }

        .create-qa-plan-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .create-qa-plan-info-item {
            display: flex;
            gap: 8px;
        }

        .create-qa-plan-info-label {
            color: #888888;
            font-size: 13px;
            min-width: 80px;
        }

        .create-qa-plan-info-value {
            color: #ddd;
            font-size: 13px;
        }

        .create-qa-plan-main-content {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .create-qa-plan-left-column,
        .create-qa-plan-right-column {
            flex: 1;
        }

        .create-qa-plan-form-group {
            margin-bottom: 16px;
        }

        .create-qa-plan-label {
            display: block;
            color: #ddd;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .create-qa-plan-label-small {
            display: inline-block;
            color: #ddd;
            font-size: 12px;
            min-width: 80px;
        }

        .create-qa-plan-input,
        .create-qa-plan-select {
            width: 100%;
            padding: 8px 12px;
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 4px;
            color: #ffffff;
            font-size: 13px;
            box-sizing: border-box;
        }

        .create-qa-plan-input:focus,
        .create-qa-plan-select:focus {
            outline: none;
            border-color: #3AACDE;
        }

        .create-qa-plan-input:disabled {
            background: #2a2a2a;
            color: #666666;
            cursor: not-allowed;
        }

        .create-qa-plan-select-small {
            padding: 6px 8px;
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 4px;
            color: #ffffff;
            font-size: 12px;
            margin-left: 8px;
        }

        .create-qa-plan-select-small:focus {
            outline: none;
            border-color: #3AACDE;
        }

        .create-qa-plan-radio-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .create-qa-plan-radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .create-qa-plan-radio-item input[type="radio"] {
            margin: 0;
            cursor: pointer;
        }

        .create-qa-plan-radio-item label {
            color: #ddd;
            font-size: 13px;
            cursor: pointer;
        }

        .create-qa-plan-input-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .create-qa-plan-input-small {
            padding: 6px 8px;
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 4px;
            color: #ffffff;
            font-size: 12px;
            width: 80px;
        }

        .create-qa-plan-input-small:focus {
            outline: none;
            border-color: #3AACDE;
        }

        .create-qa-plan-input-inline {
            padding: 4px 6px;
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 4px;
            color: #ffffff;
            font-size: 12px;
            width: 80px;
            margin-left: 8px;
        }

        .create-qa-plan-input-inline:focus {
            outline: none;
            border-color: #3AACDE;
        }

        .create-qa-plan-unit {
            color: #888888;
            font-size: 12px;
        }

        .create-qa-plan-unit-inline {
            color: #888888;
            font-size: 12px;
            margin-left: 4px;
        }

        .create-qa-plan-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .create-qa-plan-checkbox-item input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }

        .create-qa-plan-checkbox-item label {
            color: #ddd;
            font-size: 13px;
            cursor: pointer;
        }

        .create-qa-plan-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 20px;
            border-top: 1px solid #404040;
            flex-shrink: 0;
        }

        .create-qa-plan-btn {
            padding: 8px 20px;
            border: 1px solid #404040;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .create-qa-plan-btn-cancel {
            background: #404040;
            color: #ddd;
        }

        .create-qa-plan-btn-cancel:hover {
            background: #505050;
            color: #ffffff;
        }

        .create-qa-plan-btn-confirm {
            background: #3AACDE;
            color: #ffffff;
            border-color: #3AACDE;
        }

        .create-qa-plan-btn-confirm:hover {
            background: #0099ff;
            border-color: #0099ff;
        }
    </style>
</head>
<body>
    <div class="plan-qa-content">
        <!-- 左侧面板 -->
        <div class="image-left-panel" id="qaLeftPanel">
            <div class="resizer-handle" id="qaResizerHandle"></div>
            <div class="patient-info-header">
                <div class="patient-avatar"><i class="fas fa-user"></i></div>
                <div class="patient-details">
                    <div class="patient-name">Zhangguang (ID:Y87342987)</div>
                    <div class="patient-info">1967-10-08 M</div>
                </div>
                <div class="collapse-toggle" id="qaLeftPanelToggle"><i class="fas fa-chevron-left"></i></div>
            </div>
            <div class="content-area">
                <div class="vertical-nav-buttons">
                    <button class="nav-btn active" data-panel="qa-sequence"><i class="fas fa-sitemap"></i><span>序列树</span></button>
                    <button class="nav-btn" data-panel="qa-roi"><i class="fas fa-shapes"></i><span>ROI</span></button>
                    <button class="nav-btn" data-panel="qa-poi"><i class="fas fa-crosshairs"></i><span>POI</span></button>
                    <button class="nav-btn" data-panel="qa-iso"><i class="fas fa-bullseye"></i><span>ISO</span></button>
                </div>
                <div class="panel-content">
                    <div class="panel-section active" id="qa-sequence-panel">
                        <div class="sequence-tree-container" id="qaSequenceContainer">
                            <div class="loading-indicator">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>加载序列树组件...</span>
                            </div>
                        </div>
                    </div>
                    <div class="panel-section" id="qa-roi-panel">
                        <div class="roi-panel-container" id="qaRoiContainer">
                            <div class="loading-indicator">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>加载ROI组件...</span>
                            </div>
                        </div>
                    </div>
                    <div class="panel-section" id="qa-poi-panel">
                        <div class="poi-panel-container" id="qaPoiContainer">
                            <div class="loading-indicator">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>加载POI组件...</span>
                            </div>
                        </div>
                    </div>
                    <div class="panel-section" id="qa-iso-panel">
                        <div class="poi-panel-container" id="qaIsoContainer">
                            <div class="loading-indicator">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>加载ISO组件...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主视图区域 -->
        <div class="plan-qa-main-view" id="qaMainView">
            <!-- 工具栏 -->
            <div class="plan-qa-toolbar expanded" id="qaToolbar">
                <button class="plan-qa-toolbar-toggle" id="qaToolbarToggle" title="展开/收起">
                    <i class="fas fa-chevron-up"></i>
                </button>
                <div class="plan-qa-toolbar-content">
                    <div class="plan-qa-toolbar-section">
                        <button class="plan-qa-toolbar-btn" id="qaCreatePlanBtn">
                            <i class="fas fa-plus-circle"></i>
                            <span>创建QA计划</span>
                        </button>
                        <button class="plan-qa-toolbar-btn" id="qaAutoQaBtn">
                            <i class="fas fa-robot"></i>
                            <span>自动QA</span>
                        </button>
                        <button class="plan-qa-toolbar-btn" id="qaAddBedBtn">
                            <i class="fas fa-bed"></i>
                            <span>添加床结构</span>
                        </button>
                        <button class="plan-qa-toolbar-btn" id="qaDoseCalcBtn">
                            <i class="fas fa-calculator"></i>
                            <span>剂量计算</span>
                        </button>
                        <button class="plan-qa-toolbar-btn" id="qaExportPlaneBtn">
                            <i class="fas fa-file-export"></i>
                            <span>导出平面剂量</span>
                        </button>
                        <button class="plan-qa-toolbar-btn" id="qaLineDoseBtn">
                            <i class="fas fa-chart-line"></i>
                            <span>线剂量分布</span>
                        </button>
                        <button class="plan-qa-toolbar-btn" id="qaCreateReportBtn">
                            <i class="fas fa-file-alt"></i>
                            <span>创建QA报告</span>
                        </button>
                        <button class="plan-qa-toolbar-btn" id="qaApproveBtn">
                            <i class="fas fa-lock"></i>
                            <span>QA计划审批/解锁</span>
                        </button>
                        <div style="display: flex; align-items: center; gap: 8px; margin-left: 20px;">
                            <span style="color: #ddd; font-size: 12px;">剂量显示:</span>
                            <select class="plan-qa-toolbar-select" id="qaDoseDisplaySelect" style="padding: 4px 8px; background: #404040; border: 1px solid #555555; border-radius: 4px; color: #ddd; font-size: 12px;">
                                <option value="all">单分次所有射束</option>
                                <option value="single">单次射束</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 主内容区域：左右分栏 -->
            <div class="plan-qa-main-content">
                <!-- 左侧：三个2D视图 -->
                <div class="plan-qa-2d-views">
                    <!-- 上半部分：Axial视图 -->
                    <div class="plan-qa-axial-view" style="position: relative;">
                        <div id="qaAxialContainer" style="width: 100%; height: 100%;"></div>
                    </div>
                    
                    <!-- 分隔条 -->
                    <div class="plan-qa-view-resizer" id="qaViewResizer"></div>
                    
                    <!-- 下半部分：Sagittal和Coronal视图 -->
                    <div class="plan-qa-bottom-views">
                        <!-- Sagittal视图 -->
                        <div class="plan-qa-sagittal-view" style="position: relative;">
                            <div id="qaSagittalContainer" style="width: 100%; height: 100%;"></div>
                        </div>
                        
                        <!-- 垂直分隔条 -->
                        <div class="plan-qa-view-resizer vertical" id="qaBottomViewsResizer"></div>
                        
                        <!-- Coronal视图 -->
                        <div class="plan-qa-coronal-view" style="position: relative;">
                            <div id="qaCoronalContainer" style="width: 100%; height: 100%;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 右侧分隔条 -->
                <div class="plan-qa-view-resizer vertical" id="qaMainResizer"></div>
                
                <!-- 右侧：图表和表格区域 -->
                <div class="plan-qa-right-panel">
                    <!-- 上半部分：图表区域 -->
                    <div class="plan-qa-chart-panel">
                        <div class="plan-qa-chart-tabs">
                            <button class="plan-qa-chart-tab active" data-chart="dvh">DVH</button>
                            <button class="plan-qa-chart-tab" data-chart="bev">BEV</button>
                            <button class="plan-qa-chart-tab" data-chart="3d">3D</button>
                            <button class="plan-qa-chart-tab" data-chart="let">LET</button>
                        </div>
                        <div class="plan-qa-chart-content">
                            <div class="plan-qa-chart-tab-content active" id="qaDvhChart">
                                <canvas class="plan-qa-dvh-chart" id="qaDvhCanvas"></canvas>
                            </div>
                            <div class="plan-qa-chart-tab-content" id="qaBevChart">
                                <div id="qaBevViewContainer" style="width: 100%; height: 100%;"></div>
                            </div>
                            <div class="plan-qa-chart-tab-content" id="qa3dChart">
                                <div style="width: 100%; height: 100%; background: #1a1a1a; display: flex; align-items: center; justify-content: center; color: #888888;">
                                    3D视图
                                </div>
                            </div>
                            <div class="plan-qa-chart-tab-content" id="qaLetChart">
                                <div style="width: 100%; height: 100%; background: #1a1a1a; display: flex; align-items: center; justify-content: center; color: #888888;">
                                    LET视图
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 分隔条 -->
                    <div class="plan-qa-panel-resizer" id="qaPanelResizer"></div>
                    
                    <!-- 下半部分：表格区域 -->
                    <div class="plan-qa-table-panel">
                        <div class="plan-qa-table-tabs">
                            <button class="plan-qa-table-tab" data-table="dose-stats">Dose Statistics</button>
                            <button class="plan-qa-table-tab active" data-table="beam-list">Beam List</button>
                            <button class="plan-qa-table-tab" data-table="energy-layers">Energy Layers</button>
                        </div>
                        <div class="plan-qa-table-content">
                            <!-- 剂量统计 -->
                            <div class="plan-qa-table-tab-content" id="qaDoseStatsContent">
                                <div class="dose-stats-container" id="qaDoseStatsContainer">
                                    <div class="loading-indicator">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        <span>加载剂量统计组件...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 射束列表 -->
                            <div class="plan-qa-table-tab-content active" id="qaBeamListContent">
                                <div style="flex: 1; overflow-y: auto;">
                                    <table class="plan-qa-beam-table">
                                        <thead>
                                            <tr>
                                                <th><i class="fas fa-eye"></i></th>
                                                <th>Number</th>
                                                <th>Name</th>
                                                <th>Treatment Machine</th>
                                                <th>Technology</th>
                                                <th>MU</th>
                                                <th>Gantry[*]</th>
                                                <th>Couch[*]</th>
                                                <th>Target</th>
                                            </tr>
                                        </thead>
                                        <tbody id="qaBeamListBody">
                                            <!-- 动态生成 -->
                                        </tbody>
                                    </table>
                                </div>
                                <div style="padding: 8px 12px; border-top: 1px solid #404040; display: flex; gap: 8px;">
                                    <button class="plan-qa-toolbar-btn">编辑</button>
                                    <button class="plan-qa-toolbar-btn">排序</button>
                                </div>
                            </div>
                            
                            <!-- 能量层 -->
                            <div class="plan-qa-table-tab-content" id="qaEnergyLayersContent">
                                <div style="flex: 1; overflow-y: auto; padding: 12px;">
                                    <div style="color: #888888; text-align: center; padding: 40px;">
                                        <i class="fas fa-layer-group" style="font-size: 48px; margin-bottom: 12px; display: block;"></i>
                                        <span>能量层内容</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右键菜单 -->
        <div class="plan-qa-context-menu" id="qaContextMenu">
            <div class="plan-qa-context-menu-item" data-action="line-dose">
                <i class="fas fa-chart-line"></i>
                <span>线剂量查看</span>
            </div>
            <div class="plan-qa-context-menu-item" data-action="create-dose-point">
                <i class="fas fa-crosshairs"></i>
                <span>创建剂量规格点</span>
            </div>
        </div>
    </div>

    <!-- 组件引用 -->
    <script src="../components/ROIComponent.js"></script>
    <script src="../components/POIComponent.js"></script>
    <script src="../components/SequenceTreeComponent.js"></script>
    <script src="../components/BeamListComponent.js"></script>
    <script src="../components/LineDoseDistributionComponent.js"></script>
    <script src="../components/CreateQaPlanComponent.js"></script>
    <script src="../components/DoseStatisticsComponent.js"></script>
    <script src="../components/PlanDesignView2DComponent.js"></script>

    <script>
        // 初始化左侧面板导航
        function initializeQaNavButtons() {
            const navButtons = document.querySelectorAll('.plan-qa-content .nav-btn');
            const panelSections = document.querySelectorAll('.plan-qa-content .panel-section');
            
            navButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const panelId = btn.getAttribute('data-panel');
                    
                    // 移除所有active类
                    navButtons.forEach(b => b.classList.remove('active'));
                    panelSections.forEach(s => s.classList.remove('active'));
                    
                    // 添加active类
                    btn.classList.add('active');
                    const targetPanel = document.getElementById(panelId + '-panel');
                    if (targetPanel) {
                        targetPanel.classList.add('active');
                        
                        // 根据面板类型动态加载组件
                        if (panelId === 'qa-sequence') {
                            initQaSequenceComponent();
                        } else if (panelId === 'qa-roi') {
                            initQaRoiComponent();
                        } else if (panelId === 'qa-poi') {
                            initQaPoiComponent();
                        } else if (panelId === 'qa-iso') {
                            initQaISOComponent();
                        }
                    }
                });
            });
        }

        // 初始化序列树组件
        function initQaSequenceComponent() {
            const sequenceContainer = document.getElementById('qaSequenceContainer');
            if (!sequenceContainer) return;
            
            if (sequenceContainer.dataset.inited === 'true') return;
            
            if (window.SequenceTreeComponent) {
                try {
                    new SequenceTreeComponent('qaSequenceContainer', {
                        prefix: 'qa-',
                        onSequenceSelect: function(sequenceName, element) {
                            console.log('QA序列选择:', sequenceName);
                        },
                        onFileSelect: function(fileName, element) {
                            console.log('QA文件选择:', fileName);
                        },
                        showFileInfo: true
                    });
                    sequenceContainer.dataset.inited = 'true';
                } catch (e) {
                    console.warn('初始化QA序列树组件失败:', e);
                }
            } else {
                console.warn('SequenceTreeComponent 尚未加载');
            }
        }

        // 初始化ROI组件
        function initQaRoiComponent() {
            const roiContainer = document.getElementById('qaRoiContainer');
            if (!roiContainer) return;
            
            if (roiContainer.dataset.inited === 'true') return;
            
            if (window.ROIComponent) {
                try {
                    new ROIComponent('qaRoiContainer', {
                        prefix: 'qa-',
                        onROISelect: function(roiName, element) {
                            console.log('QA ROI选择:', roiName);
                        }
                    });
                    roiContainer.dataset.inited = 'true';
                } catch (e) {
                    console.warn('初始化QA ROI组件失败:', e);
                }
            } else {
                console.warn('ROIComponent 尚未加载');
            }
        }

        // 初始化POI组件
        function initQaPoiComponent() {
            const poiContainer = document.getElementById('qaPoiContainer');
            if (!poiContainer) return;
            
            if (poiContainer.dataset.inited === 'true') return;
            
            if (window.POIComponent) {
                try {
                    new POIComponent('qaPoiContainer', {
                        prefix: 'qa-',
                        onPOISelect: function(poiName, element) {
                            console.log('QA POI选择:', poiName);
                        }
                    });
                    poiContainer.dataset.inited = 'true';
                } catch (e) {
                    console.warn('初始化QA POI组件失败:', e);
                }
            } else {
                console.warn('POIComponent 尚未加载');
            }
        }

        // 初始化ISO组件
        function initQaISOComponent() {
            const isoContainer = document.getElementById('qaIsoContainer');
            if (!isoContainer) return;
            
            if (isoContainer.dataset.inited === 'true') return;
            
            if (window.ISOComponent) {
                try {
                    new ISOComponent('qaIsoContainer', {
                        prefix: 'qa-',
                        onISOSelect: function(isoName, element) {
                            console.log('QA ISO选择:', isoName);
                        },
                        onToolClick: function(buttonId, button) {
                            console.log('QA ISO工具点击:', buttonId);
                        }
                    });
                    isoContainer.dataset.inited = 'true';
                } catch (e) {
                    console.warn('初始化QA ISO组件失败:', e);
                }
            } else {
                console.warn('ISOComponent 尚未加载');
            }
        }

        // 初始化左侧面板折叠
        function initializeQaLeftPanelToggle() {
            const toggleBtn = document.getElementById('qaLeftPanelToggle');
            const leftPanel = document.getElementById('qaLeftPanel');
            const toolbar = document.getElementById('qaToolbar');
            
            if (toggleBtn && leftPanel) {
                toggleBtn.addEventListener('click', () => {
                    leftPanel.classList.toggle('collapsed');
                    
                    const icon = toggleBtn.querySelector('i');
                    if (icon) {
                        icon.classList.toggle('fa-chevron-left');
                        icon.classList.toggle('fa-chevron-right');
                    }
                    
                    // 同步更新工具栏位置
                    if (toolbar) {
                        if (leftPanel.classList.contains('collapsed')) {
                            toolbar.style.left = '60px';
                            toolbar.style.width = 'calc(100vw - 60px)';
                        } else {
                            const leftWidth = leftPanel.getBoundingClientRect().width || 350;
                            toolbar.style.left = leftWidth + 'px';
                            toolbar.style.width = `calc(100vw - ${leftWidth}px)`;
                        }
                    }
                });
            }
        }

        // 初始化左侧面板拖拽调整大小
        function initializeQaLeftPanelResizer() {
            const resizer = document.getElementById('qaResizerHandle');
            const leftPanel = document.getElementById('qaLeftPanel');
            const mainView = document.getElementById('qaMainView');
            
            if (!resizer || !leftPanel) return;
            
            let isResizing = false;
            
            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.addEventListener('mousemove', handleResize);
                document.addEventListener('mouseup', stopResize);
                e.preventDefault();
            });
            
            function handleResize(e) {
                if (!isResizing) return;
                const newWidth = e.clientX;
                const minWidth = 200;
                const maxWidth = 600;
                
                if (newWidth >= minWidth && newWidth <= maxWidth) {
                    leftPanel.style.width = newWidth + 'px';
                    const toolbar = document.getElementById('qaToolbar');
                    if (toolbar) {
                        toolbar.style.left = newWidth + 'px';
                        toolbar.style.width = `calc(100vw - ${newWidth}px)`;
                    }
                }
            }
            
            function stopResize() {
                isResizing = false;
                document.removeEventListener('mousemove', handleResize);
                document.removeEventListener('mouseup', stopResize);
            }
        }

        // 初始化图表标签切换
        function initializeQaChartTabs() {
            const tabs = document.querySelectorAll('.plan-qa-chart-tab');
            const contents = document.querySelectorAll('.plan-qa-chart-tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetChart = tab.getAttribute('data-chart');
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    const targetContent = document.getElementById('qa' + targetChart.charAt(0).toUpperCase() + targetChart.slice(1) + 'Chart');
                    if (targetContent) {
                        targetContent.classList.add('active');
                        
                        // 如果是BEV视图，初始化BEV组件
                        if (targetChart === 'bev') {
                            setTimeout(() => {
                                if (typeof initializeQaPlanBEVView === 'function') {
                                    initializeQaPlanBEVView();
                                }
                            }, 50);
                        }
                    }
                });
            });
        }

        // 初始化表格标签切换
        function initializeQaTableTabs() {
            const tabs = document.querySelectorAll('.plan-qa-table-tab');
            const contents = document.querySelectorAll('.plan-qa-table-tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTable = tab.getAttribute('data-table');
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    // 处理ID生成：dose-stats -> qaDoseStatsContent
                    let contentId = 'qa';
                    const parts = targetTable.split('-');
                    parts.forEach(part => {
                        contentId += part.charAt(0).toUpperCase() + part.slice(1);
                    });
                    contentId += 'Content';
                    
                    const targetContent = document.getElementById(contentId);
                    if (targetContent) {
                        targetContent.classList.add('active');
                        
                        // 初始化剂量统计组件
                        if (targetTable === 'dose-stats') {
                            initQaDoseStatsComponent();
                        }
                    }
                });
            });
        }

        // 计划QA模块 - 剂量统计组件实例
        let qaDoseStatsComponent = null;

        // 初始化计划QA模块的剂量统计组件
        function initQaDoseStatsComponent() {
            const container = document.getElementById('qaDoseStatsContainer');
            if (!container) return;

            // 如果已经初始化，直接返回
            if (container.dataset.inited === 'true') {
                return;
            }

            if (typeof DoseStatisticsComponent === 'undefined') {
                console.error('DoseStatisticsComponent is not loaded');
                return;
            }

            try {
                qaDoseStatsComponent = new DoseStatisticsComponent('qaDoseStatsContainer', {
                    showDoseType: false, // 计划QA模块不显示剂量类型列
                    getGlobalStats: () => {
                        // TODO: 从实际数据源获取全局统计
                        return [
                            {
                                id: 'maxDose1',
                                visible: true,
                                color: '#ff0000',
                                statisticItem: '最大剂量点',
                                relativeDosePercentage: 112.31,
                                targetDose: 4500.00,
                                dose: 5054.15,
                                x: 4.34,
                                y: -1.97,
                                z: 0.00
                            }
                        ];
                    },
                    getRoiStats: () => {
                        // TODO: 从实际数据源获取ROI统计
                        return [
                            {
                                name: 'p_r10',
                                color: '#ff00ff',
                                volume: 156.58,
                                minDose: 0.00,
                                maxDose: 27231.49,
                                avgDose: 10366.65,
                                targetDose: null,
                                targetDoseCoverageVolume: null,
                                targetDoseCoverageRatio: null
                            }
                        ];
                    },
                    getPoiStats: () => {
                        // TODO: 从实际数据源获取POI统计
                        return [
                            {
                                name: 'Point1',
                                color: '#ff0000',
                                dose: 15576.95,
                                x: 11.40,
                                y: -0.25,
                                z: 23.03
                            }
                        ];
                    },
                    onExport: (data) => {
                        // TODO: 实现Excel导出功能
                        console.log('导出剂量统计:', data);
                        qaDoseStatsComponent.defaultExportToExcel({
                            planName: 'PlanA',
                            patientId: 'Y87342987',
                            patientName: 'Zhangguang',
                            comparisonMode: null
                        });
                    }
                });

                container.dataset.inited = 'true';
            } catch (error) {
                console.error('Failed to initialize DoseStatisticsComponent:', error);
            }
        }

        // 初始化2D视图右键菜单
        function initializeQaContextMenu() {
            const canvas = document.getElementById('qaMainCanvas');
            const contextMenu = document.getElementById('qaContextMenu');
            
            if (!canvas || !contextMenu) return;
            
            canvas.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                contextMenu.style.display = 'block';
                contextMenu.style.left = e.pageX + 'px';
                contextMenu.style.top = e.pageY + 'px';
            });
            
            document.addEventListener('click', () => {
                contextMenu.style.display = 'none';
            });
            
            // 右键菜单项点击
            contextMenu.querySelectorAll('.plan-qa-context-menu-item').forEach(item => {
                item.addEventListener('click', () => {
                    const action = item.getAttribute('data-action');
                    handleContextMenuAction(action);
                    contextMenu.style.display = 'none';
                });
            });
        }

        // 处理右键菜单操作
        function handleContextMenuAction(action) {
            switch (action) {
                case 'line-dose':
                    openQaLineDoseModal();
                    break;
                case 'create-dose-point':
                    console.log('创建剂量规格点');
                    break;
            }
        }

        // 打开线剂量分布弹窗
        function openQaLineDoseModal() {
            if (window.LineDoseDistributionComponent) {
                // 关闭已存在的弹窗
                const existingModal = document.querySelector('.line-dose-modal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                try {
                    const modal = document.createElement('div');
                    modal.className = 'line-dose-modal';
                    document.body.appendChild(modal);
                    
                    new LineDoseDistributionComponent(modal, {
                        onClose: () => {
                            modal.remove();
                        },
                        onExport: (lines, plane) => {
                            console.log('导出线剂量:', lines, plane);
                        },
                        getCurrentPlanName: () => {
                            return 'QA计划';
                        },
                        getCurrentSlice: () => {
                            return { axial: 100, coronal: 100, sagittal: 100 };
                        },
                        getCrosshairPosition: () => {
                            return { x: 0, y: 0, z: 0 };
                        }
                    });
                } catch (error) {
                    console.error('创建线剂量分布组件失败:', error);
                }
            } else {
                console.warn('LineDoseDistributionComponent 尚未加载');
            }
        }

        // 初始化工具栏展开/收起
        function initializeQaToolbarToggle() {
            const toggleBtn = document.getElementById('qaToolbarToggle');
            const toolbar = document.getElementById('qaToolbar');
            const mainView = document.getElementById('qaMainView');
            
            if (!toggleBtn || !toolbar) return;
            
            toggleBtn.addEventListener('click', () => {
                toolbar.classList.toggle('expanded');
                toolbar.classList.toggle('collapsed');
                
                // 更新图标
                const icon = toggleBtn.querySelector('i');
                if (icon) {
                    if (toolbar.classList.contains('collapsed')) {
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                    } else {
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                    }
                }
                
                // 调整主视图区域的padding-top
                if (mainView) {
                    if (toolbar.classList.contains('collapsed')) {
                        mainView.style.paddingTop = '40px';
                    } else {
                        mainView.style.paddingTop = '70px';
                    }
                }
            });
        }

        // 创建QA计划组件实例
        let createQaPlanComponent = null;

        // 初始化工具栏按钮
        function initializeQaToolbar() {
            // 创建QA计划
            const createBtn = document.getElementById('qaCreatePlanBtn');
            if (createBtn) {
                createBtn.addEventListener('click', () => {
                    if (!createQaPlanComponent) {
                        createQaPlanComponent = new CreateQaPlanComponent({
                            onConfirm: (formData) => {
                                console.log('创建QA计划确认:', formData);
                                // TODO: 处理创建QA计划的逻辑
                            },
                            onCancel: () => {
                                console.log('取消创建QA计划');
                            },
                            getTreatmentPlan: () => {
                                // TODO: 从实际数据源获取治疗计划信息
                                return {
                                    planName: 'DCA-HA-0408',
                                    planImage: 'CT 1',
                                    patientPosition: 'HFS',
                                    treatmentMachine: 'Halcyon_1122',
                                    planner: 'zhuangxiubin',
                                    doseGrid: {
                                        rl: '0.30',
                                        is: '0.30',
                                        pa: '0.30'
                                    }
                                };
                            },
                            getPoiList: () => {
                                // TODO: 从实际数据源获取POI列表
                                return ['POI1', 'POI2', 'POI3'];
                            },
                            getRoiList: () => {
                                // TODO: 从实际数据源获取ROI列表
                                return ['PTV', 'OAR1', 'OAR2'];
                            }
                        });
                    }
                    createQaPlanComponent.show();
                });
            }
            
            // 自动QA
            const autoQaBtn = document.getElementById('qaAutoQaBtn');
            if (autoQaBtn) {
                autoQaBtn.addEventListener('click', () => {
                    console.log('自动QA');
                });
            }
            
            // 添加床结构
            const addBedBtn = document.getElementById('qaAddBedBtn');
            if (addBedBtn) {
                addBedBtn.addEventListener('click', () => {
                    console.log('添加床结构');
                });
            }
            
            // 剂量计算
            const doseCalcBtn = document.getElementById('qaDoseCalcBtn');
            if (doseCalcBtn) {
                doseCalcBtn.addEventListener('click', () => {
                    console.log('剂量计算');
                });
            }
            
            // 导出平面剂量
            const exportPlaneBtn = document.getElementById('qaExportPlaneBtn');
            if (exportPlaneBtn) {
                exportPlaneBtn.addEventListener('click', () => {
                    console.log('导出平面剂量');
                });
            }
            
            // 线剂量分布
            const lineDoseBtn = document.getElementById('qaLineDoseBtn');
            if (lineDoseBtn) {
                lineDoseBtn.addEventListener('click', () => {
                    openQaLineDoseModal();
                });
            }
            
            // 创建QA报告
            const createReportBtn = document.getElementById('qaCreateReportBtn');
            if (createReportBtn) {
                createReportBtn.addEventListener('click', () => {
                    console.log('创建QA报告');
                });
            }
            
            // QA计划审批/解锁
            const approveBtn = document.getElementById('qaApproveBtn');
            if (approveBtn) {
                approveBtn.addEventListener('click', () => {
                    console.log('QA计划审批/解锁');
                });
            }
        }

        // 渲染射束列表
        function renderQaBeamList() {
            const tbody = document.getElementById('qaBeamListBody');
            if (!tbody) return;
            
            // 模拟数据
            const beams = [
                { visible: true, number: 1, name: 'Beam1', machine: 'Machine1', technology: 'IMPT', mu: 100, gantry: 0, couch: 0, target: 'PTV' },
                { visible: true, number: 2, name: 'Beam2', machine: 'Machine1', technology: 'IMPT', mu: 120, gantry: 90, couch: 0, target: 'PTV' },
                { visible: false, number: 3, name: 'Beam3', machine: 'Machine1', technology: 'IMPT', mu: 110, gantry: 180, couch: 0, target: 'PTV' }
            ];
            
            tbody.innerHTML = beams.map(beam => `
                <tr>
                    <td>
                        <input type="checkbox" ${beam.visible ? 'checked' : ''}>
                    </td>
                    <td>${beam.number}</td>
                    <td>${beam.name}</td>
                    <td>${beam.machine}</td>
                    <td>${beam.technology}</td>
                    <td>${beam.mu}</td>
                    <td>${beam.gantry}</td>
                    <td>${beam.couch}</td>
                    <td>${beam.target}</td>
                </tr>
            `).join('');
        }

        // 渲染剂量统计
        function renderQaDoseStats() {
            const tbody = document.getElementById('qaDoseStatsBody');
            if (!tbody) return;
            
            // 模拟数据
            const stats = [
                { item: '最大剂量点', percent: '112.31', target: '4500.00', dose: '5054.15', x: '4.34', y: '-1.97' },
                { item: '目标靶区最大剂量点', percent: '112.31', target: '4500.00', dose: '5054.15', x: '4.34', y: '-1.97' },
                { item: '目标靶区最小剂量点', percent: '81.23', target: '4500.00', dose: '3655.23', x: '1.04', y: '-1.07' }
            ];
            
            tbody.innerHTML = stats.map(stat => `
                <tr>
                    <td>${stat.item}</td>
                    <td>${stat.percent}</td>
                    <td>${stat.target}</td>
                    <td>${stat.dose}</td>
                    <td>${stat.x}</td>
                    <td>${stat.y}</td>
                </tr>
            `).join('');
        }

        // 2D视图状态
        let qaViewState = {
            zoom: 1.0,
            panX: 0,
            panY: 0,
            windowWidth: 400,
            windowCenter: 40,
            currentSlice: 69,
            totalSlices: 102,
            mouseX: 0,
            mouseY: 0,
            isPanning: false,
            isMeasuring: false,
            showGrid: false,
            syncScroll: false
        };

        // 初始化2D视图画布
        function initializeQaCanvas() {
            if (window.PlanDesignView2DComponent) {
                // 初始化Axial视图
                new PlanDesignView2DComponent('qaAxialContainer', {
                    viewType: 'Axial',
                    sliceTotal: 157,
                    sliceCurrent: 57
                });
                
                // 初始化Sagittal视图
                new PlanDesignView2DComponent('qaSagittalContainer', {
                    viewType: 'Sagittal',
                    sliceTotal: 157,
                    sliceCurrent: 78
                });
                
                // 初始化Coronal视图
                new PlanDesignView2DComponent('qaCoronalContainer', {
                    viewType: 'Coronal',
                    sliceTotal: 157,
                    sliceCurrent: 89
                });
            }
            
            // 初始化DVH图表
            initializeDvhChart();
        }

        // 初始化单个canvas
        function initializeSingleCanvas(canvasId, viewType) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const container = canvas.parentElement;
            if (!container) return;
            
            const ctx = canvas.getContext('2d');
            
            function resizeCanvas() {
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                renderCanvas();
            }
            
            function renderCanvas() {
                // 清空画布
                ctx.fillStyle = '#000000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // 绘制占位内容
                ctx.fillStyle = '#666666';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(`2D视图 - ${viewType}`, canvas.width / 2, canvas.height / 2);
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        }

        // 初始化DVH图表
        function initializeDvhChart() {
            const canvas = document.getElementById('qaDvhCanvas');
            if (!canvas) return;
            
            const container = canvas.parentElement;
            if (!container) return;
            
            const ctx = canvas.getContext('2d');
            
            function resizeCanvas() {
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                renderChart();
            }
            
            function renderChart() {
                // 清空画布
                ctx.fillStyle = '#1a1a1a';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // 绘制网格
                ctx.strokeStyle = '#2A2A2A';
                ctx.lineWidth = 1;
                
                // 绘制Y轴网格
                const ySteps = 5;
                for (let i = 0; i <= ySteps; i++) {
                    const y = (canvas.height / ySteps) * i;
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                }
                
                // 绘制X轴网格
                const xSteps = 4;
                for (let i = 0; i <= xSteps; i++) {
                    const x = (canvas.width / xSteps) * i;
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
                
                // 绘制坐标轴标签
                ctx.fillStyle = '#888888';
                ctx.font = '11px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Volume [%]', 30, canvas.height / 2);
                ctx.textAlign = 'center';
                ctx.fillText('Dose [cGy(RBE)]', canvas.width / 2, canvas.height - 10);
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        }

        // DOM加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeQaNavButtons();
            initializeQaLeftPanelToggle();
            initializeQaLeftPanelResizer();
            initializeQaToolbarToggle();
            initializeQaChartTabs();
            initializeQaTableTabs();
            initializeQaContextMenu();
            initializeQaToolbar();
            initializeQaCanvas();
            renderQaBeamList();
            renderQaDoseStats();
            
            // 如果BEV标签是激活的，初始化BEV视图
            const qaBevChart = document.getElementById('qaBevChart');
            if (qaBevChart && qaBevChart.classList.contains('active')) {
                setTimeout(() => {
                    if (typeof initializeQaPlanBEVView === 'function') {
                        initializeQaPlanBEVView();
                    }
                }, 200);
            }
            
            // 默认初始化序列树组件
            setTimeout(() => {
                initQaSequenceComponent();
            }, 100);
        });
    </script>
</body>
</html>

