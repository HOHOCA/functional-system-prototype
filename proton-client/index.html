<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOZI 4.0 - 患者管理系统</title>
    <link rel="stylesheet" href="../shared/styles/styles.css">
    <link rel="stylesheet" href="../shared/styles/styles_line_dose.css">
    <link rel="stylesheet" href="../shared/styles/styles_plan_view_2d.css">
    <link rel="stylesheet" href="../shared/styles/styles_view_3d.css">
    <link rel="stylesheet" href="../shared/styles/styles_dvh.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- 组件引用 -->
    <script src="../shared/scripts/components/ROIComponent.js"></script>
    <script src="../shared/scripts/components/POIComponent.js"></script>
    <script src="../shared/scripts/components/SequenceTreeComponent.js"></script>
    <script src="../shared/scripts/components/RegistrationComponent.js"></script>
    <script src="../shared/scripts/components/CrossSectionView2DComponent.js"></script>
    <script src="scripts/ViewingFrameComponent.js"></script>
    <script src="scripts/BeamEyeViewComponent.js"></script>
    <script src="../shared/scripts/components/DVHComponent.js"></script>
    <script src="../shared/scripts/components/SpectralCTAnalysisComponent.js"></script>
    <script src="../shared/scripts/components/VirtualMonoEnergyComponent.js"></script>
    <script src="../shared/scripts/components/SPRDelineationComponent.js"></script>
    <script src="../shared/scripts/components/SpectralHistogramComponent.js"></script>
    <script src="../shared/scripts/components/SpectralLinearAnalysisComponent.js"></script>
    <script src="../shared/scripts/components/ExportPlanComponent.js"></script>
</head>
<body>
    <!-- 顶部导航栏 -->
    <header class="top-nav">
        <div class="nav-left">
            <div class="logo">MOZI-PROTON</div>
            <div class="nav-icons">
                <button class="nav-icon-btn" id="navImportBtn" title="导入">
                    <i class="fas fa-upload"></i>
                </button>
                <button class="nav-icon-btn" id="navExportBtn" title="导出">
                    <i class="fas fa-download"></i>
                </button>
                <button class="nav-icon-btn" id="navSaveBtn" title="保存">
                    <i class="fas fa-save"></i>
                </button>
                <button class="nav-icon-btn" id="navCloseBtn" title="关闭">
                <i class="fas fa-times"></i>
                </button>
                <button class="nav-icon-btn" id="navUndoBtn" title="撤销">
                    <i class="fas fa-undo"></i>
                </button>
                <button class="nav-icon-btn" id="navRedoBtn" title="恢复">
                    <i class="fas fa-redo"></i>
                </button>
                <button class="nav-icon-btn" id="navSettingsBtn" title="设置">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
        
        <div class="nav-center">
            <nav class="main-nav">
                <a href="#" class="nav-item active" data-module="patient">患者管理</a>
                <a href="#" class="nav-item" data-module="image">图像处理</a>
                <a href="#" class="nav-item" data-module="target">靶区勾画</a>
                <a href="#" class="nav-item" data-module="plan">计划设计</a>
                <a href="#" class="nav-item" data-module="optimization">计划优化</a>
                <a href="#" class="nav-item" data-module="evaluation">计划评估</a>
                <a href="#" class="nav-item" data-module="qa">计划QA</a>
            </nav>
        </div>
        
        <div class="nav-right">
            <i class="fas fa-cog"></i>
            <i class="fas fa-bars"></i>
            <div class="user-profile">
                张三 <i class="fas fa-chevron-down"></i>
            </div>
            <div class="window-controls">
                <button class="window-control-btn" title="最小化">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <line x1="3" y1="8" x2="13" y2="8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                </button>
                <button class="window-control-btn close-btn" title="关闭">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <line x1="4" y1="4" x2="12" y2="12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        <line x1="12" y1="4" x2="4" y2="12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>


    <!-- 主内容区域 -->
    <main class="main-content">
        <!-- 图像处理界面 -->
        <div class="image-processing-content" id="imageProcessingContent" style="display: none;">
            <!-- 图像处理工具栏 -->
            <div class="image-processing-toolbar" id="imageProcessingToolbar">
                <div class="toolbar-toggle">
                    <button class="toolbar-toggle-btn" id="toolbarToggleBtn">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                </div>
                <div class="toolbar-content">
                <div class="toolbar-section">
                    <button class="toolbar-btn active">
                        <i class="fas fa-layer-group"></i>
                        <span>图像融合</span>
                    </button>
                    <button class="toolbar-btn">
                        <i class="fas fa-arrows-alt"></i>
                        <span>移动</span>
                    </button>
                    <button class="toolbar-btn">
                        <i class="fas fa-sync-alt"></i>
                        <span>旋转</span>
                    </button>
                    <button class="toolbar-btn">
                        <i class="fas fa-crosshairs"></i>
                        <span>中心对齐</span>
                    </button>
                    <button class="toolbar-btn">
                        <i class="fas fa-magic"></i>
                        <span>自动对齐</span>
                    </button>
                </div>
                <div class="toolbar-section">
                    <button class="toolbar-btn">
                        <i class="fas fa-adjust"></i>
                        <span>灰度配准</span>
                    </button>
                    <button class="toolbar-btn">
                        <i class="fas fa-expand-arrows-alt"></i>
                        <span>形变配准</span>
                    </button>
                    <button class="toolbar-btn">
                        <i class="fas fa-undo"></i>
                        <span>重置配准</span>
                    </button>
                    <button class="toolbar-btn">
                        <i class="fas fa-bolt"></i>
                        <span>虚拟单能影像</span>
                    </button>
                    <button class="toolbar-btn">
                        <i class="fas fa-chart-line"></i>
                        <span>能谱CT分析</span>
                    </button>
                </div>
                </div>
            </div>
            
            <!-- 左侧面板 -->
            <div class="image-left-panel" id="imageLeftPanel">
                <!-- 拖拽手柄 -->
                <div class="resizer-handle" id="resizerHandle"></div>
                <!-- 患者信息头部 -->
                <div class="patient-info-header">
                    <div class="patient-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="patient-details">
                        <div class="patient-name">Li Shan (ID:WP4TR3)</div>
                        <div class="patient-info">1976-06-13 F</div>
                    </div>
                    <div class="collapse-toggle" id="leftPanelToggle">
                        <i class="fas fa-chevron-left"></i>
                    </div>
                </div>

                <!-- 内容区域 -->
                <div class="content-area">
                    <!-- 垂直导航按钮 -->
                    <div class="vertical-nav-buttons">
                        <button class="nav-btn active" data-panel="sequence">
                            <i class="fas fa-sitemap"></i>
                            <span>序列树</span>
                        </button>
                        <button class="nav-btn" data-panel="roi">
                            <i class="fas fa-shapes"></i>
                            <span>ROI</span>
                        </button>
                        <button class="nav-btn" data-panel="poi">
                            <i class="fas fa-crosshairs"></i>
                            <span>POI</span>
                        </button>
                        <button class="nav-btn" data-panel="registration">
                            <i class="fas fa-link"></i>
                            <span>配准</span>
                        </button>
                    </div>

                    <!-- 面板内容区域 -->
                    <div class="panel-content">
                    <!-- 序列树面板 - 使用组件引用 -->
                    <div class="panel-section active" id="sequence-panel">
                        <div class="sequence-tree-container" id="imageSequenceContainer">
                            <!-- 序列树组件将通过JavaScript动态加载 -->
                            <div class="loading-indicator">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>加载序列树组件...</span>
                        </div>
                        </div>
                    </div>
                    
                    <!-- ROI面板 - 使用组件引用 -->
                    <div class="panel-section" id="roi-panel">
                        <div class="roi-panel-container" id="imageRoiContainer">
                            <!-- ROI组件将通过JavaScript动态加载 -->
                            <div class="loading-indicator">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>加载ROI组件...</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                    <!-- POI控制面板 - 使用组件引用 -->
                    <div class="panel-section" id="poi-panel">
                        <div class="poi-panel-container" id="imagePoiContainer">
                            <!-- POI组件将通过JavaScript动态加载 -->
                            <div class="loading-indicator">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>加载POI组件...</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                    <!-- 配准面板 - 使用组件引用 -->
                    <div class="panel-section" id="registration-panel">
                        <div class="registration-container" id="imageRegistrationContainer">
                            <!-- 配准组件将通过JavaScript动态加载 -->
                            <div class="loading-indicator">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>加载配准组件...</span>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>
            
            <!-- 新建勾画模态框 -->
            <div class="modal" id="new-drawing-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>新建勾画</h3>
                        <button class="modal-close" id="new-drawing-close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="drawing-type-selection">
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="drawing-type" value="roi" checked>
                                    <span>新建ROI</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="drawing-type" value="struct">
                                    <span>新建Struct</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="drawing-form" id="roi-form">
                            <div class="form-group">
                                <label class="form-label">标签</label>
                                <div class="form-input">
                                    <input type="text" id="new-roi-label" value="Brain" class="form-text-input">
                                    <i class="fas fa-chevron-down form-dropdown-icon"></i>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label required">*名称</label>
                                <input type="text" id="new-roi-name" class="form-text-input" placeholder="请输入ROI名称">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label required">*颜色</label>
                                <div class="color-picker-container">
                                    <div class="color-preview" id="new-roi-color" style="background: #3AACDE;"></div>
                                    <button class="color-picker-btn" id="new-roi-color-picker">选择颜色</button>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label required">*类型</label>
                                <div class="form-input">
                                    <input type="text" id="new-roi-type" value="GTV" class="form-text-input">
                                    <i class="fas fa-chevron-down form-dropdown-icon"></i>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">材料</label>
                                <div class="form-input">
                                    <input type="text" id="new-roi-material" value="NONE" class="form-text-input">
                                    <i class="fas fa-chevron-down form-dropdown-icon"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="drawing-form" id="struct-form" style="display: none;">
                            <div class="form-group">
                                <label class="form-label required">*名称</label>
                                <input type="text" id="new-struct-name" class="form-text-input" placeholder="请输入Struct名称">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">描述</label>
                                <textarea id="new-struct-description" class="form-textarea" placeholder="请输入Struct描述"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" id="new-drawing-cancel">取消</button>
                        <button class="btn btn-primary" id="new-drawing-confirm">确定</button>
                    </div>
                </div>
            </div>
            
            <!-- 2+1视图显示区域 -->
            <div class="image-views">
                <!-- 轴状面视图 - 左侧大视图 -->
                <div class="image-panel axial-view">
                    <div class="panel-header">
                        <span class="view-label">2D</span>
                        </div>
                    <div class="image-container" id="imageAxialContainer"></div>
                    <div class="panel-footer">
                        <span class="view-type">Axial</span>
                    </div>
                </div>

                <!-- 右侧小视图区域 -->
                <div class="right-views">
                    <!-- 冠状面视图 - 右上 -->
                    <div class="image-panel coronal-view">
                        <div class="panel-header">
                            <span class="view-label">2D</span>
                            </div>
                        <div class="image-container" id="imageCoronalContainer"></div>
                        <div class="panel-footer">
                            <span class="view-type">Coronal</span>
                        </div>
                    </div>

                    <!-- 矢状面视图 - 右下 -->
                    <div class="image-panel sagittal-view">
                        <div class="panel-header">
                            <span class="view-label">2D</span>
                            </div>
                        <div class="image-container" id="imageSagittalContainer"></div>
                        <div class="panel-footer">
                            <span class="view-type">Sagittal</span>
                        </div>
                                </div>
                                </div>
                                    </div>
                                    </div>

        <!-- 计划评估界面（通过 iframe 加载模块页面） -->
        <div id="planEvaluationContent" style="display: none; height: calc(100vh - 60px); width: 100%; box-sizing: border-box;">
            <iframe
                id="planEvaluationFrame"
                src="modules/plan-evaluation-module.html"
                style="width: 100%; height: 100%; border: 0; background: #1a1a1a; display: block;"
                loading="lazy"
            ></iframe>
                                </div>
                                
        <!-- 计划QA界面（通过 iframe 加载模块页面） -->
        <div id="planQAContent" style="display: none; height: calc(100vh - 60px); width: 100%; box-sizing: border-box;">
            <iframe
                id="planQAFrame"
                src="modules/plan-qa-module.html"
                style="width: 100%; height: 100%; border: 0; background: #1a1a1a; display: block;"
                loading="lazy"
            ></iframe>
        </div>

        <!-- 左侧患者列表 -->
        <div class="left-panel">
            <!-- 搜索栏 -->
            <div class="search-section">
                <div class="search-box">
                    <input type="text" placeholder="请输入患者姓名或ID,点击搜索图标或按下回车键开始搜索" id="searchInput">
                    <i class="fas fa-search search-icon"></i>
                    <i class="fas fa-times clear-icon"></i>
                    <i class="fas fa-sync-alt refresh-icon"></i>
                    <i class="fas fa-cog settings-icon"></i>
                </div>
            </div>

            <!-- 患者表格 -->
            <div class="table-section">
                <table class="patient-table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-folder"></i></th>
                            <th>患者ID</th>
                            <th>姓名</th>
                            <th>性别</th>
                            <th>出生日期</th>
                            <th>年龄</th>
                            <th>医生</th>
                            <th>物理师</th>
                            <th>导入时间</th>
                            <th>保存时间</th>
                            <th>备注</th>
                        </tr>
                    </thead>
                    <tbody id="patientTableBody">
                        <!-- 患者数据将通过JavaScript动态加载 -->
                    </tbody>
                </table>
            </div>

            <!-- 分页控制 -->
            <div class="pagination-section">
                <div class="pagination-info">
                    <span>共399条</span>
                </div>
                <div class="pagination-controls">
                    <select class="page-size-select">
                        <option value="20">20条/页</option>
                        <option value="50">50条/页</option>
                        <option value="100">100条/页</option>
                        <option value="200">200条/页</option>
                    </select>
                    <div class="pagination-buttons">
                        <button class="page-btn"><i class="fas fa-chevron-left"></i></button>
                        <button class="page-btn active">1</button>
                        <button class="page-btn">2</button>
                        <button class="page-btn">3</button>
                        <span class="page-dots">...</span>
                        <button class="page-btn">7</button>
                        <button class="page-btn">8</button>
                        <button class="page-btn"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="jump-to-page">
                        <input type="number" placeholder="跳转至 第8页" min="1" max="10">
                    </div>
                </div>
            </div>

            <!-- 操作按钮 -->
            <div class="action-buttons">
                <button class="btn btn-primary">导入</button>
                <button class="btn btn-secondary">导出</button>
                <button class="btn btn-danger">删除</button>
                <button class="btn btn-secondary">编辑</button>
                <button class="btn btn-secondary">解析</button>
            </div>
        </div>

        <!-- 右侧患者详情 -->
        <div class="right-panel">
            <!-- 患者摘要 -->
            <div class="patient-summary">
                <h3>Li Shan (ID:WP4TR3)</h3>
                <p>1976-06-13 F</p>
            </div>

            <!-- 搜索框 -->
            <div class="right-search">
                <input type="text" placeholder="enter text..." id="rightSearchInput">
            </div>

            <!-- 标签页 -->
            <div class="right-tabs">
                <div class="tab-item active" data-tab="sequence">序列树</div>
                <div class="tab-item" data-tab="registration">配准</div>
            </div>

            <!-- 序列树 - 使用组件引用 -->
            <div class="sequence-tree-container" id="patientSequenceContainer">
                <!-- 序列树组件将通过JavaScript动态加载 -->
                <div class="loading-indicator">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>加载序列树组件...</span>
            </div>
            </div>

            <!-- 配准内容 - 使用组件引用 -->
            <div class="registration-container" id="patientRegistrationContainer" style="display: none;">
                <!-- 配准组件将通过JavaScript动态加载 -->
                <div class="loading-indicator">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>加载配准组件...</span>
                            </div>
                    </div>
                    
            <!-- 文件信息 - 只在序列树标签页显示 -->
            <div class="file-info" id="fileInfo">
                <h4>文件信息</h4>
                <div class="info-grid" id="imageFileInfo">
                    <div class="info-item">
                        <span class="label">扫描设备</span>
                        <span class="value">
                            <span id="scanDeviceValue">GE Discovery CT750 HD</span>
                            <button class="edit-icon-btn" id="editScanDeviceBtn" title="修改">
                                <i class="fas fa-edit"></i>
                            </button>
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="label">患者摆位</span>
                        <span class="value">HFS</span>
                    </div>
                    <div class="info-item">
                        <span class="label">图像模态</span>
                        <span class="value">CT</span>
                    </div>
                    <div class="info-item">
                        <span class="label">图像层数</span>
                        <span class="value">102</span>
                    </div>
                    <div class="info-item">
                        <span class="label">拍摄日期</span>
                        <span class="value">2019.01.03</span>
                    </div>
                    <div class="info-item">
                        <span class="label">拍摄时间</span>
                        <span class="value">17:02:12</span>
                    </div>
                    <div class="info-item">
                        <span class="label">序列号</span>
                        <span class="value">3</span>
                    </div>
                    <div class="info-item">
                        <span class="label">序列ID</span>
                        <span class="value">38467.39468.342</span>
                    </div>
                    <div class="info-item">
                        <span class="label">序列描述</span>
                        <span class="value">HearCewity</span>
                    </div>
                    <div class="info-item">
                        <span class="label">检查描述</span>
                        <span class="value">Chest Routine</span>
                    </div>
                </div>
                
                <!-- 结构相关文件信息 -->
                <div class="info-grid" id="structFileInfo" style="display: none;">
                    <div class="info-item">
                        <span class="label">数据类型</span>
                        <span class="value">RTSTRUCT</span>
                    </div>
                    <div class="info-item">
                        <span class="label">创建者</span>
                        <span class="value">Dr. Wang</span>
                    </div>
                    <div class="info-item">
                        <span class="label">创建时间</span>
                        <span class="value">2019-01-15 14:30:25</span>
                    </div>
                    <div class="info-item">
                        <span class="label">序列ID</span>
                        <span class="value">38467.39468.343</span>
                    </div>
                    <div class="info-item">
                        <span class="label">序列描述</span>
                        <span class="value">Target Delineation</span>
                    </div>
                    <div class="info-item">
                        <span class="label">检查描述</span>
                        <span class="value">Chest Routine</span>
                    </div>
                    <div class="info-item">
                        <span class="label">审批人</span>
                        <span class="value">Dr. Chen</span>
                    </div>
                    <div class="info-item">
                        <span class="label">审批时间</span>
                        <span class="value">2019-01-16 10:25:30 (YYYY-MM-DD HH:MM:SS)</span>
                    </div>
                </div>
                
                <!-- 计划相关文件信息 -->
                <div class="info-grid" id="planFileInfo" style="display: none;">
                    <div class="info-item">
                        <span class="label">计划名称</span>
                        <span class="value">Plan001</span>
                    </div>
                    <div class="info-item">
                        <span class="label">计划描述</span>
                        <span class="value">Proton Therapy Plan</span>
                    </div>
                    <div class="info-item">
                        <span class="label">治疗机器</span>
                        <span class="value">IBA Proteus One</span>
                    </div>
                    <div class="info-item">
                        <span class="label">剂量处方</span>
                        <span class="value">60.0 Gy(RBE) / 30 Fx</span>
                    </div>
                    <div class="info-item">
                        <span class="label">审批人</span>
                        <span class="value">Dr. Liu</span>
                    </div>
                    <div class="info-item">
                        <span class="label">审批时间</span>
                        <span class="value">2019-01-18 16:45:00 (YYYY-MM-DD HH:MM:SS)</span>
                    </div>
                    <div class="info-item" id="artDurationItem" style="display: none;">
                        <span class="label">ART计划总时长</span>
                        <span class="value">28 天</span>
                    </div>
                </div>
            </div>
                        
            <!-- 打开按钮 - 只在序列树标签页显示 -->
            <div class="open-section" id="openSection">
                <button class="btn btn-primary btn-open">打开</button>
            </div>
                        </div>
                        
        <!-- 靶区勾画界面 -->
        <div class="target-delineation-content" id="targetDelineationContent" style="display: none;">
            <!-- 左侧面板 -->
            <div class="image-left-panel" id="targetLeftPanel">
                <!-- 拖拽手柄 -->
                <div class="resizer-handle" id="targetResizerHandle"></div>
                <!-- 患者信息头部 -->
                <div class="patient-info-header">
                    <div class="patient-avatar">
                        <i class="fas fa-user"></i>
                            </div>
                    <div class="patient-details">
                        <div class="patient-name">Li Shan (ID:WP4TR3)</div>
                        <div class="patient-info">1976-06-13 F</div>
                        </div>
                    <div class="collapse-toggle" id="targetLeftPanelToggle">
                        <i class="fas fa-chevron-left"></i>
                    </div>
                        </div>
                        
                <!-- 内容区域 -->
                <div class="content-area">
                    <!-- 垂直导航按钮 -->
                    <div class="vertical-nav-buttons">
                        <button class="nav-btn active" data-panel="sequence">
                            <i class="fas fa-sitemap"></i>
                            <span>序列树</span>
                        </button>
                        <button class="nav-btn" data-panel="roi">
                            <i class="fas fa-shapes"></i>
                            <span>ROI</span>
                        </button>
                        <button class="nav-btn" data-panel="poi">
                            <i class="fas fa-crosshairs"></i>
                            <span>POI</span>
                        </button>
                        <button class="nav-btn" data-panel="registration">
                            <i class="fas fa-link"></i>
                            <span>配准</span>
                        </button>
                            </div>
                    
                    <!-- 面板内容区域 -->
                    <div class="panel-content">
                        <!-- 序列树面板 - 使用组件引用 -->
                        <div class="panel-section active" id="target-sequence-panel">
                            <div class="sequence-tree-container" id="targetSequenceContainer">
                                <!-- 序列树组件将通过JavaScript动态加载 -->
                                <div class="loading-indicator">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <span>加载序列树组件...</span>
                        </div>
                    </div>
                </div>
                
                        <!-- ROI面板 - 调用图像处理模块的ROI内容 -->
                        <div class="panel-section" id="target-roi-panel">
                            <div class="roi-panel-container" id="targetRoiContainer">
                                <!-- ROI内容将通过JavaScript动态加载 -->
                                <div class="loading-indicator">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <span>加载ROI内容...</span>
                                    </div>
                        </div>
                    </div>
                    
                    <!-- POI控制面板 - 使用组件引用 -->
                    <div class="panel-section" id="target-poi-panel">
                        <div class="poi-panel-container" id="targetPoiContainer">
                                <!-- POI组件将通过JavaScript动态加载 -->
                                <div class="loading-indicator">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <span>加载POI组件...</span>
                                </div>
                        </div>
                            </div>
                            
                        <!-- 配准面板 - 使用组件引用 -->
                        <div class="panel-section" id="target-registration-panel">
                            <div class="registration-container" id="targetRegistrationContainer">
                                <!-- 配准组件将通过JavaScript动态加载 -->
                                <div class="loading-indicator">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <span>加载配准组件...</span>
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
                                </div>
                                
            <!-- 右侧内容区域 -->
            <div class="right-content-area">
                <!-- 靶区勾画工具栏 -->
                <div class="target-delineation-toolbar expanded" id="targetDelineationToolbar">
                    <div class="toolbar-toggle">
                        <button class="toolbar-toggle-btn" id="targetToolbarToggleBtn">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                    </div>
                    <div class="toolbar-content">
                        <!-- 第一组：基础勾画工具 -->
                        <div class="toolbar-section">
                            <button class="toolbar-btn active" title="画刷 (B)">
                                <i class="fas fa-paint-brush"></i>
                                <span>画刷</span>
                            </button>
                            <button class="toolbar-btn" title="画笔 (P)">
                                <i class="fas fa-pen"></i>
                                <span>画笔</span>
                            </button>
                            <button class="toolbar-btn" title="图形 (G)">
                                <i class="fas fa-shapes"></i>
                                <span>图形</span>
                            </button>
                            <button class="toolbar-btn" title="HU值勾画 (H)">
                                <i class="fas fa-chart-area"></i>
                                <span>HU值勾画</span>
                            </button>
                            <button class="toolbar-btn" title="复制 (Ctrl+C)">
                                <i class="fas fa-copy"></i>
                                <span>复制</span>
                            </button>
                            <button class="toolbar-btn" title="粘贴 (Ctrl+V)">
                                <i class="fas fa-paste"></i>
                                <span>粘贴</span>
                            </button>
                            <button class="toolbar-btn" title="裁切 (X)">
                                <i class="fas fa-cut"></i>
                                <span>裁切</span>
                            </button>
                                </div>
                                
                        <!-- 第二组：轮廓编辑工具 -->
                        <div class="toolbar-section">
                            <button class="toolbar-btn" title="外扩/内缩 (E)">
                                <i class="fas fa-expand-arrows-alt"></i>
                                <span>外扩/内缩</span>
                            </button>
                            <button class="toolbar-btn" title="外扩环带 (R)">
                                <i class="fas fa-circle-notch"></i>
                                <span>外扩环带</span>
                            </button>
                            <button class="toolbar-btn" title="差值勾画 (D)">
                                <i class="fas fa-minus"></i>
                                <span>差值勾画</span>
                            </button>
                            <button class="toolbar-btn" title="组合公式 (F)">
                                <i class="fas fa-calculator"></i>
                                <span>组合公式</span>
                            </button>
                                </div>
                                
                        <!-- 第三组：结构管理工具 -->
                        <div class="toolbar-section">
                            <button class="toolbar-btn" title="设置床结构 (S)">
                                <i class="fas fa-bed"></i>
                                <span>设置床结构</span>
                            </button>
                            <button class="toolbar-btn" title="设置床模版 (T)">
                                <i class="fas fa-clone"></i>
                                <span>设置床模版</span>
                            </button>
                            <button class="toolbar-btn" title="勾画审批 (A)">
                                <i class="fas fa-check-circle"></i>
                                <span>勾画审批</span>
                            </button>
                            <button class="toolbar-btn" title="切割 (C)">
                                <i class="fas fa-cut"></i>
                                <span>切割</span>
                            </button>
                                </div>
                                
                        <!-- 第四组：高级分析工具 -->
                        <div class="toolbar-section">
                            <button class="toolbar-btn" title="RTV勾画 (V)">
                                <i class="fas fa-eye"></i>
                                <span>RTV勾画</span>
                            </button>
                            <button class="toolbar-btn" title="光谱直方图 (I)">
                                <i class="fas fa-chart-bar"></i>
                                <span>光谱直方图</span>
                            </button>
                            <button class="toolbar-btn" title="光谱散点图 (O)">
                                <i class="fas fa-chart-scatter"></i>
                                <span>光谱散点图</span>
                            </button>
                            <button class="toolbar-btn" title="能谱线性分析 (L)">
                                <i class="fas fa-chart-line"></i>
                                <span>能谱线性分析</span>
                            </button>
                            <button class="toolbar-btn" title="SPR勾画 (M)">
                                <i class="fas fa-atom"></i>
                                <span>SPR勾画</span>
                            </button>
                        </div>
                    </div>
                                </div>
                                
                <!-- 图像视图区域 -->
                <div class="image-views">
                    <!-- 轴状面视图 - 左侧大视图 -->
                    <div class="image-panel axial-view">
                        <div class="panel-header">
                            <span class="view-label">2D</span>
                            </div>
                        <div class="image-container" id="targetAxialContainer"></div>
                        <div class="panel-footer">
                            <span class="view-type">2D View</span>
                </div>
                                </div>
                                
                    <!-- 右侧小视图区域 -->
                    <div class="right-views">
                        <!-- 冠状面视图 - 右上角 -->
                        <div class="image-panel coronal-view">
                            <div class="panel-header">
                                <span class="view-label">Coronal</span>
                    </div>
                            <div class="image-container" id="targetCoronalContainer"></div>
                            <div class="panel-footer">
                                <span class="view-type">Coronal</span>
                                    </div>
                                </div>
                                
                        <!-- 矢状面视图 - 右下角 -->
                        <div class="image-panel sagittal-view">
                            <div class="panel-header">
                                <span class="view-label">Sagittal</span>
                                </div>
                            <div class="image-container" id="targetSagittalContainer"></div>
                            <div class="panel-footer">
                                <span class="view-type">Sagittal</span>
                            </div>
                            </div>
                        </div>
                    </div>
                    </div>
                                    </div>
                                </div>
                                
        <!-- 计划设计界面 -->
        <div class="plan-design-content" id="planDesignContent" style="display: none;">
            <!-- 左侧面板（复用图像处理左侧栏样式） -->
            <div class="image-left-panel" id="planLeftPanel">
                <div class="resizer-handle" id="planResizerHandle"></div>
                <div class="patient-info-header">
                    <div class="patient-avatar"><i class="fas fa-user"></i></div>
                    <div class="patient-details">
                        <div class="patient-name">Li Shan (ID:WP4TR3)</div>
                        <div class="patient-info">1976-06-13 F</div>
                                </div>
                    <div class="collapse-toggle" id="planLeftPanelToggle"><i class="fas fa-chevron-left"></i></div>
                            </div>
                <div class="content-area">
                    <div class="vertical-nav-buttons">
                        <button class="nav-btn active" data-panel="sequence"><i class="fas fa-sitemap"></i><span>序列树</span></button>
                        <button class="nav-btn" data-panel="poi"><i class="fas fa-crosshairs"></i><span>POI</span></button>
                        <button class="nav-btn" data-panel="iso"><i class="fas fa-bullseye"></i><span>ISO</span></button>
                        <button class="nav-btn" data-panel="roi"><i class="fas fa-shapes"></i><span>ROI</span></button>
                        <button class="nav-btn" data-panel="registration"><i class="fas fa-link"></i><span>配准</span></button>
                        <button class="nav-btn" data-panel="dose"><i class="fas fa-radiation"></i><span>DOSE</span></button>
                        <button class="nav-btn" data-panel="let"><i class="fas fa-atom"></i><span>LET</span></button>
                        </div>
                    <div class="panel-content">
                        <div class="panel-section active" id="plan-sequence-panel">
                            <div class="sequence-tree-container" id="planSequenceContainer">
                                <div class="loading-indicator"><i class="fas fa-spinner fa-spin"></i><span>加载序列树组件...</span></div>
                    </div>
                    </div>
                        <div class="panel-section" id="plan-poi-panel">
                            <div class="poi-panel-container" id="planPoiContainer">
                                <div class="loading-indicator"><i class="fas fa-spinner fa-spin"></i><span>加载POI组件...</span></div>
                    </div>
                        </div>
                        <div class="panel-section" id="plan-iso-panel">
                            <div class="poi-panel-container" id="planIsoContainer">
                                <div class="loading-indicator"><i class="fas fa-spinner fa-spin"></i><span>加载ISO组件...</span></div>
                    </div>
                        </div>
                        <div class="panel-section" id="plan-roi-panel">
                            <div class="roi-panel-container" id="planRoiContainer">
                                <div class="loading-indicator"><i class="fas fa-spinner fa-spin"></i><span>加载ROI组件...</span></div>
                            </div>
                        </div>
                        <div class="panel-section" id="plan-registration-panel">
                            <div class="registration-container" id="planRegistrationContainer">
                                <div class="loading-indicator"><i class="fas fa-spinner fa-spin"></i><span>加载配准组件...</span></div>
                            </div>
                        </div>
                        <div class="panel-section" id="plan-dose-panel">
                            <div class="registration-container">
                                <div class="loading-indicator"><i class="fas fa-info-circle"></i><span>DOSE 占位内容</span></div>
                            </div>
                        </div>
                        <div class="panel-section" id="plan-let-panel">
                            <div class="registration-container">
                                <div class="loading-indicator"><i class="fas fa-info-circle"></i><span>LET 占位内容</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧内容区域 -->
            <div class="right-content-area">
                <!-- 工具栏（复用样式） -->
                <div class="image-processing-toolbar expanded" id="planDesignToolbar">
                    <div class="toolbar-toggle">
                        <button class="toolbar-toggle-btn" id="planToolbarToggleBtn"><i class="fas fa-chevron-up"></i></button>
                    </div>
                    <div class="toolbar-content">
                        <div class="toolbar-section">
                            <button class="toolbar-btn"><i class="fas fa-copy"></i><span>复制计划</span></button>
                            <button class="toolbar-btn"><i class="fas fa-edit"></i><span>编辑计划</span></button>
                            <button class="toolbar-btn"><i class="fas fa-trash"></i><span>删除计划</span></button>
                            <button class="toolbar-btn"><i class="fas fa-map-marker-alt"></i><span>标记定位点</span></button>
                        </div>
                        <div class="toolbar-section">
                            <button class="toolbar-btn"><i class="fas fa-calculator"></i><span>计算域</span></button>
                            <button class="toolbar-btn"><i class="fas fa-th"></i><span>剂量网格</span></button>
                            <button class="toolbar-btn"><i class="fas fa-bed"></i><span>设置移床值</span></button>
                        </div>
                    </div>
                </div>

                <!-- 中央图像区域：左三视图 + 右侧面板（2D/3D与BEV/DVH） -->
                <div class="plan-image-area">
                    <div class="tri-views" id="planTriViews">
                        <div class="image-panel axial-view">
                            <div class="panel-header"><span class="view-label">Axial</span></div>
                            <div class="image-container" id="planAxialContainer"></div>
                            <div class="panel-footer"><span class="view-type">Axial</span></div>
                    </div>
                        <div class="bottom-views">
                            <div class="image-panel coronal-view">
                                <div class="panel-header"><span class="view-label">Coronal</span></div>
                                <div class="image-container" id="planCoronalContainer"></div>
                                <div class="panel-footer"><span class="view-type">Coronal</span></div>
                            </div>
                            <div class="image-panel sagittal-view">
                                <div class="panel-header"><span class="view-label">Sagittal</span></div>
                                <div class="image-container" id="planSagittalContainer"></div>
                                <div class="panel-footer"><span class="view-type">Sagittal</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="split-resizer" id="planImageResizer"></div>
                    <div class="side-panel" id="planSidePanel">
                        <div class="bev-dvh-section">
                            <div class="tabs" id="planBevDvhTabs">
                                <button class="tab active" data-tab="bev">BEV视图</button>
                                <button class="tab" data-tab="dvh">DVH视图</button>
                            </div>
                            <div class="tab-panels">
                                <div class="tab-panel active" id="planBevPanel">
                                    <div id="planBevViewContainer" style="width: 100%; height: 100%;"></div>
                                </div>
                                <div class="tab-panel" id="planDvhPanel">
                                    <div id="planDvhViewContainer" style="width: 100%; height: 100%;"></div>
                                </div>
                            </div>
                    </div>
                </div>
            </div>

                <!-- 底部面板：射束列表 / 临床目标 / 剂量统计 / 能量层 -->
                <div class="plan-bottom-panel">
                    <div class="bottom-tabs" id="planBottomTabs">
                        <button class="bottom-tab active" data-tab="beamList">射束列表</button>
                        <button class="bottom-tab" data-tab="clinicalTargets">临床目标</button>
                        <button class="bottom-tab" data-tab="doseStats">剂量统计</button>
                        <button class="bottom-tab" data-tab="energyLayers">能量层</button>
                    </div>
                    <div class="bottom-contents">
                        <div class="bottom-content active" id="planBeamList">
                            <div class="beam-table-container" id="beamListContainer"></div>
                        </div>
                        <div class="bottom-content" id="planClinicalTargets">
                            <div class="clinical-targets-content">临床目标（占位）</div>
                        </div>
                        <div class="bottom-content" id="planDoseStats">
                            <div class="dose-stats-container" id="planDoseStatsContainer">
                                <div class="loading-indicator">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <span>加载剂量统计组件...</span>
                                </div>
                            </div>
                        </div>
                        <div class="bottom-content" id="planEnergyLayers">
                            <div class="energy-layers-content">能量层（占位）</div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>

        <!-- 计划优化界面（内嵌实现，避免 iframe 问题） -->
        <div class="plan-design-content" id="planOptimizationContent" style="display: none;">
            <!-- 左侧面板（复用样式） -->
            <div class="image-left-panel" id="optLeftPanel">
                <div class="resizer-handle" id="optResizerHandle"></div>
                <div class="patient-info-header">
                    <div class="patient-avatar"><i class="fas fa-user"></i></div>
                    <div class="patient-details">
                        <div class="patient-name">Zhangguang (ID:Y87342987)</div>
                        <div class="patient-info">1967-10-08 M</div>
                    </div>
                    <div class="collapse-toggle" id="optLeftPanelToggle"><i class="fas fa-chevron-left"></i></div>
                </div>
                <div class="content-area">
                    <div class="vertical-nav-buttons">
                        <button class="nav-btn active" data-panel="opt-sequence"><i class="fas fa-sitemap"></i><span>序列树</span></button>
                        <button class="nav-btn" data-panel="opt-poi"><i class="fas fa-crosshairs"></i><span>POI</span></button>
                        <button class="nav-btn" data-panel="opt-iso"><i class="fas fa-bullseye"></i><span>ISO</span></button>
                        <button class="nav-btn" data-panel="opt-roi"><i class="fas fa-shapes"></i><span>ROI</span></button>
                        <button class="nav-btn" data-panel="opt-registration"><i class="fas fa-link"></i><span>配准</span></button>
                        <button class="nav-btn" data-panel="opt-dose"><i class="fas fa-radiation"></i><span>DOSE</span></button>
                        <button class="nav-btn" data-panel="opt-let"><i class="fas fa-atom"></i><span>LET</span></button>
                    </div>
                    <div class="panel-content">
                        <div class="panel-section active" id="opt-sequence-panel"><div id="optimizationSequenceContainer" class="sequence-tree-container"></div></div>
                        <div class="panel-section" id="opt-poi-panel"><div id="optimizationPoiContainer" class="poi-panel-container"></div></div>
                        <div class="panel-section" id="opt-iso-panel"><div id="optimizationIsoContainer" class="poi-panel-container"></div></div>
                        <div class="panel-section" id="opt-roi-panel"><div id="optimizationRoiContainer" class="roi-panel-container"></div></div>
                        <div class="panel-section" id="opt-registration-panel"><div id="optimizationRegistrationContainer" class="registration-container"></div></div>
                        <div class="panel-section" id="opt-dose-panel"><div id="optimizationDoseContainer" class="dose-panel-container"></div></div>
                        <div class="panel-section" id="opt-let-panel"><div id="optimizationLetContainer" class="let-panel-container"></div></div>
                    </div>
                </div>
            </div>

            <!-- 右侧内容区域 -->
            <div class="right-content-area">
                <!-- 顶部工具栏（复用样式） -->
                <div class="image-processing-toolbar expanded" id="planOptimizationToolbar">
                    <div class="toolbar-toggle">
                        <button class="toolbar-toggle-btn" id="optToolbarToggleBtn">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                    </div>
                    <div class="toolbar-content">
                        <div class="toolbar-section">
                            <button class="toolbar-btn active"><i class="fas fa-play"></i><span>计划优化</span></button>
                            <button class="toolbar-btn"><i class="fas fa-pause"></i><span>暂停优化</span></button>
                            <button class="toolbar-btn"><i class="fas fa-stop"></i><span>取消优化</span></button>
                        </div>
                        <div class="toolbar-section">
                            <button class="toolbar-btn"><i class="fas fa-cog"></i><span>优化设置</span></button>
                            <button class="toolbar-btn" id="btnRobustnessSettings"><i class="fas fa-shield-alt"></i><span>鲁棒性设置</span></button>
                            <button class="toolbar-btn" id="btnLineDoseDistribution"><i class="fas fa-chart-line"></i><span>线剂量分布</span></button>
                            <button class="toolbar-btn"><i class="fas fa-expand-arrows-alt"></i><span>剂量缩放</span></button>
                            <button class="toolbar-btn"><i class="fas fa-calculator"></i><span>剂量计算</span></button>
                        </div>
                    </div>
                </div>

                <!-- 中央区域：左视图tabs + 右侧tabs -->
                <div class="plan-image-area">
                    <div class="tri-views" id="optTriViews" style="flex: 1; display: flex; flex-direction: column;">
                        <div class="view-tabs">
                            <div class="view-tabs-left">
                                <button class="view-tab active" data-view="opt2d">2D视图</button>
                                <button class="view-tab" data-view="opt3d">3D视图</button>
                                <button class="view-tab" data-view="optbev">BEV视图</button>
                            </div>
                            <!-- 外部工具栏已移除，使用组件内部工具栏 -->
                        </div>
                        <div class="image-panel" id="opt2d-view"><div class="image-container" id="opt2d-view-container" style="width: 100%; height: 100%;"></div></div>
                        <div class="image-panel" id="opt3d-view" style="display:none;"><div class="image-container" id="opt3d-view-container" style="width: 100%; height: 100%;"></div></div>
                        <div class="image-panel" id="optbev-view" style="display:none;"><div class="image-container" id="optbev-view-container" style="width: 100%; height: 100%;"></div></div>
                    </div>
                    <div class="right-views" id="optRightViews" style="width: 300px;">
                        <div class="right-view-tabs">
                            <button class="right-view-tab active" data-right-view="bev">BEV</button>
                            <button class="right-view-tab" data-right-view="dvh">DVH</button>
                            <button class="right-view-tab" data-right-view="let">LET</button>
                        </div>
                        <div class="right-view-content" id="opt-right-bev" style="display:block;">BEV视图内容</div>
                        <div class="right-view-content" id="opt-right-dvh" style="display:none;"></div>
                        <div class="right-view-content" id="opt-right-let" style="display:none;">LET视图内容</div>
                    </div>
                </div>

                <!-- 底部面板（复用样式） -->
                <div class="plan-bottom-panel">
                    <div class="bottom-tabs" id="optBottomTabs">
                        <button class="bottom-tab active" data-tab="constraints">优化约束列表</button>
                        <button class="bottom-tab" data-tab="beams">射束列表</button>
                        <button class="bottom-tab" data-tab="targets">临床目标</button>
                        <button class="bottom-tab" data-tab="dose-stats">剂量统计</button>
                        <button class="bottom-tab" data-tab="energy-layer">能量层</button>
                        <button class="bottom-tab" data-tab="beam-settings">射束优化设置</button>
                    </div>
                        <div class="bottom-contents">
                        <div class="bottom-content active" id="opt-constraints"><div id="optimizationConstraintsContainer"></div></div>
                        <div class="bottom-content" id="opt-beams"><div id="optimizationBeamListContainer"></div></div>
                        <div class="bottom-content" id="opt-targets">临床目标占位</div>
                        <div class="bottom-content" id="opt-dose-stats">
                            <div class="dose-stats-container" id="optDoseStatsContainer">
                                <div class="loading-indicator">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <span>加载剂量统计组件...</span>
                                </div>
                            </div>
                        </div>
                        <div class="bottom-content" id="opt-energy-layer"><div id="optimizationEnergyLayerContainer"></div></div>
                        <div class="bottom-content" id="opt-beam-settings"><div id="optimizationBeamSettingsContainer"></div></div>
                </div>
            </div>
            </div>
        </div>
    </main>

    <!-- 右键菜单 -->
    <div class="context-menu" id="contextMenu">
        <div class="menu-item">编辑</div>
        <div class="menu-item">删除</div>
    </div>

    <!-- 导入模态对话框 -->
    <div class="modal-overlay" id="importModal" style="display: none;">
        <div class="modal-dialog import-modal">
            <div class="modal-header">
                <h3 class="modal-title">导入</h3>
                <button class="modal-close" id="importModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- 导入方式标签页 -->
                <div class="import-tabs">
                    <div class="tab-item active" data-tab="local">本地导入</div>
                    <div class="tab-item" data-tab="remote">远程节点导入</div>
                </div>
                
                <!-- 本地导入内容 -->
                <div class="import-content" id="localImportContent">
                    <!-- 文件夹选择区域 -->
                    <div class="folder-selection">
                        <div class="input-group">
                            <label>选择文件夹</label>
                            <div class="folder-input-group">
                                <input type="text" id="importFolderPath" placeholder="选择文件夹" readonly>
                                <button class="btn-folder-select" id="selectFolderBtn">...</button>
                            </div>
                        </div>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="searchSubfolders" checked>
                                <span class="checkmark"></span>
                                检索所有子文件夹中的数据
                            </label>
                        </div>
                    </div>
                    
                    <!-- 患者列表和图像列表 -->
                    <div class="import-panels">
                        <!-- 患者列表 -->
                        <div class="patient-panel">
                            <div class="panel-header">
                                <h4>患者列表</h4>
                            </div>
                            <div class="panel-content">
                                <div class="patient-list" id="patientList">
                                    <!-- 患者列表将通过JavaScript动态生成 -->
                                </div>
                                <div class="select-all-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="selectAllPatients">
                                        <span class="checkmark"></span>
                                        全选
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 图像列表 -->
                        <div class="image-panel">
                            <div class="panel-header">
                                <h4>全部图像列表</h4>
                            </div>
                            <div class="panel-content">
                                <div class="image-tree" id="imageTree">
                                    <!-- 图像树将通过JavaScript动态生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 远程节点导入内容 -->
                <div class="import-content" id="remoteImportContent" style="display: none;">
                    <div class="remote-import-placeholder">
                        <p>远程节点导入功能开发中...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="importCancelBtn">取消</button>
                <button class="btn btn-primary" id="importConfirmBtn">确定</button>
            </div>
        </div>
    </div>

    <!-- 导出配准模态对话框 -->
    <div class="modal-overlay" id="exportModal" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title">导出配准</h3>
                <button class="modal-close" id="exportModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <!-- 导出到 -->
                <div class="form-section">
                    <label class="section-label">导出到</label>
                    <div class="export-destination">
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="exportDestination" value="remote" checked>
                                <span class="radio-label">远程服务器</span>
                            </label>
                            <div class="server-config">
                                <select class="form-select" id="remoteServerSelect">
                                    <option value="server1">远程服务器1</option>
                                    <option value="server2">远程服务器2</option>
                                </select>
                                <button class="config-btn" id="addServerBtn">
                                    <i class="fas fa-cog"></i>
                                    <span>添加-配置地址</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="exportDestination" value="local">
                                <span class="radio-label">本地-共享文件夹</span>
                            </label>
                            <div class="folder-config">
                                <input type="text" class="form-input" id="exportFolderPath" placeholder="选择文件夹路径">
                                <button class="browse-btn" id="browseFolderBtn">...</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 序列描述 -->
                <div class="form-section">
                    <label class="section-label">序列描述</label>
                    <div class="description-config">
                        <input type="text" class="form-input" id="sequenceDescription" placeholder="序列描述" maxlength="128">
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" id="retainImageTime">
                                <span class="checkbox-label">图像时间保留原次序列时间</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- 导出内容 -->
                <div class="form-section">
                    <label class="section-label">导出内容</label>
                    <div class="export-content">
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" id="includePrimary">
                                <span class="checkbox-label">含原主序列</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="includeSecondary">
                                <span class="checkbox-label">含原次序列</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" id="exportCancelBtn">取消</button>
                <button class="btn btn-primary" id="exportConfirmBtn">确定</button>
            </div>
        </div>
    </div>

    <!-- 导出进度模态对话框 -->
    <div class="modal-overlay" id="exportProgressModal" style="display: none;">
        <div class="modal-dialog progress-dialog">
            <div class="modal-header">
                <h3 class="modal-title">导出配准中</h3>
            </div>
            
            <div class="modal-body">
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="exportProgressFill"></div>
                    </div>
                    <div class="progress-text" id="exportProgressText">0%</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 生成图像模态对话框 -->
    <div class="modal-overlay" id="generateImageModal" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title">生成图像</h3>
                <button class="modal-close" id="generateImageModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="generate-description">
                    将配准结果应用于次序列，生成新的图像。
                </div>
                
                <!-- 次序列选择 -->
                <div class="form-section">
                    <label class="section-label">次序列</label>
                    <select class="form-select" id="secondarySequenceSelect">
                        <option value="ct1-2019-09-15">CT1 2019-09-15 19:00:00</option>
                        <option value="ct2-2020-09-15">CT2 2020-09-15 10:00:00</option>
                        <option value="pet-ct-2019-01-14">PET-CT 2019-01-14 14:30:00</option>
                        <option value="4dct-2019-01-14">4DCT 2019-01-14 16:45:00</option>
                    </select>
                </div>
                
                <!-- 序列描述 -->
                <div class="form-section">
                    <label class="section-label">序列描述</label>
                    <input type="text" class="form-input" id="generateSequenceDescription" 
                           placeholder="序列描述" maxlength="128" value="Manteia Registration">
                </div>
                
                <!-- 图像时间选项 -->
                <div class="form-section">
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="retainOriginalTime">
                            <span class="checkbox-label">图像时间保留原次序列时间</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" id="generateImageCancelBtn">取消</button>
                <button class="btn btn-primary" id="generateImageConfirmBtn">确定</button>
            </div>
        </div>
    </div>

    <!-- 生成图像进度模态对话框 -->
    <div class="modal-overlay" id="generateImageProgressModal" style="display: none;">
        <div class="modal-dialog progress-dialog">
            <div class="modal-header">
                <h3 class="modal-title">生成图像中...</h3>
            </div>
            
            <div class="modal-body">
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="generateImageProgressFill"></div>
                    </div>
                    <div class="progress-text" id="generateImageProgressText">0%</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 生成剂量模态对话框 -->
    <div class="modal-overlay" id="generateDoseModal" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title">生成剂量</h3>
                <button class="modal-close" id="generateDoseModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="generate-description">
                    将配准结果应用于次序列关联的剂量，生成新的剂量文件。
                </div>
                
                <!-- 次序列剂量选择 -->
                <div class="form-section">
                    <label class="section-label">次序列剂量</label>
                    <select class="form-select" id="secondaryDoseSelect">
                        <option value="dose1-2019-09-15">Dose1 2019-09-15 19:00:00</option>
                        <option value="dose2-2020-09-15">Dose2 2020-09-15 10:00:00</option>
                        <option value="dose3-2019-01-14">Dose3 2019-01-14 14:30:00</option>
                    </select>
                </div>
                
                <!-- 序列描述 -->
                <div class="form-section">
                    <label class="section-label">序列描述</label>
                    <input type="text" class="form-input" id="generateDoseDescription" 
                           placeholder="序列描述" maxlength="128" value="Deformed Dose">
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" id="generateDoseCancelBtn">取消</button>
                <button class="btn btn-primary" id="generateDoseConfirmBtn">确定</button>
            </div>
        </div>
    </div>

    <!-- 生成剂量进度模态对话框 -->
    <div class="modal-overlay" id="generateDoseProgressModal" style="display: none;">
        <div class="modal-dialog progress-dialog">
            <div class="modal-header">
                <h3 class="modal-title">转换剂量中...</h3>
            </div>
            
            <div class="modal-body">
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="generateDoseProgressFill"></div>
                    </div>
                    <div class="progress-text" id="generateDoseProgressText">0%</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除配准记录确认对话框 -->
    <div class="modal-overlay" id="deleteRegistrationModal" style="display: none;">
        <div class="modal-dialog warning-dialog">
            <div class="modal-header">
                <h3 class="modal-title">警告</h3>
                <button class="modal-close" id="deleteRegistrationModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="warning-content">
                    <div class="warning-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="warning-text">
                        是否删除配准记录？
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" id="deleteRegistrationCancelBtn">取消</button>
                <button class="btn btn-danger" id="deleteRegistrationConfirmBtn">删除</button>
            </div>
        </div>
    </div>

    <!-- 图像属性对话框 -->
    <div class="modal-overlay" id="imagePropertiesModal" style="display: none;">
        <div class="modal-dialog image-properties-dialog">
            <div class="modal-header">
                <h3 class="modal-title">图像属性</h3>
                <button class="modal-close" id="imagePropertiesModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <!-- 扫描设备选择 -->
                <div class="form-section">
                    <label class="section-label">扫描设备</label>
                    <select class="form-select" id="scanDeviceSelect">
                        <option value="ge-ct750">GE Discovery CT750 HD</option>
                        <option value="siemens-somatom">Siemens SOMATOM Definition AS</option>
                        <option value="philips-brilliance">Philips Brilliance CT</option>
                        <option value="toshiba-aquilion">Toshiba Aquilion ONE</option>
                    </select>
                    <div class="form-hint">
                        <i class="fas fa-info-circle"></i>
                        <span>根据DICOM数据中指定字段自动匹配扫描设备</span>
                    </div>
                </div>
                
                <!-- 电子密度对照表 -->
                <div class="form-section">
                    <label class="section-label">电子密度对照表</label>
                    <div class="density-table-container">
                        <table class="density-table">
                            <thead>
                                <tr>
                                    <th>HU值下限</th>
                                    <th>HU值上限</th>
                                    <th>相对电子密度</th>
                                    <th>物质名称</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>-1024</td>
                                    <td>-950</td>
                                    <td>0.000</td>
                                    <td>Air</td>
                                </tr>
                                <tr>
                                    <td>-950</td>
                                    <td>-120</td>
                                    <td>0.200</td>
                                    <td>Lung</td>
                                </tr>
                                <tr>
                                    <td>-120</td>
                                    <td>-80</td>
                                    <td>0.489</td>
                                    <td>Adipose</td>
                                </tr>
                                <tr>
                                    <td>-80</td>
                                    <td>-20</td>
                                    <td>0.949</td>
                                    <td>Breast</td>
                                </tr>
                                <tr>
                                    <td>-20</td>
                                    <td>140</td>
                                    <td>1.000</td>
                                    <td>Water/Soft Tissue</td>
                                </tr>
                                <tr>
                                    <td>140</td>
                                    <td>1600</td>
                                    <td>1.100</td>
                                    <td>Bone</td>
                                </tr>
                                <tr>
                                    <td>1600</td>
                                    <td>3071</td>
                                    <td>1.850</td>
                                    <td>Dense Bone</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" id="imagePropertiesCancelBtn">取消</button>
                <button class="btn btn-primary" id="imagePropertiesConfirmBtn">确定</button>
            </div>
        </div>
    </div>

    <!-- Three.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script src="../shared/scripts/components/SequenceTree.js"></script>
    <script src="../shared/scripts/components/RobustnessSettingsComponent.js"></script>
    <script src="../shared/scripts/components/RegistrationPanel.js"></script>
    <script src="scripts/EnergyLayerViewComponent.js"></script>
    <script src="../shared/scripts/components/BeamOptimizationSettingsComponent.js"></script>
    <script src="../shared/scripts/components/SettingsModalComponent.js"></script>
    <script src="../shared/scripts/components/OptimizationSettingsModalComponent.js"></script>
    <script src="../shared/scripts/components/CuttingModalComponent.js"></script>
    <script src="../shared/scripts/components/DoseStatisticsComponent.js"></script>
    <script src="scripts/View3DComponent.js"></script>
    <script src="../shared/scripts/main.js"></script>
</body>
<div id="robustnessSettingsMount" style="display:none;"></div>
</html>
